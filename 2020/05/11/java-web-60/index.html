<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
    <meta name="description" content="励志成为一位大佬">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    Nacos-1.3.0-BETA特性分享 |
    
    春少 Blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>

<body>
<main class="content">
  <section class="outer">
  <article id="post-java-web-60" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h1 class="article-title" itemprop="name">
      Nacos-1.3.0-BETA特性分享
    </h1>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/05/11/java-web-60/" class="article-date">
  <time datetime="2020-05-11T17:26:24.000Z" itemprop="datePublished">2020-05-11</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/java-web/">java-web</a>
  </div>

                    </div>
                    

                        
                            
    <div class="tocbot"></div>





                                

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h1 id="本次特性的前期视频分享"><a href="#本次特性的前期视频分享" class="headerlink" title="本次特性的前期视频分享"></a>本次特性的前期视频分享</h1><p><a href="https://www.bilibili.com/video/BV1AK4y187XM/" target="_blank" rel="noopener">Nacos 1.3.0-BETA 新特性以及修改点分享</a></p>
<h1 id="Nacos-1-3-0-BETA-特性以及功能使用文档"><a href="#Nacos-1-3-0-BETA-特性以及功能使用文档" class="headerlink" title="Nacos 1.3.0-BETA 特性以及功能使用文档"></a>Nacos 1.3.0-BETA 特性以及功能使用文档</h1><a id="more"></a>
<p><a name="0YIG0"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本次1.3.0-BETA的改动程度很大，涉及两大模块的修改以及新增一个核心模块</p>
<ol>
<li>nacos-core模块修改<ol>
<li>nacos集群节点成员寻址模式的统一管理</li>
<li>nacos内部事件机制</li>
<li>nacos一致性协议层</li>
</ol>
</li>
<li>nacos-config模块修改<ol>
<li>新增内嵌分布式数据存储组件</li>
<li>内嵌存储与外置存储细分</li>
<li>内嵌存储简单运维</li>
</ol>
</li>
<li>nacos-consistency模块新增<ol>
<li>对于AP协议以及CP协议的统一抽象</li>
</ol>
</li>
</ol>
<p><br><br><a name="kxo8O"></a></p>
<h2 id="Nacos的未来整体逻辑架构及其组件"><a href="#Nacos的未来整体逻辑架构及其组件" class="headerlink" title="Nacos的未来整体逻辑架构及其组件"></a>Nacos的未来整体逻辑架构及其组件</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587129046320-5a286f38-8db4-4e76-9b42-8bd859f51a60.png#align=left&amp;display=inline&amp;height=1184&amp;margin=%5Bobject%20Object%5D&amp;name=1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png&amp;originHeight=1184&amp;originWidth=1608&amp;size=279074&amp;status=done&amp;style=none&amp;width=1608" alt="1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png"><br><a name="Hyc6u"></a></p>
<h2 id="Nacos集群成员节点寻址模式"><a href="#Nacos集群成员节点寻址模式" class="headerlink" title="Nacos集群成员节点寻址模式"></a>Nacos集群成员节点寻址模式</h2><p><br>在1.3.0-BETA之前，nacos的naming模块以及config模块存在各自的集群成员节点列表管理任务。为了统一nacos集群下成员列表的寻址模式，将集群节点管理的实现从naming模块以及config模块剥离出来，统一下沉到了core模块的寻址模，同时新增命令行参数-Dnacos.member.list进行设置nacos集群节点列表，该参数可以看作是cluster.conf文件的一个替代。目前nacos的寻址模式类别如下</p>
<ol>
<li>单机模式下：StandaloneMemberLookup</li>
<li>集群模式<ol>
<li>cluster.conf文件存在：FileConfigMemberLookup</li>
<li>cluster.conf文件不存在或者 -Dnacos.member.list没有设置：AddressServerMemberLookup</li>
</ol>
</li>
</ol>
<p>逻辑图如下<br><img src="https://cdn.nlark.com/yuque/__puml/e209a677aa8b5ffce23589e987ee5129.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJMb29rdXBGYWN0b3J5LmluaXQoKVwiXG5cbmlmIFwic3RhbmRhbG9uZSBtb2RlXCIgdGhlblxuICAtLT5bdHJ1ZV0gXCJyZXR1cm4gU3RhbmRhbG9uZU1lbWJlckxvb2t1cFwiXG4gIC0tPiBMb29rdXAucnVuKClcbmVsc2VcbiBpZiBcImNsdXN0ZXIuY29uZiBleGlzdHNcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIEZpbGVDb25maWdNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbHNlXG4gICAgLT5bZmFsc2VdIFwicmV0dXJuIEFkZHJlc3NTZXJ2ZXJNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbmRpZlxuZW5kaWZcblxuLS0-ICgqKVxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6IlplWGtkIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9lMjA5YTY3N2FhOGI1ZmZjZTIzNTg5ZTk4N2VlNTEyOS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt=""></p>
<p><a name="wqkMp"></a></p>
<h3 id="寻址模式详细"><a href="#寻址模式详细" class="headerlink" title="寻址模式详细"></a>寻址模式详细</h3><p>接下来介绍除了单机模式下的寻址模式的其他两种寻址模式<br></p>
<p><a name="egl3H"></a></p>
<h4 id="FileConfigMemberLookup"><a href="#FileConfigMemberLookup" class="headerlink" title="FileConfigMemberLookup"></a>FileConfigMemberLookup</h4><p>该寻址模式是基于cluster.conf文件进行管理的，每个节点会读取各自${nacos.home}/conf下的cluster.conf文件内的成员节点列表，然后组成一个集群。并且在首次读取完${nacos.home}/conf下的cluster.conf文件后，会自动向操作系统的<em><strong>inotify</strong></em>机制注册一个目录监听器，监听${nacos.home}/conf目录下的所有文件变动（注意，这里只会监听文件，对于子目录下的文件变动无法监听）<br>当需要进行集群节点扩缩容时，需要手动去修改每个节点各自${nacos.home}/conf下的cluster.conf的成员节点列表内容。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> FileWatcher watcher = <span class="keyword">new</span> FileWatcher() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(FileChangeEvent event)</span> </span>&#123;</span><br><span class="line">			readClusterConfFromDisk();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">interest</span><span class="params">(String context)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> StringUtils.contains(context, <span class="string">"cluster.conf"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">	readClusterConfFromDisk();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (memberManager.getServerList().isEmpty()) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NacosException(NacosException.SERVER_ERROR,</span><br><span class="line">					<span class="string">"Failed to initialize the member node, is empty"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use the inotify mechanism to monitor file changes and automatically</span></span><br><span class="line">	<span class="comment">// trigger the reading of cluster.conf</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), watcher);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">		Loggers.CLUSTER.error(<span class="string">"An exception occurred in the launch file monitor : &#123;&#125;"</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首次启动时直接读取cluster.conf文件内的节点列表信息，然后向WatchFileCenter注册一个目录监听器，当cluster.conf文件发生变动时自动触发<em><strong>readClusterConfFromDisk()</strong></em>重新读取cluster.conf文件<br><a name="yFTCl"></a></p>
<h4 id="AddressServerMemberLookup"><a href="#AddressServerMemberLookup" class="headerlink" title="AddressServerMemberLookup"></a>AddressServerMemberLookup</h4><p>该寻址模式是基于一个额外的web服务器来管理cluster.conf，每个节点定期向该web服务器请求cluster.conf的文件内容，然后实现集群节点间的寻址，以及扩缩容。<br>当需要进行集群扩缩容时，只需要修改cluster.conf文件即可，然后每个节点向地址服务器请求时会自动的得到最新的cluster.conf文件内容。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServerMemberManager memberManager)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.init(memberManager);</span><br><span class="line">	initAddressSys();</span><br><span class="line">	<span class="keyword">this</span>.maxFailCount = Integer.parseInt(ApplicationUtils.getProperty(<span class="string">"maxHealthCheckFailCount"</span>, <span class="string">"12"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAddressSys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	String envDomainName = System.getenv(<span class="string">"address_server_domain"</span>);</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isBlank(envDomainName)) &#123;</span><br><span class="line">		domainName = System.getProperty(<span class="string">"address.server.domain"</span>, <span class="string">"jmenv.tbsite.net"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		domainName = envDomainName;</span><br><span class="line">	&#125;</span><br><span class="line">	String envAddressPort = System.getenv(<span class="string">"address_server_port"</span>);</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isBlank(envAddressPort)) &#123;</span><br><span class="line">		addressPort = System.getProperty(<span class="string">"address.server.port"</span>, <span class="string">"8080"</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		addressPort = envAddressPort;</span><br><span class="line">	&#125;</span><br><span class="line">	addressUrl = System.getProperty(<span class="string">"address.server.url"</span>, memberManager.getContextPath() + <span class="string">"/"</span> + <span class="string">"serverlist"</span>);</span><br><span class="line">	addressServerUrl = <span class="string">"http://"</span> + domainName + <span class="string">":"</span> + addressPort + addressUrl;</span><br><span class="line">	envIdUrl = <span class="string">"http://"</span> + domainName + <span class="string">":"</span> + addressPort + <span class="string">"/env"</span>;</span><br><span class="line"></span><br><span class="line">	Loggers.CORE.info(<span class="string">"ServerListService address-server port:"</span> + addressPort);</span><br><span class="line">	Loggers.CORE.info(<span class="string">"ADDRESS_SERVER_URL:"</span> + addressServerUrl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"PMD.UndefineMagicConstantRule"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">	<span class="comment">// With the address server, you need to perform a synchronous member node pull at startup</span></span><br><span class="line">	<span class="comment">// Repeat three times, successfully jump out</span></span><br><span class="line">	<span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">	Throwable ex = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> maxRetry = ApplicationUtils.getProperty(<span class="string">"nacos.core.address-server.retry"</span>, Integer.class, <span class="number">5</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxRetry; i ++) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			syncFromAddressUrl();</span><br><span class="line">			success = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">			ex = e;</span><br><span class="line">			Loggers.CLUSTER.error(<span class="string">"[serverlist] exception, error : &#123;&#125;"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!success) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NacosException(NacosException.SERVER_ERROR, ex);;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	task = <span class="keyword">new</span> AddressServerSyncTask();</span><br><span class="line">	GlobalExecutor.scheduleSyncJob(task, <span class="number">5_000L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在初始化时，会主动去向地址服务器同步当前的集群成员列表信息，如果失败则进行重试，其最大重试次数可通过设置<em><strong>nacos.core.address-server.retry</strong></em>来控制，默认是5次，然后成功之后，将创建定时任务去向地址服务器同步集群成员节点信息<br></p>
<p><a name="nOipr"></a></p>
<h3 id="RPC端口协商"><a href="#RPC端口协商" class="headerlink" title="RPC端口协商"></a>RPC端口协商</h3><p>由于将来Nacos会对整体通信通道做升级，采用GRPC优化nacos-server之间，nacos-client与nacos-server之间的通信，同时为了兼容目前已有的HTTP协议接口，那么势必会带来这个问题，本机用于RPC协议的端口如何让其他节点知道？这里有两个解决方案<br><a name="iRLgU"></a></p>
<h4 id="重新设计cluster-conf"><a href="#重新设计cluster-conf" class="headerlink" title="重新设计cluster.conf"></a>重新设计cluster.conf</h4><p><strong><em>之前的cluster.conf格式</em></strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ip[:port]</span></span><br><span class="line"><span class="string">ip[:port]</span></span><br><span class="line"><span class="string">ip[:port]</span></span><br></pre></td></tr></table></figure></p>
<p>由于nacos默认端口是8848，因此在端口未被修改的情况下，可以直接写IP列表</p>
<p><em><strong>新的cluster.conf</strong></em><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ip[:port][:RPC_PORT]</span></span><br><span class="line"><span class="string">ip[:port][:RPC_PORT]</span></span><br><span class="line"><span class="string">ip[:port][:RPC_PORT]</span></span><br></pre></td></tr></table></figure></p>
<p>对于之前的cluster.conf是完全支持的，因为nacos内部可以通过一些计算来约定RPC_PORT的端口值，也可以通过显示的设置来约定。通过计算来约定RPC_PORT的代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// member port</span></span><br><span class="line"><span class="keyword">int</span> port = Member.getPort();</span><br><span class="line"><span class="comment">// Set the default Raft port information for security</span></span><br><span class="line"><span class="keyword">int</span> rpcPort = port - <span class="number">1000</span>;</span><br></pre></td></tr></table></figure></p>
<p>但是这样会有一个问题，即如果用户手动设置了RPC_PORT的话，那么对于客户端、服务端来说，感知新的RPC_PORT就要修改对应的配置文件或者初始化参数。因此希望说能够让用户无感知的过渡到RPC_PORT通信通道，即用户需要对RPC协议使用的端口无需自己在进行设置</p>
<p><a name="GYE6c"></a></p>
<h4 id="端口协商"><a href="#端口协商" class="headerlink" title="端口协商"></a>端口协商</h4><p>端口协商即利用目前已有的HTTP接口，将RPC协议占用的端口通过HTTP接口进行查询返回，这样无论是客户端还是服务端，都无需修改目前已有的初始化参数或者cluster.conf文件，其大致时序图如下<br><img src="https://cdn.nlark.com/yuque/__puml/c2ce2993d33cc3f76d944e0e6eae00e4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiQ2xpZW50LVNES1wiIGFzIFNES1xucGFydGljaXBhbnQgXCJTZXJ2ZXItMVwiIGFzIFMxXG5wYXJ0aWNpcGFudCBcIlNlcnZlci0yXCIgYXMgUzJcblxuYWN0aXZhdGUgUzFcbmFjdGl2YXRlIFMyXG5cblMxIC0-IFMxOiBpbml0XG5TMiAtPiBTMjogaW5pdFxuXG5TMSAtWyNyZWRdPiBTMjogMS4xIHJlcXVlc3QgczIgcG9ydCBpbmZvXG5TMiAtWyMwMDAwRkZdPiBTMTogMS4yIHJldHVybiBbcnBjUG9ydF1cblxuXG5TMiAtWyNyZWRdPiBTMTogMi4xIHJlcXVlc3QgczEgcG9ydCBpbmZvXG5TMSAtWyMwMDAwRkZdPiBTMjogMi4yIHJldHVybiBbcnBjUG9ydF1cblxuZGVhY3RpdmF0ZSBTMVxuZGVhY3RpdmF0ZSBTMlxuXG5hY3RpdmF0ZSBTREtcblxuU0RLIC1bI3JlZF0-IFMxOiByZXF1ZXN0IHBvcnQgaW5mb1xuYWN0aXZhdGUgUzFcblxuXG5TMSAtWyMwMDAwRkZdPiBTREs6IHJldHVybiBbcnBjUG9ydCxycGNQb3J0LHJwY1BvcnRdXG5cbmRlYWN0aXZhdGUgUzFcbmRlYWN0aXZhdGUgU0RLXG5cbkBlbmR1bWwiLCJ0eXBlIjoicHVtbCIsIm1hcmdpbiI6dHJ1ZSwiaWQiOiJIZG9iOSIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX3B1bWwvYzJjZTI5OTNkMzNjYzNmNzZkOTQ0ZTBlNmVhZTAwZTQuc3ZnIiwiY2FyZCI6ImRpYWdyYW0ifQ==" alt="">通过一个额外的端口获取HTTP接口，直接在内部实现RPC端口的协商，并且只会在初始化时进行拉取，这样，将来nacos新增任何一种协议的端口都无需修改相应的配置信息，自动完成协议端口的感知</p>
<p><a name="idHpC"></a></p>
<h2 id="Nacos一致性协议协议层抽象"><a href="#Nacos一致性协议协议层抽象" class="headerlink" title="Nacos一致性协议协议层抽象"></a>Nacos一致性协议协议层抽象</h2><p><br>从nacos的未来的整体架构图可以看出，一致性协议层将是作为nacos的最为核心的模块，将服务于构建在core模块之上的各个功能模块，或者服务与core模块本身。而一致性协议因为分区容错性的存在，需要在可用性与一致性之间做选择，因此就存在两大类一致性：最终一致性和强一致性。在nacos中，这两类一致性协议都是可能用到的，比如naming模块，对于服务实例的数据管理分别用到了AP以及CP，而对于config模块，将会涉及使用CP。同时还有如下几个功能需求点</p>
<ol>
<li>目前持久化服务使用用了变种版本的raft，并且业务和raft协议耦合，因此需要抽离解耦，同时是选择一个标准的Java版Raft实现</li>
<li>对于中小用户，配置基本不超过100个，独立一个mysql，相对重一些，需要一个轻量化的存储方案，并且支持2.0不依赖mysql和3.0依赖mysql可配置能力</li>
<li>由于CP或者AP，其存在多种实现，如何对一致性协议层做一次很好的抽象，以便将来可以快速的实现底层一致性协议具体实现的替换，比如Raft协议，目前nacos的选型是JRaft，不排除将来nacos会自己实现一个标准raft协议或者实现Paxos协议</li>
<li>由于Nacos存在多个独立工作的功能模块，每个功能模块之间不能出现影响，比如A模块处理请求过慢或者出现异常时，不能影响B模块的正常工作，即每个功能模块在使用一致性协议时，如何将每个模块的数据处理进行隔离？</li>
</ol>
<p>根据一致协议以及上述功能需求点，本次做了一个抽象的一致协议层以及相关的接口<br><a name="eVdHC"></a></p>
<h3 id="一致协议接口：ConsistencyProtocol"><a href="#一致协议接口：ConsistencyProtocol" class="headerlink" title="一致协议接口：ConsistencyProtocol"></a>一致协议接口：ConsistencyProtocol</h3><p>所谓一致性，即多个副本之间是否能够保持一致性的特性，而副本的本质就是数据，对数据的操作，不是获取就是修改。同时，一致协议其实是针对分布式情况的，而这必然涉及多个节点，因此，需要有相应的接口能够调整一致性协议的协同工作节点。如果我们要观察一致性协议运行的情况，该怎么办？比如Raft协议，我们希望得知当前集群中的Leader是谁，任期的情况，当前集群中的成员节点有谁？因此，还需要提供一个一致性协议元数据获取。<br>综上所述，ConsistencyProtcol的大致设计可以出来了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Has nothing to do with the specific implementation of the consistency protocol</span></span><br><span class="line"><span class="comment"> * Initialization sequence： init(Config)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;&#123;<span class="doctag">@link</span> Config&#125; : Relevant configuration information required by the consistency protocol,</span></span><br><span class="line"><span class="comment"> *     for example, the Raft protocol needs to set the election timeout time, the location where</span></span><br><span class="line"><span class="comment"> *     the Log is stored, and the snapshot task execution interval&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;&#123;<span class="doctag">@link</span> ConsistencyProtocol#protocolMetaData()&#125; : Returns metadata information of the consistency</span></span><br><span class="line"><span class="comment"> *     protocol, such as leader, term, and other metadata information in the Raft protocol&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href="mailto:liaochuntao@live.com"&gt;liaochuntao&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConsistencyProtocol</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Config</span>&gt; <span class="keyword">extends</span> <span class="title">CommandOperations</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Consistency protocol initialization: perform initialization operations based on the incoming Config</span></span><br><span class="line"><span class="comment">     * 一致性协议初始化，根据 Config 实现类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config &#123;<span class="doctag">@link</span> Config&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(T config)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Copy of metadata information for this consensus protocol</span></span><br><span class="line"><span class="comment">     * 该一致性协议的元数据信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> metaData &#123;<span class="doctag">@link</span> ProtocolMetaData&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ProtocolMetaData <span class="title">protocolMetaData</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Obtain data according to the request</span></span><br><span class="line"><span class="comment">     * 数据获取操作，根据GetRequest中的请求上下文进行查询相应的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> data &#123;<span class="doctag">@link</span> GetRequest&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">GetResponse <span class="title">getData</span><span class="params">(GetRequest request)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Data operation, returning submission results synchronously</span></span><br><span class="line"><span class="comment">     * 同步数据提交，在 Datum 中已携带相应的数据操作信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data &#123;<span class="doctag">@link</span> Log&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> submit operation result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">LogFuture <span class="title">submit</span><span class="params">(Log data)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Data submission operation, returning submission results asynchronously</span></span><br><span class="line"><span class="comment">     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data &#123;<span class="doctag">@link</span> Log&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> CompletableFuture&lt;LogFuture&gt;&#125; submit result</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception when submit throw Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">CompletableFuture&lt;LogFuture&gt; <span class="title">submitAsync</span><span class="params">(Log data)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * New member list</span></span><br><span class="line"><span class="comment">     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addresses [ip:port, ip:port, ...]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">memberChange</span><span class="params">(Set&lt;String&gt; addresses)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Consistency agreement service shut down</span></span><br><span class="line"><span class="comment">     * 一致性协议服务关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而针对CP协议，由于存在Leader的概念，因此需要提供一个方法用于获取CP协议当前的Leader是谁<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CPProtocol</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">Config</span>&gt; <span class="keyword">extends</span> <span class="title">ConsistencyProtocol</span>&lt;<span class="title">C</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns whether this node is a leader node</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> group business module info</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> is leader</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isLeader</span><span class="params">(String group)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a name="m1uQR"></a></p>
<h3 id="数据操作请求提交对象：Log、GetRequest"><a href="#数据操作请求提交对象：Log、GetRequest" class="headerlink" title="数据操作请求提交对象：Log、GetRequest"></a>数据操作请求提交对象：Log、GetRequest</h3><p>上面说到，一致性协议其实是对于数据操作而言的，数据操作基本分为两大类：数据查询以及数据修改，同时还要满足不同功能模块之间的数据进行隔离。因此这里针对数据修改操作以及数据查询操作分别阐述。</p>
<ol>
<li>数据修改<ol>
<li>数据修改操作，一定要知道本次请求是属于哪一个功能模块的</li>
<li>数据修改操作，首先一定要知道这个数据的修改操作具体是哪一种修改操作，方便功能模块针对真正的数据修改操作进行相应的逻辑操作</li>
<li>数据修改操作，一定要知道修改的数据是什么，即请求体，为了使得一致性协议层更为通用，这里对于请求体的数据结构，选择了byte[]数组</li>
<li>数据的类型，由于我们将真正的数据序列化为了byte[]数组，为了能够正常序列化，我们可能还需要记录这个数据的类型是什么</li>
<li>本次请求的信息摘要或者标识信息</li>
<li>本次请求的额外信息，用于将来扩展需要传输的数据</li>
</ol>
</li>
</ol>
<p>综上，可以得出Log对象的设计如下<br><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">message Log &#123;</span><br><span class="line">		// 功能模块分组信息</span><br><span class="line">    string group = 1;</span><br><span class="line">    // 摘要或者标识</span><br><span class="line">    string key = 2;</span><br><span class="line">    // 具体请求数据</span><br><span class="line">    bytes data = 3;</span><br><span class="line">    // 数据类型</span><br><span class="line">    string type = 4;</span><br><span class="line">    // 更为具体的数据操作</span><br><span class="line">    string operation = 5;</span><br><span class="line">    // 额外信息</span><br><span class="line">    map&lt;string, string&gt; extendInfo = 6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>数据查询<ol>
<li>数据查询操作，一定要知道本次请求是由哪一个功能模块发起的</li>
<li>数据查询的条件是什么，为了兼容各种存储结构的数据查询操作，这里用byte[]进行存储</li>
<li>本次请求的额外信息，用于将来扩展需要传输的数据</li>
</ol>
</li>
</ol>
<p>综上，可以得出GetRequest对象的设计如下<br><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message GetRequest &#123;</span><br><span class="line">	  // 功能模块分组信息</span><br><span class="line">    string group = 1;</span><br><span class="line">    // 具体请求数据</span><br><span class="line">    bytes data = 2;</span><br><span class="line">    // 额外信息</span><br><span class="line">    map&lt;string, string&gt; extendInfo = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a name="eaYzS"></a></p>
<h3 id="功能模块使用一致性协议：LogProcessor"><a href="#功能模块使用一致性协议：LogProcessor" class="headerlink" title="功能模块使用一致性协议：LogProcessor"></a>功能模块使用一致性协议：LogProcessor</h3><p>当数据操作通过一致性协议进行submit之后，每个节点需要去处理这个Log或者GetRequest对象，因此，我们需要抽象出一个Log、GetRequest对象的Processor，不同的功能模块通过实现该处理器，ConsistencyProtocol内部会根据Log、GetRequest的group属性，将Log、GetRequest对象路由到具体的Processor，当然，Processor也需要表明自己是属于哪一个功能模块的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LogProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get data by key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request request &#123;<span class="doctag">@link</span> GetRequest&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> target type data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> GetResponse <span class="title">getData</span><span class="params">(GetRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Process Submitted Log</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> log &#123;<span class="doctag">@link</span> Log&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> boolean&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> LogFuture <span class="title">onApply</span><span class="params">(Log log)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Irremediable errors that need to trigger business price cuts</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> error &#123;<span class="doctag">@link</span> Throwable&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable error)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * In order for the state machine that handles the transaction to be able to route</span></span><br><span class="line"><span class="comment">     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity</span></span><br><span class="line"><span class="comment">     * information</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Business unique identification name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">group</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>针对CP协议，比如Raft协议，存在快照的设计，因此我们需要针对CP协议单独扩展出一个方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LogProcessor4CP</span> <span class="keyword">extends</span> <span class="title">LogProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Discovery snapshot handler</span></span><br><span class="line"><span class="comment">     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> List &lt;SnapshotOperate&gt;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;SnapshotOperation&gt; <span class="title">loadSnapshotOperate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以通过一个时序图看看，一致性协议层的大致工作流程<br><img src="https://cdn.nlark.com/yuque/__puml/30b7e270e7aef8bb63136aaffbe5bfbf.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiTWVtYmVyTWFuYWdlclwiIGFzIE5hY29zQ2x1c3RlclxucGFydGljaXBhbnQgXCJCdXNpbmVzc01vZHVsZVwiIGFzIEJpelxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiQ0FQQmFja2VuZFwiIGFzIEJhY2tlbmRcbnBhcnRpY2lwYW50IFwiQ29uZmlnXCIgYXMgQ29uZmlnXG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJMb2dcIiBhcyBMb2dcblxuYWN0aXZhdGUgTmFjb3NDbHVzdGVyXG5OYWNvc0NsdXN0ZXIgLT4gTmFjb3NDbHVzdGVyOiBpbml0KCkg5Yid5aeL5YyWTmFjb3Ppm4bnvqRcblxuTmFjb3NDbHVzdGVyIC0-IENvbmZpZzog6I635Y-WQ29uZmln5a-56LGhXG5hY3RpdmF0ZSBDb25maWdcbkNvbmZpZyAtPiBDb25maWc6IOaUtumbhkxvZ1Byb2Nlc3NvcueahOS_oeaBr1xuQ29uZmlnIC0-IE5hY29zQ2x1c3RlclxuZGVhY3RpdmF0ZSBDb25maWdcblxuXG5OYWNvc0NsdXN0ZXIgLT4gUHJvdG9jb2w6IOiOt-WPluaJgOaciUNvbnNpc3RlbmN5UHJvdG9jb2zlrp7njrBcbmFjdGl2YXRlIFByb3RvY29sXG5cbk5hY29zQ2x1c3RlciAtPiBQcm90b2NvbDogaW5pdChDb25maWcpIOaWueazleaJp-ihjFxuXG5kZWFjdGl2YXRlIFByb3RvY29sXG5kZWFjdGl2YXRlIE5hY29zQ2x1c3RlclxuXG5cbkJpeiAtPiBMb2c6IOWIm-W7uuS4gOS4quS6i-WKoeWvueixoVxuYWN0aXZhdGUgQml6XG5hY3RpdmF0ZSBMb2dcblxuXG5Mb2cgLT4gTG9nOiDorr7nva5kYXRhXG5Mb2cgLT4gTG9nOiDorr7nva5rZXlcbkxvZyAtPiBMb2c6IOiuvue9rmNsYXNzTmFtZVxuTG9nIC0-IExvZzog6K6-572uZXh0ZW5kSW5mb1xuTG9nIC0-IEJpelxuZGVhY3RpdmF0ZSBMb2dcblxuQml6IC0-IFByb3RvY29sOiBzdWJtaXQoTG9nKSDosIPnlKjkuIDoh7TmgKfljY_orq7ov5vooYzkuovliqHmj5DkuqRcbmFjdGl2YXRlIFByb3RvY29sXG5cblByb3RvY29sIC0-IEJhY2tlbmQ6IOWGhemDqOS4gOiHtOaAp-WNj-iuruW3peS9nFxuYWN0aXZhdGUgQmFja2VuZFxuXG5CYWNrZW5kIC0-IFByb3RvY29sOiDov5Tlm57lt6XkvZzlpITnkIbnu5PmnpxcbmRlYWN0aXZhdGUgQmFja2VuZFxuXG5Qcm90b2NvbCAtPiBQcm9jZXNzb3I6IOWwhkxvZ-WIhuWPkeWIsOWvueW6lOeahFByb2Nlc3Nvcu-8jOiwg-eUqCBvbkFwcGx5IOaWueazlVxuYWN0aXZhdGUgUHJvdG9jb2xcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuUHJvY2Vzc29yIC0-IEJpejog5LqL5Yqh5o-Q5Lqk57uT5p6cXG5cbmRlYWN0aXZhdGUgUHJvY2Vzc29yXG5kZWFjdGl2YXRlIEJpelxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiNFZpMkwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzMwYjdlMjcwZTdhZWY4YmI2MzEzNmFhZmZiZTViZmJmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" alt=""><a name="xtBNU"></a></p>
<h3 id="Nacos一致性协议层之CP协议的实现选择——JRaft"><a href="#Nacos一致性协议层之CP协议的实现选择——JRaft" class="headerlink" title="Nacos一致性协议层之CP协议的实现选择——JRaft"></a>Nacos一致性协议层之CP协议的实现选择——JRaft</h3><p>一致性协议层抽象好之后，剩下就是具体一致性协议实现的选择了，这里我们选择了蚂蚁金服开源的JRaft，那么我们如何将JRaft作为CP协议的一个Backend呢？下面的简单流程图描述了当JRaft作为CP协议的一个Backend时的初始化流程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A concrete implementation of CP protocol: JRaft</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *                                           ┌──────────────────────┐               </span></span><br><span class="line"><span class="comment"> *                                           │                      │               </span></span><br><span class="line"><span class="comment"> *            ┌──────────────────────┐       │                      ▼               </span></span><br><span class="line"><span class="comment"> *            │   ProtocolManager    │       │        ┌───────────────────────────┐ </span></span><br><span class="line"><span class="comment"> *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │ </span></span><br><span class="line"><span class="comment"> *                        │                  │        └───────────────────────────┘ </span></span><br><span class="line"><span class="comment"> *                        ▼                  │                      │               </span></span><br><span class="line"><span class="comment"> *      ┌──────────────────────────────────┐ │                      ▼               </span></span><br><span class="line"><span class="comment"> *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐      </span></span><br><span class="line"><span class="comment"> *      └──────────────────────────────────┘ │             │  get p.group()  │      </span></span><br><span class="line"><span class="comment"> *                        │                  │             └─────────────────┘      </span></span><br><span class="line"><span class="comment"> *                        ▼                  │                      │               </span></span><br><span class="line"><span class="comment"> *                 ┌─────────────┐           │                      │               </span></span><br><span class="line"><span class="comment"> *                 │ RaftConfig  │           │                      ▼               </span></span><br><span class="line"><span class="comment"> *                 └─────────────┘           │      ┌──────────────────────────────┐</span></span><br><span class="line"><span class="comment"> *                        │                  │      │  create raft group service   │</span></span><br><span class="line"><span class="comment"> *                        ▼                  │      └──────────────────────────────┘</span></span><br><span class="line"><span class="comment"> *              ┌──────────────────┐         │                                      </span></span><br><span class="line"><span class="comment"> *              │  JRaftProtocol   │         │                                      </span></span><br><span class="line"><span class="comment"> *              └──────────────────┘         │                                      </span></span><br><span class="line"><span class="comment"> *                        │                  │                                      </span></span><br><span class="line"><span class="comment"> *                     init()                │                                      </span></span><br><span class="line"><span class="comment"> *                        │                  │                                      </span></span><br><span class="line"><span class="comment"> *                        ▼                  │                                      </span></span><br><span class="line"><span class="comment"> *               ┌─────────────────┐         │                                      </span></span><br><span class="line"><span class="comment"> *               │   JRaftServer   │         │                                      </span></span><br><span class="line"><span class="comment"> *               └─────────────────┘         │                                      </span></span><br><span class="line"><span class="comment"> *                        │                  │                                      </span></span><br><span class="line"><span class="comment"> *                        │                  │                                      </span></span><br><span class="line"><span class="comment"> *                        ▼                  │                                      </span></span><br><span class="line"><span class="comment"> *             ┌────────────────────┐        │                                      </span></span><br><span class="line"><span class="comment"> *             │JRaftServer.start() │        │                                      </span></span><br><span class="line"><span class="comment"> *             └────────────────────┘        │                                      </span></span><br><span class="line"><span class="comment"> *                        │                  │                                      </span></span><br><span class="line"><span class="comment"> *                        └──────────────────┘                                      </span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href="mailto:liaochuntao@live.com"&gt;liaochuntao&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<p>JRaftProtocol是当JRaft作为CP协议的Backend时的一个ConsistencyProtocol的具体实现，其内部有一个JRaftServer成员属性，JRaftServer分装了JRaft的各种API操作，比如数据操作的提交，数据的查询，成员节点的变更，Leader节点的查询等等。</p>
<p><em><strong>注意事项：JRaft运行期间产生的数据在${nacos.home}/data/protocol/raft文件目录下。不同的业务模块有不同的文件分组，如果当节点出现crash或者异常关闭时，清空该目录下的文件，重启节点即可</strong></em></p>
<p>由于JRaft实现了raft group的概念，因此，完全可以利用raft group的设计，为每个功能模块单独创建一个raft group。这里给出部分代码，该代码体现了如何将LogProcessor嵌入到状态机中并为每个LogPrcessor创建一个Raft Group<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">createMultiRaftGroup</span><span class="params">(Collection&lt;LogProcessor4CP&gt; processors)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// There is no reason why the LogProcessor cannot be processed because of the synchronization</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.isStarted) &#123;</span><br><span class="line">		<span class="keyword">this</span>.processors.addAll(processors);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> String parentPath = Paths.get(ApplicationUtils.getNacosHome(), <span class="string">"protocol/raft"</span>).toString();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (LogProcessor4CP processor : processors) &#123;</span><br><span class="line">		<span class="keyword">final</span> String groupName = processor.group();</span><br><span class="line">		<span class="keyword">if</span> (alreadyRegisterBiz.contains(groupName)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> DuplicateRaftGroupException(groupName);</span><br><span class="line">		&#125;</span><br><span class="line">		alreadyRegisterBiz.add(groupName);</span><br><span class="line">		<span class="keyword">final</span> String logUri = Paths.get(parentPath, groupName, <span class="string">"log"</span>).toString();</span><br><span class="line">		<span class="keyword">final</span> String snapshotUri = Paths.get(parentPath, groupName, <span class="string">"snapshot"</span>)</span><br><span class="line">					.toString();</span><br><span class="line">		<span class="keyword">final</span> String metaDataUri = Paths.get(parentPath, groupName, <span class="string">"meta-data"</span>)</span><br><span class="line">					.toString();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Initialize the raft file storage path for different services</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			DiskUtils.forceMkdir(<span class="keyword">new</span> File(logUri));</span><br><span class="line">			DiskUtils.forceMkdir(<span class="keyword">new</span> File(snapshotUri));</span><br><span class="line">			DiskUtils.forceMkdir(<span class="keyword">new</span> File(metaDataUri));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			Loggers.RAFT.error(<span class="string">"Init Raft-File dir have some error : &#123;&#125;"</span>, e);</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ensure that each Raft Group has its own configuration and NodeOptions</span></span><br><span class="line">		Configuration configuration = conf.copy();</span><br><span class="line">		NodeOptions copy = nodeOptions.copy();</span><br><span class="line">		<span class="comment">// Here, the LogProcessor is passed into StateMachine, and when the StateMachine </span></span><br><span class="line">		<span class="comment">// triggers onApply, the onApply of the LogProcessor is actually called</span></span><br><span class="line">		NacosStateMachine machine = <span class="keyword">new</span> NacosStateMachine(<span class="keyword">this</span>, processor);</span><br><span class="line"></span><br><span class="line">		copy.setLogUri(logUri);</span><br><span class="line">		copy.setRaftMetaUri(metaDataUri);</span><br><span class="line">		copy.setSnapshotUri(snapshotUri);</span><br><span class="line">		copy.setFsm(machine);</span><br><span class="line">		copy.setInitialConf(configuration);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set snapshot interval, default 1800 seconds</span></span><br><span class="line">		<span class="keyword">int</span> doSnapshotInterval = ConvertUtils.toInt(raftConfig.getVal(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),</span><br><span class="line">					RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If the business module does not implement a snapshot processor, cancel the snapshot</span></span><br><span class="line">		doSnapshotInterval = CollectionUtils.isEmpty(processor.loadSnapshotOperate()) ? <span class="number">0</span> : doSnapshotInterval;</span><br><span class="line"></span><br><span class="line">		copy.setSnapshotIntervalSecs(doSnapshotInterval);</span><br><span class="line">		Loggers.RAFT.info(<span class="string">"create raft group : &#123;&#125;"</span>, groupName);</span><br><span class="line">		RaftGroupService raftGroupService = <span class="keyword">new</span> RaftGroupService(groupName, localPeerId, copy, rpcServer, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Because RpcServer has been started before, it is not allowed to start again here</span></span><br><span class="line">		Node node = raftGroupService.start(<span class="keyword">false</span>);</span><br><span class="line">		machine.setNode(node);</span><br><span class="line">		RouteTable.getInstance().updateConfiguration(groupName, configuration);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Turn on the leader auto refresh for this group</span></span><br><span class="line">		Random random = <span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">long</span> period = nodeOptions.getElectionTimeoutMs() + random.nextInt(<span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">		RaftExecutor.scheduleRaftMemberRefreshJob(() -&gt; refreshRouteTable(groupName), period, period, TimeUnit.MILLISECONDS);</span><br><span class="line">		<span class="comment">// Save the node instance corresponding to the current group</span></span><br><span class="line">		multiRaftGroup.put(groupName, <span class="keyword">new</span> RaftGroupTuple(node, processor, raftGroupService));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>或许有的人会有疑问，为什么要创建多个raft group，既然之前已经设计出了LogProcessor，完全可以利用一个Raft Group，在状态机appl时，根据Log的group属性进行路由到不同的LogProcessor即可，每个功能模块就创建一个raft group，不是会消耗大量的资源吗？<br>正如之前所说，我们希望独立工作的模块之间相互不存在影响，比如A模块处理Log因为存在Block操作可能使得apply的速度缓慢，亦或者可能中途发生异常，对于Raft协议来说，当日志apply失败时，状态机将不能够继续向前推进，因为如果继续向前推进的话，由于上一步的apply失败，后面的所有apply都可能失败，将会导致这个节点的数据与其他节点的数据永远不一致。如果说我们将所有独立工作的模块，对于数据操作的请求处理放在同一个raft group，即一个状态机中，就不可避免的会出现上述所说的问题，某个模块在apply日志发生不可控的因素时，会影响其他模块的正常工作。<br><a name="2GyRw"></a></p>
<h3 id="JRaft运维操作"><a href="#JRaft运维操作" class="headerlink" title="JRaft运维操作"></a>JRaft运维操作</h3><p>为了使用者能够对JRaft进行相关简单的运维，比如Leader的切换，重置当前Raft集群成员，触发某个节点进行Snapshot操作等等，提供了一个简单的HTTP接口进行操作，并且该接口有一定的限制，即每次只会执行一条运维指令</p>
<ol>
<li><p>切换某一个Raft Group的Leader节点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /nacos/v1/core/ops/raft</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"groupId"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">    <span class="string">"transferLeader"</span>: <span class="string">"ip:&#123;raft_port&#125;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重置某一个Raft Group的集群成员</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /nacos/v1/core/ops/raft</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"groupId"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">    <span class="string">"resetRaftCluster"</span>: <span class="string">"ip:&#123;raft_port&#125;,ip:&#123;raft_port&#125;,ip:&#123;raft_port&#125;,ip:&#123;raft_port&#125;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>触发某一个Raft Group执行快照操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /nacos/v1/core/ops/raft</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"groupId"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">    <span class="string">"doSnapshot"</span>: <span class="string">"ip:&#123;raft_port&#125;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a name="GzMuP"></a></p>
<h3 id="JRaft协议相关配置参数"><a href="#JRaft协议相关配置参数" class="headerlink" title="JRaft协议相关配置参数"></a>JRaft协议相关配置参数</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Sets the Raft cluster election timeout, default value is 5 second</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.election_timeout_ms=5000</span></span><br><span class="line"><span class="comment">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.snapshot_interval_secs=30</span></span><br><span class="line"><span class="comment">### Requested retries, default value is 1</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.request_failoverRetries=1</span></span><br><span class="line"><span class="comment">### raft internal worker threads</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.core_thread_num=8</span></span><br><span class="line"><span class="comment">### Number of threads required for raft business request processing</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.cli_service_thread_num=4</span></span><br><span class="line"><span class="comment">### raft linear read strategy, defaults to index</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span></span><br><span class="line"><span class="comment">### rpc request timeout, default 5 seconds</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span></span><br><span class="line"><span class="comment">### Maximum size of each file RPC (snapshot copy) request between members, default is 128 K</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.max_byte_count_per_rpc=131072</span></span><br><span class="line"><span class="comment">### Maximum number of logs sent from leader to follower, default is 1024</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.max_entries_size=1024</span></span><br><span class="line"><span class="comment">### Maximum body size for sending logs from leader to follower, default is 512K</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.max_body_size=524288</span></span><br><span class="line"><span class="comment">### Maximum log storage buffer size, default 256K</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.max_append_buffer_size=262144</span></span><br><span class="line"><span class="comment">### Election timer interval will be a random maximum outside the specified time, default is 1 second</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.max_election_delay_ms=1000</span></span><br><span class="line"><span class="comment">### Specify the ratio between election timeout and heartbeat interval. Heartbeat interval is equal to</span></span><br><span class="line"><span class="comment">### electionTimeoutMs/electionHeartbeatFactor，One tenth by default.</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.election_heartbeat_factor=10</span></span><br><span class="line"><span class="comment">### The tasks submitted to the leader accumulate the maximum batch size of a batch flush log storage. The default is 32 tasks.</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.apply_batch=32</span></span><br><span class="line"><span class="comment">### Call fsync when necessary when writing logs and meta information, usually should be true</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.sync=true</span></span><br><span class="line"><span class="comment">### Whether to write snapshot / raft meta-information to call fsync. The default is false. When sync is true, it is preferred to respect sync.</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.sync_meta=false</span></span><br><span class="line"><span class="comment">### Internal disruptor buffer size. For applications with high write throughput, you need to increase this value. The default value is 16384.</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.disruptor_buffer_size=16384</span></span><br><span class="line"><span class="comment">### Whether to enable replication of pipeline request optimization, which is enabled by default</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.replicator_pipeline=true</span></span><br><span class="line"><span class="comment">### Maximum number of in-flight requests with pipeline requests enabled, default is 256</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.max_replicator_inflight_msgs=256</span></span><br><span class="line"><span class="comment">### Whether to enable LogEntry checksum</span></span><br><span class="line"><span class="string">nacos.core.protocol.raft.data.enable_log_entry_checksum=false</span></span><br></pre></td></tr></table></figure>
<p><a name="WiLDa"></a></p>
<h2 id="Nacos内嵌分布式ID"><a href="#Nacos内嵌分布式ID" class="headerlink" title="Nacos内嵌分布式ID"></a>Nacos内嵌分布式ID</h2><p>nacos内嵌的分布式ID为Snakeflower，dataCenterId默认为1，workerId的值计算方式如下<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">InetAddress</span> <span class="string">address;</span></span><br><span class="line"><span class="string">try</span> <span class="string">&#123;</span></span><br><span class="line">	<span class="string">address</span> <span class="string">=</span> <span class="string">InetAddress.getLocalHost();</span></span><br><span class="line"><span class="string">&#125;</span> <span class="string">catch</span> <span class="string">(final</span> <span class="string">UnknownHostException</span> <span class="string">e)</span> <span class="string">&#123;</span></span><br><span class="line">	<span class="string">throw</span> <span class="string">new</span> <span class="string">IllegalStateException(</span></span><br><span class="line">						<span class="string">"Cannot get LocalHost InetAddress, please check your network!"</span><span class="string">);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">byte[]</span> <span class="string">ipAddressByteArray</span> <span class="string">=</span> <span class="string">address.getAddress();</span></span><br><span class="line"><span class="string">workerId</span> <span class="string">=</span> <span class="string">(((ipAddressByteArray[ipAddressByteArray.length</span> <span class="bullet">-</span> <span class="number">2</span><span class="string">]</span> <span class="string">&amp;</span> <span class="number">0</span><span class="string">B11)</span></span><br><span class="line">					<span class="string">&lt;&lt;</span> <span class="string">Byte.SIZE)</span> <span class="string">+</span> <span class="string">(ipAddressByteArray[ipAddressByteArray.length</span> <span class="bullet">-</span> <span class="number">1</span><span class="string">]</span></span><br><span class="line">					<span class="string">&amp;</span> <span class="number">0xFF</span><span class="string">));</span></span><br></pre></td></tr></table></figure></p>
<p>如果需要手动指定dataCenterId以及workerId，则在application.properties或者启动时添加命令行参数<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### set the dataCenterID manually</span></span><br><span class="line"><span class="comment"># nacos.core.snowflake.data-center=</span></span><br><span class="line"><span class="comment">### set the WorkerID manually</span></span><br><span class="line"><span class="comment"># nacos.core.snowflake.worker-id=</span></span><br></pre></td></tr></table></figure></p>
<p><a name="ZLp5w"></a></p>
<h2 id="Nacos内嵌的轻量的基于Derby的分布式关系型存储"><a href="#Nacos内嵌的轻量的基于Derby的分布式关系型存储" class="headerlink" title="Nacos内嵌的轻量的基于Derby的分布式关系型存储"></a>Nacos内嵌的轻量的基于Derby的分布式关系型存储</h2><p><a name="1B5KV"></a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ol>
<li>如果配置文件数量较少，在集群模式下需要高可用数据库集群作为支撑的成本太大，期望有一个轻量的分布式关系型存储来解决</li>
<li>nacos内部一些元数据信息存储，比如用户信息，命名空间信息</li>
<li>思路来源：<a href="https://github.com/rqlite/rqlite" target="_blank" rel="noopener">https://github.com/rqlite/rqlite</a><br><a name="Du2qc"></a><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><a name="LqUtU"></a><h4 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h4>将一次请求操作涉及的SQL上下文按顺序保存起来。然后通过一致协议层将本次请求涉及的SQL上下文进行同步，然后每个节点将其解析并重新按顺序在一次数据库会话中执行。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587204104465-2270480a-de25-4c84-a11b-6edd2de99e66.png#align=left&amp;display=inline&amp;height=814&amp;margin=%5Bobject%20Object%5D&amp;name=%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.png&amp;originHeight=814&amp;originWidth=1149&amp;size=130886&amp;status=done&amp;style=none&amp;width=1149" alt="未命名文件 (1).png"><br><a name="yxFYn"></a><h4 id="谁可以处理请求"><a href="#谁可以处理请求" class="headerlink" title="谁可以处理请求"></a>谁可以处理请求</h4>当使用者开启1.3.0-BETA的新特性——内嵌分布式关系型数据存储时，所有的写操作请求都将路由到Leader节点进行处理；但是，由于Raft状态机的特性，当某一个节点在apply数据库操作请求时发生非SQL逻辑错误引发的异常时，将导致状态机无法继续正常进行工作，此时将会触发配置管理模块的降级操作<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerSubscribe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	NotifyCenter.registerSubscribe(<span class="keyword">new</span> SmartSubscribe() &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (event <span class="keyword">instanceof</span> RaftDBErrorRecoverEvent) &#123;</span><br><span class="line">				downgrading = <span class="keyword">false</span>;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (event <span class="keyword">instanceof</span> RaftDBErrorEvent) &#123;</span><br><span class="line">				downgrading = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canNotify</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> (event <span class="keyword">instanceof</span> RaftDBErrorEvent) || (event <span class="keyword">instanceof</span> RaftDBErrorRecoverEvent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>因此，综上所述，可以通过活动图来理解下，什么情况下需要将请求进行转发<br><img src="https://cdn.nlark.com/yuque/__puml/db53c1ade61235d4c9659607b98ef7c6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJGaWx0ZXIuZG9GaWx0ZXJcIlxuXG5pZiBcIuacrOiKgueCueaYr0xlYWRlclwiIHRoZW5cbiAgLWxlZnQtPlt0cnVlXSBcIuacrOiKgueCueWkhOeQhlwiXG4gIC0tPiAoKilcbmVsc2VcbiAgICBpZiBcIuezu-e7n-mZjee6p-W8gOWQr1wiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwi6L2s5Y-R57uZTGVhZGVyXCJcbiAgICAgICAgLS0-ICgqKVxuICAgIGVsc2VcbiAgICAgICAgaWYgXCLlhpnmk43kvZzor7fmsYJcIiB0aGVuXG4gICAgICAgICAgICAtLT5bdHJ1ZV0gXCLovazlj5Hnu5lMZWFkZXJcIlxuICAgICAgICAgICAgLS0-ICgqKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICAtLT5bZmFsc2VdIFwi5pys6IqC54K55aSE55CGXCJcbiAgICAgICAgZW5kaWZcbiAgICBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IjFuWW9HIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9kYjUzYzFhZGU2MTIzNWQ0Yzk2NTk2MDdiOThlZjdjNi5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt=""><a name="g1buf"></a></p>
<h4 id="相关数据承载对象"><a href="#相关数据承载对象" class="headerlink" title="相关数据承载对象"></a>相关数据承载对象</h4><p>数据库的DML语句是select、insert、update、delete，根据SQL语句对于数据操作的性质，可以分为两大类：query以及update，select语句对应的是数据查询，insert、update、delete语句对应的是数据修改。同时在进行数据库操作时，为了避免SQL注入，使用的是PreparedStatement，因此需要SQL语句+参数，因此可以得到两个关于数据库操作的Request对象</p>
<ol>
<li><p>SelectRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectRequest</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2212052574976898602L</span>;</span><br><span class="line">    <span class="comment">// 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> queryType;</span><br><span class="line">    <span class="comment">// sql语句</span></span><br><span class="line">    <span class="comment">// select * from config_info where</span></span><br><span class="line">    <span class="keyword">private</span> String sql;</span><br><span class="line">    <span class="keyword">private</span> Object[] args;</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ModifyRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModifyRequest</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4548851816596520564L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> executeNo;</span><br><span class="line">    <span class="keyword">private</span> String sql;</span><br><span class="line">    <span class="keyword">private</span> Object[] args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a name="moKl7"></a></p>
<h4 id="配置发布"><a href="#配置发布" class="headerlink" title="配置发布"></a>配置发布</h4><p>配置发布操作涉及三个事务：</p>
<ol>
<li>config_info保存配置信息</li>
<li>config_tags_relation保存配置与标签的关联关系</li>
<li>his_config_info保存一条配置操作历史记录</li>
</ol>
<p>这三个事务都在配置发布这个大事务下，如果说我们对每个事务操作进行一个Raft协议提交，假设1、2两个事务通过Raft提交后都成功Apply了，第三个事务在进行Raft提交后apply失败，那么对于这个配置发布的大事务来说，是需要整体回滚的，否则就会违反原子性，那么可能需要说将事务回滚操作又进行一次Raft提交，那么整体的复杂程度上升，并且直接引入了分布式事务的管理，因此为了避免这个问题，我们将这三个事务涉及的SQL上下文进行整合成一个大的SQL上下文，对这大的SQL上下文进行Raft协议提交。保证了三个子事务在同一次数据库会话当中，成功解决原子性的问题，同时由于Raft协议对于事务日志的处理是串行执行的，因此相当于将数据库的事务隔离级别调整为串行化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConfigInfo</span><span class="params">(<span class="keyword">final</span> String srcIp, <span class="keyword">final</span> String srcUser,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">final</span> ConfigInfo configInfo, <span class="keyword">final</span> Timestamp time,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">final</span> Map&lt;String, Object&gt; configAdvanceInfo, <span class="keyword">final</span> <span class="keyword">boolean</span> notify)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 同过雪花ID获取一个ID值</span></span><br><span class="line">		<span class="keyword">long</span> configId = idGeneratorManager.nextId(configInfoId);</span><br><span class="line">		<span class="keyword">long</span> configHistoryId = idGeneratorManager.nextId(<span class="keyword">this</span>.configHistoryId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置插入</span></span><br><span class="line">		addConfigInfoAtomic(configId, srcIp, srcUser, configInfo, time, configAdvanceInfo);</span><br><span class="line">		String configTags = configAdvanceInfo == <span class="keyword">null</span> ? <span class="keyword">null</span> : (String) configAdvanceInfo.get(<span class="string">"config_tags"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置与标签信息关联操作</span></span><br><span class="line">		addConfigTagsRelation(configId, configTags, configInfo.getDataId(), configInfo.getGroup(), configInfo.getTenant());</span><br><span class="line">		<span class="comment">// 配置历史插入</span></span><br><span class="line">        insertConfigHistoryAtomic(configHistoryId, configInfo, srcIp, srcUser, time, <span class="string">"I"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">boolean</span> result = databaseOperate.smartUpdate();</span><br><span class="line">		<span class="keyword">if</span> (!result) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NacosConfigException(<span class="string">"Config add failed"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (notify) &#123;</span><br><span class="line">			EventDispatcher.fireEvent(</span><br><span class="line">						<span class="keyword">new</span> ConfigDataChangeEvent(<span class="keyword">false</span>, configInfo.getDataId(),</span><br><span class="line">								configInfo.getGroup(), configInfo.getTenant(),</span><br><span class="line">								time.getTime()));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		SqlContextUtils.cleanCurrentSqlContext();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">addConfigInfoAtomic</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> id, <span class="keyword">final</span> String srcIp,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">final</span> String srcUser, <span class="keyword">final</span> ConfigInfo configInfo, <span class="keyword">final</span> Timestamp time,</span></span></span><br><span class="line"><span class="function"><span class="params">			Map&lt;String, Object&gt; configAdvanceInfo)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 参数处理</span></span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">final</span> String sql =</span><br><span class="line">				<span class="string">"INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,"</span></span><br><span class="line">						+ <span class="string">"gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"</span>;</span><br><span class="line">	<span class="keyword">final</span> Object[] args = <span class="keyword">new</span> Object[] &#123; id, configInfo.getDataId(),</span><br><span class="line">				configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br><span class="line">				md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, &#125;;</span><br><span class="line">	SqlContextUtils.addSqlContext(sql, args);</span><br><span class="line">	<span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConfigTagRelationAtomic</span><span class="params">(<span class="keyword">long</span> configId, String tagName, String dataId,</span></span></span><br><span class="line"><span class="function"><span class="params">			String group, String tenant)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> String sql =</span><br><span class="line">				<span class="string">"INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) "</span></span><br><span class="line">						+ <span class="string">"VALUES(?,?,?,?,?,?)"</span>;</span><br><span class="line">	<span class="keyword">final</span> Object[] args = <span class="keyword">new</span> Object[] &#123; configId, tagName, <span class="keyword">null</span>, dataId, group,</span><br><span class="line">				tenant &#125;;</span><br><span class="line">	SqlContextUtils.addSqlContext(sql, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertConfigHistoryAtomic</span><span class="params">(<span class="keyword">long</span> configHistoryId, ConfigInfo configInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">			String srcIp, String srcUser, <span class="keyword">final</span> Timestamp time, String ops)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 参数处理</span></span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">final</span> String sql =</span><br><span class="line">				<span class="string">"INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,"</span></span><br><span class="line">						+ <span class="string">"src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)"</span>;</span><br><span class="line">	<span class="keyword">final</span> Object[] args = <span class="keyword">new</span> Object[] &#123; configHistoryId, configInfo.getDataId(),</span><br><span class="line">				configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),</span><br><span class="line">				md5Tmp, srcIp, srcUser, time, ops &#125;;</span><br><span class="line"></span><br><span class="line">	SqlContextUtils.addSqlContext(sql, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Temporarily saves all insert, update, and delete statements under</span></span><br><span class="line"><span class="comment"> * a transaction in the order in which they occur</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href="mailto:liaochuntao@live.com"&gt;liaochuntao&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlContextUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ArrayList&lt;ModifyRequest&gt;&gt; SQL_CONTEXT =</span><br><span class="line">            ThreadLocal.withInitial(ArrayList::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addSqlContext</span><span class="params">(String sql, Object... args)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;ModifyRequest&gt; requests = SQL_CONTEXT.get();</span><br><span class="line">        ModifyRequest context = <span class="keyword">new</span> ModifyRequest();</span><br><span class="line">        context.setExecuteNo(requests.size());</span><br><span class="line">        context.setSql(sql);</span><br><span class="line">        context.setArgs(args);</span><br><span class="line">        requests.add(context);</span><br><span class="line">        SQL_CONTEXT.set(requests);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;ModifyRequest&gt; <span class="title">getCurrentSqlContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SQL_CONTEXT.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cleanCurrentSqlContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SQL_CONTEXT.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过一个时序图来更加直观的理解<br><img src="https://cdn.nlark.com/yuque/__puml/618e8997395fbc74433ac4a60f67b6b4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCJVc2VyXCIgYXMgVXNlclxuXG5wYXJ0aWNpcGFudCBcIkNvbmZpZ1NlcnZpY2VcIiBhcyBTZXJ2aWNlXG5wYXJ0aWNpcGFudCBcIlBlcnNpc3RlbmNlU2VydmljZVwiIGFzIFJlcG9zaXRvcnlcbnBhcnRpY2lwYW50IFwiRGVyYnlcIiBhcyBEQlxucGFydGljaXBhbnQgXCJTUUxDb250ZXh0VXRpbHNcIiBhcyBTUUxDb250ZXh0XG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiTG9nXCIgYXMgTG9nXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBTZXJ2aWNlOiDlj5HotbfphY3nva7lj5HluIPor7fmsYJcbmFjdGl2YXRlIFNlcnZpY2VcblxuU2VydmljZSAtPiBSZXBvc2l0b3J5OiDphY3nva7lj5HluINcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBTUUxDb250ZXh0OiDmi6bmiKrlvZPliY1TUUzkuIrkuIvmlodcbmFjdGl2YXRlIFNRTENvbnRleHRcblxuUmVwb3NpdG9yeSAtPiBSZXBvc2l0b3J5OiBjb21taXQg5pON5L2cXG5cblNRTENvbnRleHQgLT4gUmVwb3NpdG9yeTog5b2T5YmN6K-35rGC5raJ5Y-K55qE5omA5pyJU1FM5LiK5LiL5paHXG5cbmRlYWN0aXZhdGUgU1FMQ29udGV4dFxuXG5SZXBvc2l0b3J5IC0-IExvZzog5p6E5bu66K-35rGC5L2TXG5cbmFjdGl2YXRlIExvZ1xuZGVhY3RpdmF0ZSBMb2dcblxuUmVwb3NpdG9yeSAtPiBQcm90b2NvbDogc3VibWl0KCkg6L-b6KGM6K-35rGC5o-Q5LqkXG5hY3RpdmF0ZSBQcm90b2NvbFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb3RvY29sIC0-IFByb2Nlc3Nvcjogb25BcHBseSgpIOaWueazle-8jOeKtuaAgeacuuWkjeWItkxvZ1xuYWN0aXZhdGUgUHJvY2Vzc29yXG5cblByb2Nlc3NvciAtPiBSZXBvc2l0b3J5OiDmiafooYzmiYDmnInnmoRTUUzkuIrkuIvmlodcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBEQjog5pWw5o2u6JC95bqTXG5hY3RpdmF0ZSBEQlxuXG5EQiAtPiBSZXBvc2l0b3J5OiDnu5PmnZ_lubbov5Tlm57nu5PmnpxcbmRlYWN0aXZhdGUgREJcblxuUmVwb3NpdG9yeSAtPiBQcm9jZXNzb3I6IOi_lOWbnkxvZ0Z1dHVyZeW5tuiuvue9ruacrOasoeaJp-ihjOeahOe7k-aenFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb2Nlc3NvciAtPiBQcm90b2NvbDog6L-U5ZueTG9nRnV0dXJlXG5kZWFjdGl2YXRlIFByb2Nlc3NvclxuXG5Qcm90b2NvbCAtPiBTZXJ2aWNlOiDmnKzmrKHor7fmsYLnmoTnu5PmnpxcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuU2VydmljZSAtPiBVc2VyXG5kZWFjdGl2YXRlIFNlcnZpY2VcbmRlYWN0aXZhdGUgVXNlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiVnQxNzciLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzYxOGU4OTk3Mzk1ZmJjNzQ0MzNhYzRhNjBmNjdiNmI0LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" alt=""><a name="AAJTE"></a></p>
<h3 id="如何使用新特性"><a href="#如何使用新特性" class="headerlink" title="如何使用新特性"></a>如何使用新特性</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#*************** Embed Storage Related Configurations ***************#</span></span><br><span class="line"><span class="comment">### This value is true in stand-alone mode and false in cluster mode</span></span><br><span class="line"><span class="comment">### If this value is set to true in cluster mode, nacos's distributed storage engine is turned on</span></span><br><span class="line"><span class="string">embeddedStorage=true</span></span><br></pre></td></tr></table></figure>
<p>是否启用内嵌的分布式关系型存储的活动图<br><img src="https://cdn.nlark.com/yuque/__puml/1fd656ba3b39fe5de8fea78efdf98dd1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJDb25maWcuc3RhcnQoKVwiXG5cbmlmIFwi5Y2V5py65qih5byPXCIgdGhlblxuICAtcmlnaHQtPlt0cnVlXSBcInJldHVybiDpu5jorqTljZXmnLrlrZjlgqjooYzkuLpcIlxuICAtLT4gKCopXG5lbHNlXG4gaWYgXCLlt7LphY3nva7lpJbnva7lrZjlgqhcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIOWklue9ruaVsOaNruWtmOWCqOihjOS4ulwiXG4gICAgLS0-ICgqKVxuIGVsc2VcbiAgICBpZiBcIuW8gOWQr-WGheW1jOWtmOWCqFwiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwicmV0dXJuIOi9u-mHj-WGheW1jOWIhuW4g-W8j-WtmOWCqOihjOS4ulwiXG4gICAgICAgIC0tPiAoKilcbiAgICBlbHNlXG4gICAgICAgIC0-W2ZhbHNlXSBcInJldHVybiDpu5jorqTlpJbnva7mlbDmja7lrZjlgqjooYzkuLpcIlxuICAgICAgICAtLT4gKCopXG5cdFx0ZW5kaWZcbiBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IkNNN1VDIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8xZmQ2NTZiYTNiMzlmZTVkZThmZWE3OGVmZGY5OGRkMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt=""><a name="9UAXN"></a></p>
<h3 id="新特性的相关运维操作"><a href="#新特性的相关运维操作" class="headerlink" title="新特性的相关运维操作"></a>新特性的相关运维操作</h3><p>直接查询每个节点的derby存储的数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /nacos/v1/cs/ops/derby?sql=select * from config_info</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> List&lt;Map&lt;String, Object&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p><a name="YcqO2"></a></p>
<h3 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h3><ol>
<li>在数据库上层构建一层分布式数据操作同步层，对数据库的操作存在了限制，比如第一步insert操作，然后select操作，最后在update操作，这种在数据修改语句中穿插着查询语句的操作顺序是不支持的</li>
<li>限制了数据库的性能，由于间接的将数据库事务隔离级别调整为了串行化，人为的将并发能力降低了<br><a name="7dul8"></a><h3 id="未来演进"><a href="#未来演进" class="headerlink" title="未来演进"></a>未来演进</h3>将于Apache Derby官方一起尝试基于Raft实现BingLog的同步复制操作，从底层实现数据库同步能力</li>
</ol>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="https://www.liaochuntao.cn/2020/05/11/java-web-60/" data-id="ckagk2wl5005e16l90f5a1wue" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nacos/">nacos</a></li></ul>

                                    </footer>

    </div>

    
        
  <nav class="article-nav">
    
      <a href="/2020/05/21/menu/" class="article-nav-link">
        <strong class="article-nav-caption">Newer</strong>
        <div class="article-nav-title">
          
            (no title)
          
        </div>
      </a>
    
    
      <a href="/2020/02/23/java-web-59/" class="article-nav-link">
        <strong class="article-nav-caption">Older</strong>
        <div class="article-nav-title">CPU 100% 占用率，但是怎么排查不出是哪一个线程使用最高？</div>
      </a>
    
  </nav>


            

                
                    
                        
                            

</article>
</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
    <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 春少 Blog</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="春少 Blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>