<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
    <meta name="description" content="励志成为一位大佬">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    Etcd3 租约机制解析 |
    
    春少 Blog</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>

<body>
<main class="content">
  <section class="outer">
  <article id="post-java-web-63" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h1 class="article-title" itemprop="name">
      Etcd3 租约机制解析
    </h1>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/06/03/java-web-63/" class="article-date">
  <time datetime="2020-06-03T09:58:45.000Z" itemprop="datePublished">2020-06-03</time>
</a>
                            
  <div class="article-category">
    <a class="article-category-link" href="/categories/Etcd/">Etcd</a>
  </div>

                    </div>
                    

                        
                            
    <div class="tocbot"></div>





                                

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <h3 id="租约机制"><a href="#租约机制" class="headerlink" title="租约机制"></a>租约机制</h3><p>相比<code>Etcd2</code>的TTL机制，在<code>Etcd3</code>中实现了租约机制，也就是一个租约绑定了多个<code>Key</code>，这样就不再需要单独去管理每一个<code>Key</code>的过期事件了，化零为整的操作，降低了需要处理过期<code>Key</code>的服务端的开销</p>
<a id="more"></a>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>既然是实现了租约机制，那么就一定会有个管理者，需要对这些租约进行管理</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Lessor <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// SetRangeDeleter lets the lessor create TxnDeletes to the store.</span></span><br><span class="line">	<span class="comment">// Lessor deletes the items in the revoked or expired lease by creating</span></span><br><span class="line">	<span class="comment">// new TxnDeletes.</span></span><br><span class="line">	SetRangeDeleter(rd RangeDeleter)</span><br><span class="line"></span><br><span class="line">	SetCheckpointer(cp Checkpointer)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Grant grants a lease that expires at least after TTL seconds.</span></span><br><span class="line">	Grant(id LeaseID, ttl <span class="keyword">int64</span>) (*Lease, error)</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// Revoke revokes a lease with given ID. The item attached to the</span></span><br><span class="line">	<span class="comment">// given lease will be removed. If the ID does not exist, an error</span></span><br><span class="line">	<span class="comment">// will be returned.</span></span><br><span class="line">	Revoke(id LeaseID) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Checkpoint applies the remainingTTL of a lease. The remainingTTL is used in Promote to set the expiry of leases to less than the full TTL when possible.</span></span><br><span class="line">	Checkpoint(id LeaseID, remainingTTL <span class="keyword">int64</span>) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attach attaches given leaseItem to the lease with given LeaseID.</span></span><br><span class="line">	<span class="comment">// If the lease does not exist, an error will be returned.</span></span><br><span class="line">	Attach(id LeaseID, items []LeaseItem) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetLease returns LeaseID for given item.</span></span><br><span class="line">	<span class="comment">// If no lease found, NoLease value will be returned.</span></span><br><span class="line">	GetLease(item LeaseItem) LeaseID</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Detach detaches given leaseItem from the lease with given LeaseID.</span></span><br><span class="line">	<span class="comment">// If the lease does not exist, an error will be returned.</span></span><br><span class="line">	Detach(id LeaseID, items []LeaseItem) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Promote promotes the lessor to be the primary lessor. Primary lessor manages</span></span><br><span class="line">	<span class="comment">// the expiration and renew of leases.</span></span><br><span class="line">	<span class="comment">// Newly promoted lessor renew the TTL of all lease to extend + previous TTL.</span></span><br><span class="line">	Promote(extend time.Duration)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Demote demotes the lessor from being the primary lessor.</span></span><br><span class="line">	Demote()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Renew renews a lease with given ID. It returns the renewed TTL. If the ID does not exist,</span></span><br><span class="line">	<span class="comment">// an error will be returned.</span></span><br><span class="line">	Renew(id LeaseID) (<span class="keyword">int64</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lookup gives the lease at a given lease id, if any</span></span><br><span class="line">	Lookup(id LeaseID) *Lease</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Leases lists all leases.</span></span><br><span class="line">	Leases() []*Lease</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ExpiredLeasesC returns a chan that is used to receive expired leases.</span></span><br><span class="line">	ExpiredLeasesC() &lt;-<span class="keyword">chan</span> []*Lease</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Recover recovers the lessor state from the given backend and RangeDeleter.</span></span><br><span class="line">	Recover(b backend.Backend, rd RangeDeleter)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stop stops the lessor for managing leases. The behavior of calling Stop multiple</span></span><br><span class="line">	<span class="comment">// times is undefined.</span></span><br><span class="line">	Stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是<code>Lessor</code>的相关操作接口，现在来一个一个看下</p>
<h4 id="Grant-id-LeaseID-ttl-int64-Lease-error"><a href="#Grant-id-LeaseID-ttl-int64-Lease-error" class="headerlink" title="Grant(id LeaseID, ttl int64) (*Lease, error)"></a>Grant(id LeaseID, ttl int64) (*Lease, error)</h4><p><code>Grant</code>是一个授权的操作，对一个租约授予一个租约时间，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">Grant</span><span class="params">(id LeaseID, ttl <span class="keyword">int64</span>)</span> <span class="params">(*Lease, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> id == NoLease &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrLeaseNotFound</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ttl &gt; MaxLeaseTTL &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrLeaseTTLTooLarge</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里进行创建一个租约</span></span><br><span class="line">	l := &amp;Lease&#123;</span><br><span class="line">		ID:      id,</span><br><span class="line">		ttl:     ttl,</span><br><span class="line">		itemSet: <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseItem]<span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		revokec: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	le.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> le.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断租约是否已经存在，如果存在，则抛出租约存在的异常</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := le.leaseMap[id]; ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrLeaseExists</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对租约进行修正，如果小于Etcd所设置的最小值，则进行替换</span></span><br><span class="line">	<span class="keyword">if</span> l.ttl &lt; le.minLeaseTTL &#123;</span><br><span class="line">		l.ttl = le.minLeaseTTL</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当前Lessor是否是在Leader节点</span></span><br><span class="line">	<span class="keyword">if</span> le.isPrimary() &#123;</span><br><span class="line">		<span class="comment">// 如果是Leader节点，则设置过期时间</span></span><br><span class="line">		l.refresh(<span class="number">0</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 否则设置对应的该租约时间为永久</span></span><br><span class="line">		l.forever()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	le.leaseMap[id] = l</span><br><span class="line">	item := &amp;LeaseWithTime&#123;id: l.ID, time: l.expiry.UnixNano()&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将该租约注册到过期通知中心去</span></span><br><span class="line">	le.leaseExpiredNotifier.RegisterOrUpdate(item)</span><br><span class="line">	<span class="comment">// 对当前的 Lease 对象进行持久化</span></span><br><span class="line">	l.persistTo(le.b)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 指标数据变动</span></span><br><span class="line">	leaseTotalTTLs.Observe(<span class="keyword">float64</span>(l.ttl))</span><br><span class="line">	leaseGranted.Inc()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果是 Leader 节点，需要将当前的Lease压入监听堆中，用于后面的Checkpoint机制。</span></span><br><span class="line">	<span class="keyword">if</span> le.isPrimary() &#123;</span><br><span class="line">		<span class="comment">// </span></span><br><span class="line">		le.scheduleCheckpointIfNeeded(l)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> l, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">scheduleCheckpointIfNeeded</span><span class="params">(lease *Lease)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> le.cp == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当前租约剩余的时间是否大于每次 checkpoint 的调度时间</span></span><br><span class="line">	<span class="keyword">if</span> lease.RemainingTTL() &gt; <span class="keyword">int64</span>(le.checkpointInterval.Seconds()) &#123;</span><br><span class="line">		<span class="keyword">if</span> le.lg != <span class="literal">nil</span> &#123;</span><br><span class="line">			le.lg.Debug(<span class="string">"Scheduling lease checkpoint"</span>,</span><br><span class="line">				zap.Int64(<span class="string">"leaseID"</span>, <span class="keyword">int64</span>(lease.ID)),</span><br><span class="line">				zap.Duration(<span class="string">"intervalSeconds"</span>, le.checkpointInterval),</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 将其加入一个有点队列，用于 checkpoint 机制移除过期的租约</span></span><br><span class="line">		heap.Push(&amp;le.leaseCheckpointHeap, &amp;LeaseWithTime&#123;</span><br><span class="line">			id:   lease.ID,</span><br><span class="line">			time: time.Now().Add(le.checkpointInterval).UnixNano(),</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在注册一个租约的时候，会对其进行一数据校验以及相关初始化，由于租约是带有生存时间的，因此需要利用一个<code>checkpoint</code>机制对所有的租约进行检查，移除过期的<code>Lease</code>。</p>
<h4 id="Revoke-id-LeaseID-error"><a href="#Revoke-id-LeaseID-error" class="headerlink" title="Revoke(id LeaseID) error"></a>Revoke(id LeaseID) error</h4><p>既然有租约的申请，那么必然有租约的撤销，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">Revoke</span><span class="params">(id LeaseID)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	le.mu.Lock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将其从 map 对象中移除</span></span><br><span class="line">	l := le.leaseMap[id]</span><br><span class="line">	<span class="keyword">if</span> l == <span class="literal">nil</span> &#123;</span><br><span class="line">		le.mu.Unlock()</span><br><span class="line">		<span class="keyword">return</span> ErrLeaseNotFound</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(l.revokec)</span><br><span class="line">	<span class="comment">// unlock before doing external work</span></span><br><span class="line">	le.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> le.rd == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 由于租约是绑定了多个key，因此对于key的删除就是一个批量操作</span></span><br><span class="line">	txn := le.rd()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里需要对 key 进行排序操作，已确保每个节点对于key的删除顺序都是一致的</span></span><br><span class="line">	keys := l.Keys()</span><br><span class="line">	sort.StringSlice(keys).Sort()</span><br><span class="line">	<span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line">		<span class="comment">// 删除 key</span></span><br><span class="line">		txn.DeleteRange([]<span class="keyword">byte</span>(key), <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	le.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> le.mu.Unlock()</span><br><span class="line">	<span class="built_in">delete</span>(le.leaseMap, l.ID)</span><br><span class="line">	<span class="comment">// lease deletion needs to be in the same backend transaction with the</span></span><br><span class="line">	<span class="comment">// kv deletion. Or we might end up with not executing the revoke or not</span></span><br><span class="line">	<span class="comment">// deleting the keys if etcdserver fails in between.</span></span><br><span class="line">	le.b.BatchTx().UnsafeDelete(leaseBucketName, int64ToBytes(<span class="keyword">int64</span>(l.ID)))</span><br><span class="line"></span><br><span class="line">	txn.End()</span><br><span class="line"></span><br><span class="line">	leaseRevoked.Inc()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>租约的创建、删除，其代码都比较简单。这两个操作都需要确保租约只会被创建一次，并且最终都会被持久化保存。</p>
<p>刚刚只是说了租约的创建与删除，但是租约是可以被延长的，那么延长租约的操作呢？</p>
<h4 id="Renew-id-LeaseID-int64-error"><a href="#Renew-id-LeaseID-int64-error" class="headerlink" title="Renew(id LeaseID) (int64, error)"></a>Renew(id LeaseID) (int64, error)</h4><p>这里是租约延长的操作，其本质就是对租约进行<code>Renew</code>操作</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">Renew</span><span class="params">(id LeaseID)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">	le.mu.RLock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 租约的 Renew 操作只能发生在 Leader 节点</span></span><br><span class="line">	<span class="keyword">if</span> !le.isPrimary() &#123;</span><br><span class="line">		<span class="comment">// forward renew request to primary instead of returning error.</span></span><br><span class="line">		le.mu.RUnlock()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, ErrNotPrimary</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	demotec := le.demotec</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断对应的租约是否存在</span></span><br><span class="line">	l := le.leaseMap[id]</span><br><span class="line">	<span class="keyword">if</span> l == <span class="literal">nil</span> &#123;</span><br><span class="line">		le.mu.RUnlock()</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, ErrLeaseNotFound</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 判断是否需要重置租约的剩余时间</span></span><br><span class="line">	clearRemainingTTL := le.cp != <span class="literal">nil</span> &amp;&amp; l.remainingTTL &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	le.mu.RUnlock()</span><br><span class="line">	<span class="comment">// 如果租约过期，必须走正常的租约过期流程进行租约过期操作</span></span><br><span class="line">	<span class="keyword">if</span> l.expired() &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="comment">// A expired lease might be pending for revoking or going through</span></span><br><span class="line">		<span class="comment">// quorum to be revoked. To be accurate, renew request must wait for the</span></span><br><span class="line">		<span class="comment">// deletion to complete.</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-l.revokec:</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>, ErrLeaseNotFound</span><br><span class="line">		<span class="comment">// The expired lease might fail to be revoked if the primary changes.</span></span><br><span class="line">		<span class="comment">// The caller will retry on ErrNotPrimary.</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-demotec:</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>, ErrNotPrimary</span><br><span class="line">		<span class="keyword">case</span> &lt;-le.stopC:</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>, ErrNotPrimary</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果需要对当前租约的剩余时间进行一次重置，这需要走一个Raft流程，将租约信息进行同步</span></span><br><span class="line">	<span class="keyword">if</span> clearRemainingTTL &#123;</span><br><span class="line">		le.cp(context.Background(), &amp;pb.LeaseCheckpointRequest&#123;Checkpoints: []*pb.LeaseCheckpoint&#123;&#123;ID: <span class="keyword">int64</span>(l.ID), Remaining_TTL: <span class="number">0</span>&#125;&#125;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	le.mu.Lock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 租约续约成功之后，重新走一次创建租约的后续流程——加入监听堆中。</span></span><br><span class="line">	l.refresh(<span class="number">0</span>)</span><br><span class="line">	item := &amp;LeaseWithTime&#123;id: l.ID, time: l.expiry.UnixNano()&#125;</span><br><span class="line">	le.leaseExpiredNotifier.RegisterOrUpdate(item)</span><br><span class="line">	le.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	leaseRenewed.Inc()</span><br><span class="line">	<span class="keyword">return</span> l.ttl, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，租约的相关操作大致就这样些。<code>Etcd</code>是将具体的<code>Key</code>绑定在租约中，那么这个绑定是怎么做的？</p>
<h4 id="Attach-id-LeaseID-items-LeaseItem-error"><a href="#Attach-id-LeaseID-items-LeaseItem-error" class="headerlink" title="Attach(id LeaseID, items []LeaseItem) error"></a>Attach(id LeaseID, items []LeaseItem) error</h4><p><code>Key</code>绑定租约，是通过将<code>Key</code>作为一个附件附加到<code>Lease</code>当中，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">Attach</span><span class="params">(id LeaseID, items []LeaseItem)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	le.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> le.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	l := le.leaseMap[id]</span><br><span class="line">	<span class="keyword">if</span> l == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrLeaseNotFound</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l.mu.Lock()</span><br><span class="line">	<span class="comment">// 这里将附带的key放入 Lease 的附带map对象中</span></span><br><span class="line">	<span class="keyword">for</span> _, it := <span class="keyword">range</span> items &#123;</span><br><span class="line">		l.itemSet[it] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		le.itemMap[it] = id</span><br><span class="line">	&#125;</span><br><span class="line">	l.mu.Unlock()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Key</code>绑定到对应的租约，其代码很简单，就是将<code>Key</code>作为了<code>Attachment</code>附带在对应的<code>Lease</code>上，这个就像<code>Netty</code>或者<code>JDK</code>的<code>Channel</code>，可以附带一些信息在对应的<code>Channel</code>上，将信息的生命周期与其生命周期进行绑定在一起。</p>
<h3 id="怎么实现过期的"><a href="#怎么实现过期的" class="headerlink" title="怎么实现过期的"></a>怎么实现过期的</h3><p>刚刚上面把租约的创建、销毁、续约以及如何将<code>Key</code>绑定到对应的租约上分析了下，但是没有看到说如何对租约过期的扫描操作，这里就要回到<code>Lessor</code>的创建上了</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newLessor</span><span class="params">(lg *zap.Logger, b backend.Backend, cfg LessorConfig)</span> *<span class="title">lessor</span></span> &#123;</span><br><span class="line">	checkpointInterval := cfg.CheckpointInterval</span><br><span class="line">	expiredLeaseRetryInterval := cfg.ExpiredLeasesRetryInterval</span><br><span class="line">	<span class="keyword">if</span> checkpointInterval == <span class="number">0</span> &#123;</span><br><span class="line">		checkpointInterval = defaultLeaseCheckpointInterval</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> expiredLeaseRetryInterval == <span class="number">0</span> &#123;</span><br><span class="line">		expiredLeaseRetryInterval = defaultExpiredleaseRetryInterval</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 构建一个租约管理者</span></span><br><span class="line">	l := &amp;lessor&#123;</span><br><span class="line">		<span class="comment">// 租约容器</span></span><br><span class="line">		leaseMap:                  <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseID]*Lease),</span><br><span class="line">		<span class="comment">// Key 到 租约的映射</span></span><br><span class="line">		itemMap:                   <span class="built_in">make</span>(<span class="keyword">map</span>[LeaseItem]LeaseID),</span><br><span class="line">		<span class="comment">// 租约过期通知</span></span><br><span class="line">		leaseExpiredNotifier:      newLeaseExpiredNotifier(),</span><br><span class="line">		leaseCheckpointHeap:       <span class="built_in">make</span>(LeaseQueue, <span class="number">0</span>),</span><br><span class="line">		b:                         b,</span><br><span class="line">		minLeaseTTL:               cfg.MinLeaseTTL,</span><br><span class="line">		checkpointInterval:        checkpointInterval,</span><br><span class="line">		expiredLeaseRetryInterval: expiredLeaseRetryInterval,</span><br><span class="line">		<span class="comment">// expiredC is a small buffered chan to avoid unnecessary blocking.</span></span><br><span class="line">		expiredC: <span class="built_in">make</span>(<span class="keyword">chan</span> []*Lease, <span class="number">16</span>),</span><br><span class="line">		stopC:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		doneC:    <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		lg:       lg,</span><br><span class="line">	&#125;</span><br><span class="line">	l.initAndRecover()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 关键方法，开启一个协程去做了一个任务，来看看这个任务是做了什么</span></span><br><span class="line">	<span class="keyword">go</span> l.runLoop()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> l</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">runLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(le.doneC)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里用一个死循环+time.After 实现一个定时调度</span></span><br><span class="line">	<span class="comment">// 去定时执行 revokeExpiredLeases 以及 checkpointScheduledLeases</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		le.revokeExpiredLeases()</span><br><span class="line">		le.checkpointScheduledLeases()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-time.After(<span class="number">500</span> * time.Millisecond):</span><br><span class="line">		<span class="keyword">case</span> &lt;-le.stopC:</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="revokeExpiredLeases"><a href="#revokeExpiredLeases" class="headerlink" title="revokeExpiredLeases"></a>revokeExpiredLeases</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里是进行撤销已经过期的租约</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">revokeExpiredLeases</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> ls []*Lease</span><br><span class="line"></span><br><span class="line">	<span class="comment">// rate limit</span></span><br><span class="line">	revokeLimit := leaseRevokeRate / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	le.mu.RLock()</span><br><span class="line">	<span class="comment">// 如果是 Leader 节点</span></span><br><span class="line">	<span class="keyword">if</span> le.isPrimary() &#123;</span><br><span class="line">		<span class="comment">// 这里找出过期的租约列表</span></span><br><span class="line">		ls = le.findExpiredLeases(revokeLimit)</span><br><span class="line">	&#125;</span><br><span class="line">	le.mu.RUnlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ls) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="comment">// 如果该租约管理者已经停止了，结束，生命也不做</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-le.stopC:</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="comment">// 将过期的租约发送到 channel 中</span></span><br><span class="line">		<span class="keyword">case</span> le.expiredC &lt;- ls:</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">// the receiver of expiredC is probably busy handling</span></span><br><span class="line">			<span class="comment">// other stuff</span></span><br><span class="line">			<span class="comment">// let's try this next time after 500ms</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">findExpiredLeases</span><span class="params">(limit <span class="keyword">int</span>)</span> []*<span class="title">Lease</span></span> &#123;</span><br><span class="line">	leases := <span class="built_in">make</span>([]*Lease, <span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="comment">// 租约管理者调用自身的 expireExists 方法去判断当前是否有租约过期，</span></span><br><span class="line">		<span class="comment">// 如果有租约过期，在判断他的下一个是否也是过期的了，好判断这个循环是否需要继续</span></span><br><span class="line">		l, ok, next := le.expireExists()</span><br><span class="line">		<span class="keyword">if</span> !ok &amp;&amp; !next &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> next &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 判断是否是真的过期了。</span></span><br><span class="line">		<span class="keyword">if</span> l.expired() &#123;</span><br><span class="line">			<span class="comment">// 最加到列表中</span></span><br><span class="line">			leases = <span class="built_in">append</span>(leases, l)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// reach expired limit</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(leases) == limit &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> leases</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">expireExists</span><span class="params">()</span> <span class="params">(l *Lease, ok <span class="keyword">bool</span>, next <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 如果当前需要进行过期通知的元素没有，则结束</span></span><br><span class="line">	<span class="keyword">if</span> le.leaseExpiredNotifier.Len() == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里弹出堆顶的租约 ID</span></span><br><span class="line">	item := le.leaseExpiredNotifier.Poll()</span><br><span class="line">	<span class="comment">// 找到租约对象。</span></span><br><span class="line">	l = le.leaseMap[item.id]</span><br><span class="line">	<span class="keyword">if</span> l == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 如果不存在需要将其注销</span></span><br><span class="line">		le.leaseExpiredNotifier.Unregister() <span class="comment">// O(log N)</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>, <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	now := time.Now()</span><br><span class="line">	<span class="comment">//  判断当前时间是否小于租约的到期目标时间，如果小于则表示当前没有任何一个租约过期了</span></span><br><span class="line">	<span class="keyword">if</span> now.UnixNano() &lt; item.time <span class="comment">/* expiration time */</span> &#123;</span><br><span class="line">		<span class="comment">// Candidate expirations are caught up, reinsert this item</span></span><br><span class="line">		<span class="comment">// and no need to revoke (nothing is expiry)</span></span><br><span class="line">		<span class="keyword">return</span> l, <span class="literal">false</span>, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//TODO 为什么需要再次将这个租约回压进行二次判断是否真的过期了？</span></span><br><span class="line">	item.time = now.Add(le.expiredLeaseRetryInterval).UnixNano()</span><br><span class="line">	le.leaseExpiredNotifier.RegisterOrUpdate(item)</span><br><span class="line">	<span class="keyword">return</span> l, <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而具体处理这个<code>Channel</code>的代码在<code>etcd/etcdserver/server.go:972</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">s.goAttach(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="comment">// Increases throughput of expired leases deletion process through parallelization</span></span><br><span class="line">			c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, maxPendingRevokes)</span><br><span class="line">			<span class="keyword">for</span> _, lease := <span class="keyword">range</span> leases &#123;</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> c &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;:</span><br><span class="line">				<span class="keyword">case</span> &lt;-s.stopping:</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				lid := lease.ID</span><br><span class="line">				s.goAttach(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					ctx := s.authStore.WithRoot(s.ctx)</span><br><span class="line">					<span class="comment">// 对租约进行销毁</span></span><br><span class="line">					_, lerr := s.LeaseRevoke(ctx, &amp;pb.LeaseRevokeRequest&#123;ID: <span class="keyword">int64</span>(lid)&#125;)</span><br><span class="line">					<span class="keyword">if</span> lerr == <span class="literal">nil</span> &#123;</span><br><span class="line">						leaseExpired.Inc()</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						lg.Warn(</span><br><span class="line">							<span class="string">"failed to revoke lease"</span>,</span><br><span class="line">							zap.String(<span class="string">"lease-id"</span>, fmt.Sprintf(<span class="string">"%016x"</span>, lid)),</span><br><span class="line">							zap.Error(lerr),</span><br><span class="line">						)</span><br><span class="line">					&#125;</span><br><span class="line">					&lt;-c</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="checkpointScheduledLeases"><a href="#checkpointScheduledLeases" class="headerlink" title="checkpointScheduledLeases"></a>checkpointScheduledLeases</h4><p><code>Checkpoint</code>机制主要是为了避免由于<code>Leader</code>的选举以及重启可能会导致租约的剩余时间继续流逝。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// When a lease's deadline should be persisted to preserve the remaining TTL across leader elections and restarts, the lessor will checkpoint the lease by the Checkpointer.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">checkpointScheduledLeases</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> cps []*pb.LeaseCheckpoint</span><br><span class="line"></span><br><span class="line">	<span class="comment">// rate limit</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; leaseCheckpointRate/<span class="number">2</span>; i++ &#123;</span><br><span class="line">		le.mu.Lock()</span><br><span class="line">		<span class="comment">// 如果是在Leader节点</span></span><br><span class="line">		<span class="keyword">if</span> le.isPrimary() &#123;</span><br><span class="line">			cps = le.findDueScheduledCheckpoints(maxLeaseCheckpointBatchSize)</span><br><span class="line">		&#125;</span><br><span class="line">		le.mu.Unlock()</span><br><span class="line">		<span class="comment">// 保存租约的快照</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(cps) != <span class="number">0</span> &#123;</span><br><span class="line">			le.cp(context.Background(), &amp;pb.LeaseCheckpointRequest&#123;Checkpoints: cps&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(cps) &lt; maxLeaseCheckpointBatchSize &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *lessor)</span> <span class="title">findDueScheduledCheckpoints</span><span class="params">(checkpointLimit <span class="keyword">int</span>)</span> []*<span class="title">pb</span>.<span class="title">LeaseCheckpoint</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> le.cp == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 记录当前时间信息</span></span><br><span class="line">	now := time.Now()</span><br><span class="line">	cps := []*pb.LeaseCheckpoint&#123;&#125;</span><br><span class="line">	<span class="comment">// 当前还有租约以及还没到达限制数</span></span><br><span class="line">	<span class="keyword">for</span> le.leaseCheckpointHeap.Len() &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(cps) &lt; checkpointLimit &#123;</span><br><span class="line">		lt := le.leaseCheckpointHeap[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">if</span> lt.time <span class="comment">/* next checkpoint time */</span> &gt; now.UnixNano() &#123;</span><br><span class="line">			<span class="keyword">return</span> cps</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 弹出堆顶元素，这是需要进行快照机制保存的</span></span><br><span class="line">		heap.Pop(&amp;le.leaseCheckpointHeap)</span><br><span class="line">		<span class="keyword">var</span> l *Lease</span><br><span class="line">		<span class="keyword">var</span> ok <span class="keyword">bool</span></span><br><span class="line">		<span class="comment">// 如果租约不在，继续</span></span><br><span class="line">		<span class="keyword">if</span> l, ok = le.leaseMap[lt.id]; !ok &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 如果当前时间已经超过了该租约的过期时间，继续</span></span><br><span class="line">		<span class="keyword">if</span> !now.Before(l.expiry) &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 计算该租约的剩余时间</span></span><br><span class="line">		remainingTTL := <span class="keyword">int64</span>(math.Ceil(l.expiry.Sub(now).Seconds()))</span><br><span class="line">		<span class="keyword">if</span> remainingTTL &gt;= l.ttl &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> le.lg != <span class="literal">nil</span> &#123;</span><br><span class="line">			le.lg.Debug(<span class="string">"Checkpointing lease"</span>,</span><br><span class="line">				zap.Int64(<span class="string">"leaseID"</span>, <span class="keyword">int64</span>(lt.id)),</span><br><span class="line">				zap.Int64(<span class="string">"remainingTTL"</span>, remainingTTL),</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 追加到 LeaseCheckpoint[] 队列中</span></span><br><span class="line">		cps = <span class="built_in">append</span>(cps, &amp;pb.LeaseCheckpoint&#123;ID: <span class="keyword">int64</span>(lt.id), Remaining_TTL: remainingTTL&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cps</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="https://www.liaochuntao.cn/2020/06/03/java-web-63/" data-id="ckbai2qe8005g16olb5dsrt9q" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Etcd/">Etcd</a></li></ul>

                                    </footer>

    </div>

    
        
  <nav class="article-nav">
    
      <a href="/2020/06/07/java-web-64/" class="article-nav-link">
        <strong class="article-nav-caption">Newer</strong>
        <div class="article-nav-title">
          
            为Nacos实现一个DNS服务发现
          
        </div>
      </a>
    
    
      <a href="/2020/05/26/java-web-62/" class="article-nav-link">
        <strong class="article-nav-caption">Older</strong>
        <div class="article-nav-title">JRaft 线性读原理分析</div>
      </a>
    
  </nav>


            

                
                    
                        
                            

</article>
</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
    <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 春少 Blog</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="春少 Blog"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
<script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>