<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.liaochuntao.cn","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="励志成为一位大佬">
<meta property="og:type" content="website">
<meta property="og:title" content="春少 Blog">
<meta property="og:url" content="https://www.liaochuntao.cn/page/2/index.html">
<meta property="og:site_name" content="春少 Blog">
<meta property="og:description" content="励志成为一位大佬">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="春少 Blog">
<meta name="twitter:description" content="励志成为一位大佬">

<link rel="canonical" href="https://www.liaochuntao.cn/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>春少 Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">春少 Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/08/03/java-web-51/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/03/java-web-51/" class="post-title-link" itemprop="url">JRaft中的轻量级的对象池实现原理浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-03 20:57:29" itemprop="dateCreated datePublished" datetime="2019-08-03T20:57:29+08:00">2019-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-25 12:20:08" itemprop="dateModified" datetime="2020-02-25T12:20:08+08:00">2020-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JRaft/" itemprop="url" rel="index"><span itemprop="name">JRaft</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="对象池"><a href="#对象池" class="headerlink" title="对象池"></a>对象池</h4><p>对象池存在的意义，就是为了避免频繁的创建对象而将对象进行池化操作——创建出来的对象具有可回收的特性，当对象不使用时，直接返回一个对象池容器中，清楚对象的所有属性信息，然后在池中等待复用</p>
<p>而对于对象池，也不是所有场景都使用的，对象池的意义在于减低创建需要高昂成本的对象带来的开销，比如数据库连接、Http连接、字节数组等等</p>
<p>在基于<code>Jraft</code>实现的<code>RheaKV</code>的分布式<code>KV</code>中，由于在<code>Raft</code>的日志应用中存在大量的字节数组操作，因此<code>rheakv</code>基于<code>netty</code>的<code>Recyclers</code>实现了一个对象池</p>
<h4 id="源码浅析"><a href="#源码浅析" class="headerlink" title="源码浅析"></a>源码浅析</h4><h5 id="初始化一个对象池"><a href="#初始化一个对象池" class="headerlink" title="初始化一个对象池"></a>初始化一个对象池</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(Recyclers.class);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger idGenerator = <span class="keyword">new</span> AtomicInteger(Integer.MIN_VALUE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OWN_THREAD_ID = idGenerator.getAndIncrement();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_MAX_CAPACITY_PER_THREAD = <span class="number">4</span> * <span class="number">1024</span>; <span class="comment">// Use 4k instances as default.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_CAPACITY_PER_THREAD;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INITIAL_CAPACITY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">  <span class="comment">// 每个线程的最大对象池容量</span></span><br><span class="line">	<span class="keyword">int</span> maxCapacityPerThread = SystemPropertyUtil.getInt(<span class="string">"jraft.recyclers.maxCapacityPerThread"</span>, DEFAULT_INITIAL_MAX_CAPACITY_PER_THREAD);</span><br><span class="line">	<span class="keyword">if</span> (maxCapacityPerThread &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		maxCapacityPerThread = DEFAULT_INITIAL_MAX_CAPACITY_PER_THREAD;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DEFAULT_MAX_CAPACITY_PER_THREAD = maxCapacityPerThread;</span><br><span class="line">  <span class="comment">// 日志打印相关参数信息</span></span><br><span class="line">	<span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (DEFAULT_MAX_CAPACITY_PER_THREAD == <span class="number">0</span>) &#123;</span><br><span class="line">			LOG.debug(<span class="string">"-Djraft.recyclers.maxCapacityPerThread: disabled"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			LOG.debug(<span class="string">"-Djraft.recyclers.maxCapacityPerThread: &#123;&#125;"</span>, DEFAULT_MAX_CAPACITY_PER_THREAD);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置初始化容量信息</span></span><br><span class="line">	INITIAL_CAPACITY = Math.min(DEFAULT_MAX_CAPACITY_PER_THREAD, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当最大容量为0时，使用这个Handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Handle NOOP_HANDLE = <span class="keyword">new</span> Handle() &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxCapacityPerThread;</span><br><span class="line"><span class="comment">// 线程变量，保存每个线程的对象池信息，通过 ThreadLocal 的使用，避免了不同线程之间的竞争情况</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Stack&lt;T&gt;&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;Stack&lt;T&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> Stack&lt;T&gt; <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 初始化一个对象栈</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Stack&lt;&gt;(Recyclers.<span class="keyword">this</span>, Thread.currentThread(), maxCapacityPerThread);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Recyclers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>(DEFAULT_MAX_CAPACITY_PER_THREAD);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Recyclers</span><span class="params">(<span class="keyword">int</span> maxCapacityPerThread)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.maxCapacityPerThread = Math.max(<span class="number">0</span>, maxCapacityPerThread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="申请一个对象"><a href="#申请一个对象" class="headerlink" title="申请一个对象"></a>申请一个对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 未设置线程最大容量，则每次申请都是采取 new Object() 的方式</span></span><br><span class="line">    <span class="keyword">if</span> (maxCapacityPerThread == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> newObject(NOOP_HANDLE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前线程的 Stack</span></span><br><span class="line">    Stack&lt;T&gt; stack = threadLocal.get();</span><br><span class="line">    <span class="comment">// 获取一个可用的对象</span></span><br><span class="line">    DefaultHandle handle = stack.pop();</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="keyword">null</span>) &#123;</span><br><span class="line">        handle = stack.newHandle();</span><br><span class="line">        handle.value = newObject(handle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stack</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">DefaultHandle <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="keyword">this</span>.size;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!scavenge()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            size = <span class="keyword">this</span>.size;</span><br><span class="line">        &#125;</span><br><span class="line">        size--;</span><br><span class="line">        DefaultHandle ret = elements[size];</span><br><span class="line">      	<span class="comment">// 一个对象被存到了两个Stack&lt;T&gt;中</span></span><br><span class="line">        <span class="keyword">if</span> (ret.lastRecycledId != ret.recycleId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"recycled multiple times"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// 清空回收信息，以便判断是否重复回收</span></span><br><span class="line">        ret.recycleId = <span class="number">0</span>;</span><br><span class="line">        ret.lastRecycledId = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.size = size;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="对象释放"><a href="#对象释放" class="headerlink" title="对象释放"></a>对象释放</h5><p>对象的释放，首先的看<code>DefaultHandler</code>这个类，<code>DefaultHandler</code>是实际对象的持有类，这个<code>handler</code>负责对象的创建与释放</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHandle</span> <span class="keyword">implements</span> <span class="title">Handle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> lastRecycledId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> recycleId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Stack&lt;?&gt; stack;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line"></span><br><span class="line">    DefaultHandle(Stack&lt;?&gt; stack) &#123;</span><br><span class="line">        <span class="keyword">this</span>.stack = stack;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断分配 Handle 的线程是否是当前线程</span></span><br><span class="line">        Thread thread = Thread.currentThread();</span><br><span class="line">        <span class="keyword">if</span> (thread == stack.thread) &#123;</span><br><span class="line">            stack.push(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// we don't want to have a ref to the queue as the value in our weak map</span></span><br><span class="line">        <span class="comment">// so we null it out; to ensure there are no races with restoring it later</span></span><br><span class="line">        <span class="comment">// we impose a memory ordering here (no-op on x86)</span></span><br><span class="line">        <span class="comment">// 如果不是当前线程，则需要延迟回收，获取当前线程存储的延迟回收WeakHashMap</span></span><br><span class="line">        Map&lt;Stack&lt;?&gt;, WeakOrderQueue&gt; delayedRecycled = Recyclers.delayedRecycled.get();</span><br><span class="line">      	<span class="comment">// 当前 handler 所在的 stack 是否已经在延迟回收的任务队列中</span></span><br><span class="line">      	<span class="comment">// 并且 WeakOrderQueue是一个多线程间可以共享的Queue</span></span><br><span class="line">        WeakOrderQueue queue = delayedRecycled.get(stack);</span><br><span class="line">        <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            delayedRecycled.put(stack, queue = <span class="keyword">new</span> WeakOrderQueue(stack, thread));</span><br><span class="line">        &#125;</span><br><span class="line">        queue.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stack</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(DefaultHandle item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 如果两个id有一个为0——回收位，</span></span><br><span class="line">        <span class="keyword">if</span> ((item.recycleId | item.lastRecycledId) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"recycled already"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// 设置对象的回收id为线程id信息，标记自己的被回收的线程信息</span></span><br><span class="line">        item.recycleId = item.lastRecycledId = OWN_THREAD_ID;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> size = <span class="keyword">this</span>.size;</span><br><span class="line">        <span class="keyword">if</span> (size &gt;= maxCapacity) &#123;</span><br><span class="line">            <span class="comment">// Hit the maximum capacity - drop the possibly youngest object.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size == elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, Math.min(size &lt;&lt; <span class="number">1</span>, maxCapacity));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        elements[size] = item;</span><br><span class="line">        <span class="keyword">this</span>.size = size + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对象的回收，如果是本线程申请又在本线程执行释放，那么就很简单，直接往当前线程的<code>Stack&lt;T&gt;</code>栈中压入对象就可以了，但如果在本线程执行回收操作的对象，不是在本线程申请的话，是不可以进入到本线程的对象缓存栈中的，需要加入到一个延迟回收的<code>WeakOrderQueue</code>容器中，同时将自己标记为可被任意线程回收的状态（<code>DefaultHandler</code>中的属性<code>stack</code>置为<code>null</code>）</p>
<h5 id="延迟回收"><a href="#延迟回收" class="headerlink" title="延迟回收"></a>延迟回收</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakOrderQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LINK_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Let Link extend AtomicInteger for intrinsics. The Link itself will be used as writerIndex.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"serial"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Link</span> <span class="keyword">extends</span> <span class="title">AtomicInteger</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> DefaultHandle[] elements = <span class="keyword">new</span> DefaultHandle[LINK_CAPACITY];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> readIndex;</span><br><span class="line">        <span class="keyword">private</span> Link next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// chain of data items</span></span><br><span class="line">    <span class="keyword">private</span> Link head, tail;</span><br><span class="line">    <span class="comment">// pointer to another queue of delayed items for the same stack</span></span><br><span class="line">    <span class="keyword">private</span> WeakOrderQueue next;</span><br><span class="line">   	<span class="comment">// 将持有该Queue的对象进行设置为虚引用，就可以通过 null 判断对该线程的资源进行回收</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;Thread&gt; owner;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id = idGenerator.getAndIncrement();</span><br><span class="line"></span><br><span class="line">    WeakOrderQueue(Stack&lt;?&gt; stack, Thread thread) &#123;</span><br><span class="line">        head = tail = <span class="keyword">new</span> Link();</span><br><span class="line">        owner = <span class="keyword">new</span> WeakReference&lt;&gt;(thread);</span><br><span class="line">        <span class="keyword">synchronized</span> (stackLock(stack)) &#123;</span><br><span class="line">            next = stack.head;</span><br><span class="line">            stack.head = <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">stackLock</span><span class="params">(Stack&lt;?&gt; stack)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stack;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(DefaultHandle handle)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置handler的最近一次回收的id信息，标记此时暂存的handler是被谁回收的</span></span><br><span class="line">        handle.lastRecycledId = id;</span><br><span class="line"></span><br><span class="line">        Link tail = <span class="keyword">this</span>.tail;</span><br><span class="line">        <span class="keyword">int</span> writeIndex;</span><br><span class="line">        <span class="keyword">if</span> ((writeIndex = tail.get()) == LINK_CAPACITY) &#123;</span><br><span class="line">            <span class="keyword">this</span>.tail = tail = tail.next = <span class="keyword">new</span> Link();</span><br><span class="line">            writeIndex = tail.get();</span><br><span class="line">        &#125;</span><br><span class="line">        tail.elements[writeIndex] = handle;</span><br><span class="line">      	<span class="comment">// handler 的持有者设置为 null，避免了内存泄漏</span></span><br><span class="line">        handle.stack = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// we lazy set to ensure that setting stack to null appears before we unnull it in the owning thread;</span></span><br><span class="line">        <span class="comment">// this also means we guarantee visibility of an element in the queue if we see the index updated</span></span><br><span class="line">        tail.lazySet(writeIndex + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasFinalData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tail.readIndex != tail.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// transfer as many items as we can from this queue to the stack, returning true if any were transferred</span></span><br><span class="line">  	<span class="comment">// 进行数据的转移，将 Queue 中的暂存的对象移到 Stack 中</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">transfer</span><span class="params">(Stack&lt;?&gt; dst)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Link head = <span class="keyword">this</span>.head;</span><br><span class="line">        <span class="keyword">if</span> (head == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读指针的位置已经到达了每个 Node 的存储容量，如果还有下一个节点，进行节点转移</span></span><br><span class="line">        <span class="keyword">if</span> (head.readIndex == LINK_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">// 没有下一个节点的话</span></span><br><span class="line">            <span class="keyword">if</span> (head.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新设置头结点所在的位置</span></span><br><span class="line">            <span class="keyword">this</span>.head = head = head.next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> srcStart = head.readIndex;</span><br><span class="line">        <span class="keyword">int</span> srcEnd = head.get();</span><br><span class="line">      	<span class="comment">// 本次可转移的对象数量（写指针减去读指针）</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> srcSize = srcEnd - srcStart;</span><br><span class="line">        <span class="comment">// 不存在被压入队列中延迟回收的 handler</span></span><br><span class="line">        <span class="keyword">if</span> (srcSize == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dstSize = dst.size;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> expectedCapacity = dstSize + srcSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 期望的容量大小与实际 Stack 所能承载的容量大小进行比对，取最小值</span></span><br><span class="line">        <span class="keyword">if</span> (expectedCapacity &gt; dst.elements.length) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> actualCapacity = dst.increaseCapacity(expectedCapacity);</span><br><span class="line">            srcEnd = Math.min(srcStart + actualCapacity - dstSize, srcEnd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (srcStart != srcEnd) &#123;</span><br><span class="line">            <span class="keyword">final</span> DefaultHandle[] srcElems = head.elements;</span><br><span class="line">            <span class="keyword">final</span> DefaultHandle[] dstElems = dst.elements;</span><br><span class="line">            <span class="keyword">int</span> newDstSize = dstSize;</span><br><span class="line">           	<span class="comment">// 进行对象转移</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = srcStart; i &lt; srcEnd; i++) &#123;</span><br><span class="line">                DefaultHandle element = srcElems[i];</span><br><span class="line">              	<span class="comment">// 表明自己还没有被任何一个 Stack 所回收</span></span><br><span class="line">                <span class="keyword">if</span> (element.recycleId == <span class="number">0</span>) &#123;</span><br><span class="line">                    element.recycleId = element.lastRecycledId;</span><br><span class="line">                  <span class="comment">// 避免对象重复回收</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.recycleId != element.lastRecycledId) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"recycled already"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                element.stack = dst;</span><br><span class="line">                dstElems[newDstSize++] = element;</span><br><span class="line">                <span class="comment">// 设置为null，清楚暂存的handler信息，同时帮助 GC</span></span><br><span class="line">                srcElems[i] = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dst.size = newDstSize;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (srcEnd == LINK_CAPACITY &amp;&amp; head.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.head = head.next;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置读指针位置</span></span><br><span class="line">            head.readIndex = srcEnd;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// The destination stack is full already.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="再次回到获取对象的操作"><a href="#再次回到获取对象的操作" class="headerlink" title="再次回到获取对象的操作"></a>再次回到获取对象的操作</h5><p>既然之前说到了延迟回收，已经会将<code>WeakOrderQueue</code>中的对象转移到<code>Stack&lt;T&gt;</code>栈中，那么这块是怎么做的？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DefaultHandle <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> size = <span class="keyword">this</span>.size;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">      	<span class="comment">// 当 Stack&lt;T&gt; 此时的容量为 0 时，去 WeakOrder 中转移部分对象到 Stack 中</span></span><br><span class="line">        <span class="keyword">if</span> (!scavenge()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        size = <span class="keyword">this</span>.size;</span><br><span class="line">    &#125;</span><br><span class="line">    size--;</span><br><span class="line">    DefaultHandle ret = elements[size];</span><br><span class="line">  	<span class="comment">// 该对象被重复回收了</span></span><br><span class="line">    <span class="keyword">if</span> (ret.lastRecycledId != ret.recycleId) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"recycled multiple times"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ret.recycleId = <span class="number">0</span>;</span><br><span class="line">    ret.lastRecycledId = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.size = size;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">scavenge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// continue an existing scavenge, if any</span></span><br><span class="line">  	<span class="comment">// 扫描判断是否存在可转移的 Handler</span></span><br><span class="line">    <span class="keyword">if</span> (scavengeSome()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset our scavenge cursor</span></span><br><span class="line">  	<span class="comment">// 如果本次扫描失败，则代表该节点及之前的节点都没有可回收的Handler了，将自己</span></span><br><span class="line">    <span class="comment">// 的 WeakOrderQueue 指针进行向后移动一个节点</span></span><br><span class="line">    prev = <span class="keyword">null</span>;</span><br><span class="line">    cursor = head;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">scavengeSome</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    WeakOrderQueue cursor = <span class="keyword">this</span>.cursor;</span><br><span class="line">    <span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cursor = head;</span><br><span class="line">        <span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    WeakOrderQueue prev = <span class="keyword">this</span>.prev;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 从当前的WeakOrderQueue节点进行 handler 的转移</span></span><br><span class="line">        <span class="keyword">if</span> (cursor.transfer(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WeakOrderQueue next = cursor.next;</span><br><span class="line">        <span class="comment">// 如果 WeakOrderQueue 的实际持有线程因GC回收了</span></span><br><span class="line">        <span class="keyword">if</span> (cursor.owner.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// If the thread associated with the queue is gone, unlink it, after</span></span><br><span class="line">            <span class="comment">// performing a volatile read to confirm there is no data left to collect.</span></span><br><span class="line">            <span class="comment">// We never unlink the first queue, as we don't want to synchronize on updating the head.</span></span><br><span class="line">            <span class="keyword">if</span> (cursor.hasFinalData()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cursor.transfer(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                        success = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</span><br><span class="line">                prev.next = next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            prev = cursor;</span><br><span class="line">        &#125;</span><br><span class="line">        cursor = next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (cursor != <span class="keyword">null</span> &amp;&amp; !success);</span><br><span class="line">    <span class="keyword">this</span>.prev = prev;</span><br><span class="line">    <span class="keyword">this</span>.cursor = cursor;</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="如何模拟一个对象被多个Stack-lt-T-gt-回收的用例"><a href="#如何模拟一个对象被多个Stack-lt-T-gt-回收的用例" class="headerlink" title="如何模拟一个对象被多个Stack&lt;T&gt;回收的用例"></a>如何模拟一个对象被多个<code>Stack&lt;T&gt;</code>回收的用例</h5><p>关于一个<code>DefaultHandler</code>在什么情况下会出现多次回收的情况，目前只想到一个点</p>
<blockquote>
<p><code>DefaultHandler</code>的<code>recycle</code>方法被在不同的线程执行了两次，第一次执行方法时，正常走流程进入延迟回收队列；当第二次执行方法时，巧的时，第一次方法执行时进入的延迟队列<code>WeakOrderQueue</code>正好被某一个<code>Stack&lt;T&gt;</code>执行了转移操作（将对象从<code>WeakOrderQueue</code>转移到<code>Stack&lt;T&gt;</code>中），这个时候主要看这两个方法</p>
</blockquote>
<blockquote>
<p>线程A——第一次<code>recycle</code>方法执行被回收到的<code>WeakOrderQueue</code>此时被<code>Stack&lt;T&gt;</code>执行转移操作</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (element.recycleId == <span class="number">0</span>) &#123;</span><br><span class="line">    element.recycleId = element.lastRecycledId;	——&gt; 	first</span><br><span class="line">    <span class="comment">// 避免对象重复回收</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.recycleId != element.lastRecycledId) &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"recycled already"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>线程B——第二次<code>recycle</code>方法执行，此时正在进入<code>WeakOrderQueue</code>队列</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意，此时的 handle.recycledId == 0，因为执行pop时recycleId被重置为0了</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(DefaultHandle handle)</span> </span>&#123;</span><br><span class="line">    handle.lastRecycledId = id;	——&gt;	 second</span><br><span class="line">    Link tail = <span class="keyword">this</span>.tail;</span><br><span class="line">    <span class="keyword">int</span> writeIndex;</span><br><span class="line">    <span class="keyword">if</span> ((writeIndex = tail.get()) == LINK_CAPACITY) &#123;</span><br><span class="line">        <span class="keyword">this</span>.tail = tail = tail.next = <span class="keyword">new</span> Link();</span><br><span class="line">        writeIndex = tail.get();</span><br><span class="line">    &#125;</span><br><span class="line">    tail.elements[writeIndex] = handle;</span><br><span class="line">    handle.stack = <span class="keyword">null</span>;</span><br><span class="line">    tail.lazySet(writeIndex + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候问题就来了，当线程A执行到<code>first</code>时，而线程B正在执行<code>recycle</code>操作，当<code>first</code>处函数执行完毕时，此时的<code>DefaultHandler</code>的两个<code>id</code>信息如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">recycledId=&#123;thread-A&#125;</span><br><span class="line">lastRecycledId=&#123;thread-A&#125;</span><br></pre></td></tr></table></figure>
<p>而这个时候，马上切换到<code>second</code>处，此时的<code>DefaultHandler</code>的两个<code>id</code>信息如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">recycledId=&#123;thread-A&#125;</span><br><span class="line">lastRecycledId=&#123;thread-B&#125;</span><br></pre></td></tr></table></figure>
<p>因此，就导致了一个线程被两次重复<code>recycle</code>的现象</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/08/03/leetcode-28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/03/leetcode-28/" class="post-title-link" itemprop="url">leetcode-求x的开平方</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-03 18:11:58" itemprop="dateCreated datePublished" datetime="2019-08-03T18:11:58+08:00">2019-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-08-17 16:46:45" itemprop="dateModified" datetime="2019-08-17T16:46:45+08:00">2019-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LeetCode/" itemprop="url" rel="index"><span itemprop="name">LeetCode</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h4><blockquote>
<p>实现 <code>int sqrt(int x)</code> 函数。</p>
<p>计算并返回 <em>x</em> 的平方根，其中 <em>x</em> 是非负整数。</p>
<p>由于返回类型是整数，结果只保留整数的部分，小数部分将被舍去。</p>
<p><strong>示例 1:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; 输入: 4</span><br><span class="line">&gt; 输出: 2</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>示例 2:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; 输入: 8</span><br><span class="line">&gt; 输出: 2</span><br><span class="line">&gt; 说明: 8 的平方根是 2.82842..., </span><br><span class="line">&gt;      由于返回类型是整数，小数部分将被舍去。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><h5 id="Java实现"><a href="#Java实现" class="headerlink" title="Java实现"></a>Java实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">mySqrt</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> right = x / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (left &lt;= right) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> result = x / mid;</span><br><span class="line">            <span class="keyword">if</span> (result == mid) &#123;</span><br><span class="line">                <span class="keyword">return</span> mid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result &lt; mid) &#123;</span><br><span class="line">                right = mid - <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                left = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> x / left &lt; left ? left - <span class="number">1</span> : left;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Python实现"><a href="#Python实现" class="headerlink" title="Python实现"></a>Python实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class Solution(object):</span><br><span class="line">    <span class="function">def <span class="title">mySqrt</span><span class="params">(self, x)</span>:</span></span><br><span class="line"><span class="function">        """</span></span><br><span class="line"><span class="function">        :type x: <span class="keyword">int</span></span></span><br><span class="line"><span class="function">        :rtype: <span class="keyword">int</span></span></span><br><span class="line"><span class="function">        """</span></span><br><span class="line"><span class="function">        l </span>= <span class="number">1</span></span><br><span class="line">        r = x</span><br><span class="line">        <span class="keyword">while</span> l &lt;= r:</span><br><span class="line">            mid = <span class="keyword">int</span>((l + r) / <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> mid * mid == x:</span><br><span class="line">                <span class="keyword">return</span> mid</span><br><span class="line">            elif mid * mid &lt; x:</span><br><span class="line">                l = mid + <span class="number">1</span></span><br><span class="line">            elif mid * mid &gt; x:</span><br><span class="line">                r = mid - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> l * l &gt; x:</span><br><span class="line">            <span class="keyword">return</span> l - <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> l</span><br></pre></td></tr></table></figure>
<h4 id="不同语言实现算法的注意点"><a href="#不同语言实现算法的注意点" class="headerlink" title="不同语言实现算法的注意点"></a>不同语言实现算法的注意点</h4><p>该问题，如果采用<code>Python</code>来实现的话，是不出现整数溢出的情况的，这里我直接给出一个测试用例，其中<code>mid * mid</code>的结果为<code>1152826965724840000</code></p>
<blockquote>
<p>x = 2147395599</p>
</blockquote>
<p>而如果采用<code>Java</code>语言去实现<code>Python</code>的该题解算法，会发现，当<code>x</code>变大时，结果基本是不正确的，进过调试才发现，由于采用<code>mid * mid</code>的方法去计算，极容易出现整数溢出的情况，导致进入错误的分支语句</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/07/30/java-web-50/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/30/java-web-50/" class="post-title-link" itemprop="url">JRaft 新节点加入后，如何追上旧节点的数据</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-30 18:33:09" itemprop="dateCreated datePublished" datetime="2019-07-30T18:33:09+08:00">2019-07-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-25 12:20:08" itemprop="dateModified" datetime="2020-02-25T12:20:08+08:00">2020-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JRaft/" itemprop="url" rel="index"><span itemprop="name">JRaft</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="JRaft"><a href="#JRaft" class="headerlink" title="JRaft"></a>JRaft</h4><p><code>JRaft</code>是蚂蚁金服开源的一个<code>Raft</code>协议的实现</p>
<p><a href="https://github.com/sofastack/sofa-jraft" target="_blank" rel="noopener">JRatf</a></p>
<h4 id="新节点如何追上旧节点"><a href="#新节点如何追上旧节点" class="headerlink" title="新节点如何追上旧节点"></a>新节点如何追上旧节点</h4><h5 id="官方wiki说明"><a href="#官方wiki说明" class="headerlink" title="官方wiki说明"></a>官方wiki说明</h5><blockquote>
<p>当一个 raft 节点重启的时候，内存中的状态机的状态将会丢失，在启动过程中将重放日志存储中的所有日志，重建整个状态机实例。这就导致两个问题：</p>
<ul>
<li>如果任务提交比较频繁，比如消息中间件这个场景，那么会导致整个重建过程很长，启动缓慢。</li>
<li>如果日志很多，节点需要存储所有的日志，这对存储是一个资源占用，不可持续。</li>
<li>如果增加一个节点，新节点需要从 leader 获取所有的日志重放到状态机，这对 leader 和网络带宽都是不小的负担。</li>
</ul>
<p>因此，通过引入 snapshot 机制来解决这 3 个问题，所谓 snapshot 就是为当前状态机的最新状态打一个”镜像“单独保存，在保存成功后，在这个时刻之前的日志就可以删除，减少了日志存储占用；启动的时候，可以直接加载最新的 snapshot 镜像，然后重放在此之后的日志即可，如果 snapshot 间隔合理，那么整个重放过程会比较快，加快了启动过程。最后，新节点的加入，可以先从 leader 拷贝最新的 snapshot 安装到本地状态机，然后只要拷贝后续的日志即可，可以快速跟上整个 raft group 的进度。</p>
</blockquote>
<h5 id="代码浅析"><a href="#代码浅析" class="headerlink" title="代码浅析"></a>代码浅析</h5><blockquote>
<p>Leader节点发送快照</p>
</blockquote>
<p>代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">sendEntries</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> nextSendingIndex)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> AppendEntriesRequest.Builder rb = AppendEntriesRequest.newBuilder();</span><br><span class="line">  <span class="comment">// 进行判断，Leader节点在logIndex为&#123;nextSendingIndex - 1&#125;时是否日志做过了snaphot</span></span><br><span class="line">	<span class="keyword">if</span> (!fillCommonFields(rb, nextSendingIndex - <span class="number">1</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">		<span class="comment">// unlock id in installSnapshot</span></span><br><span class="line">    <span class="comment">// 发起安装快照的请求</span></span><br><span class="line">		installSnapshot();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ByteBufferCollector dataBuf = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> maxEntriesSize = <span class="keyword">this</span>.raftOptions.getMaxEntriesSize();</span><br><span class="line">	<span class="keyword">final</span> RecyclableByteBufferList byteBufList = RecyclableByteBufferList.newInstance();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Leader将自己的日志发送给Follower节点</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxEntriesSize; i++) &#123;</span><br><span class="line">			<span class="keyword">final</span> RaftOutter.EntryMeta.Builder emb = RaftOutter.EntryMeta.newBuilder();</span><br><span class="line">			<span class="keyword">if</span> (!prepareEntry(nextSendingIndex, i, emb, byteBufList)) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			rb.addEntries(emb.build());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (rb.getEntriesCount() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果出现日志断节，则直接发送快照</span></span><br><span class="line">			<span class="keyword">if</span> (nextSendingIndex &lt; <span class="keyword">this</span>.options.getLogManager().getFirstLogIndex()) &#123;</span><br><span class="line">				installSnapshot();</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// _id is unlock in _wait_more</span></span><br><span class="line">			waitMoreEntries(nextSendingIndex);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (byteBufList.getCapacity() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			dataBuf = ByteBufferCollector.allocateByRecyclers(byteBufList.getCapacity());</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">final</span> ByteBuffer b : byteBufList) &#123;</span><br><span class="line">				dataBuf.put(b);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">final</span> ByteBuffer buf = dataBuf.getBuffer();</span><br><span class="line">			buf.flip();</span><br><span class="line">			rb.setData(ZeroByteStringHelper.wrap(buf));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 回收对象到对象池</span></span><br><span class="line">		RecycleUtil.recycle(byteBufList);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 AppendEntries RPC 的请求体信息</span></span><br><span class="line">	<span class="keyword">final</span> AppendEntriesRequest request = rb.build();</span><br><span class="line">	<span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">		LOG.debug(<span class="string">"Node &#123;&#125; send AppendEntriesRequest to &#123;&#125; term &#123;&#125; lastCommittedIndex &#123;&#125; prevLogIndex &#123;&#125; prevLogTerm &#123;&#125; logIndex &#123;&#125; count &#123;&#125;"</span>, <span class="keyword">this</span>.options.getNode().getNodeId(), <span class="keyword">this</span>.options.getPeerId(), <span class="keyword">this</span>.options.getTerm(), request.getCommittedIndex(), request.getPrevLogIndex(), request.getPrevLogTerm(), nextSendingIndex, request.getEntriesCount());</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 设置该 Node 节点的状态标识</span></span><br><span class="line">	<span class="keyword">this</span>.statInfo.runningState = RunningState.APPENDING_ENTRIES;</span><br><span class="line">  <span class="comment">// 设置当前节点的 LogIndex信息</span></span><br><span class="line">	<span class="keyword">this</span>.statInfo.firstLogIndex = rb.getPrevLogIndex() + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">this</span>.statInfo.lastLogIndex = rb.getPrevLogIndex() + rb.getEntriesCount();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> Recyclable recyclable = dataBuf;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> v = <span class="keyword">this</span>.version;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> monotonicSendTimeMs = Utils.monotonicMs();</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> seq = getAndIncrementReqSeq();</span><br><span class="line">  <span class="comment">// 发送 RPC 请求给 Follower 节点</span></span><br><span class="line">	<span class="keyword">final</span> Future&lt;Message&gt; rpcFuture = <span class="keyword">this</span>.rpcService.appendEntries(<span class="keyword">this</span>.options.getPeerId().getEndpoint(),</span><br><span class="line">            request, -<span class="number">1</span>, <span class="keyword">new</span> RpcResponseClosureAdapter&lt;AppendEntriesResponse&gt;() &#123;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> Status status)</span> </span>&#123;</span><br><span class="line">					RecycleUtil.recycle(recyclable);</span><br><span class="line">					onRpcReturned(Replicator.<span class="keyword">this</span>.id, RequestType.AppendEntries, status, request, getResponse(), seq, v, monotonicSendTimeMs);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">	&#125;);</span><br><span class="line">	addInflight(RequestType.AppendEntries, nextSendingIndex, request.getEntriesCount(), request.getData().size(), seq, rpcFuture);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>装填请求参数信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fillCommonFields</span><span class="params">(<span class="keyword">final</span> AppendEntriesRequest.Builder rb, <span class="keyword">long</span> prevLogIndex, <span class="keyword">final</span> <span class="keyword">boolean</span> isHeartbeat)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> prevLogTerm = <span class="keyword">this</span>.options.getLogManager().getTerm(prevLogIndex);</span><br><span class="line">	 <span class="comment">// 如果出现 preLogTerm == 0 的情况，说明执行过 snapshot 操作</span></span><br><span class="line">	<span class="keyword">if</span> (prevLogTerm == <span class="number">0</span> &amp;&amp; prevLogIndex != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isHeartbeat) &#123;</span><br><span class="line">			Requires.requireTrue(prevLogIndex &lt; <span class="keyword">this</span>.options.getLogManager().getFirstLogIndex());</span><br><span class="line">			LOG.debug(<span class="string">"logIndex=&#123;&#125; was compacted"</span>, prevLogIndex);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// The log at prev_log_index has been compacted, which indicates</span></span><br><span class="line">			<span class="comment">// we is or is going to install snapshot to the follower. So we let</span></span><br><span class="line">			<span class="comment">// both prev_log_index and prev_log_term be 0 in the heartbeat</span></span><br><span class="line">			<span class="comment">// request so that follower would do nothing besides updating its</span></span><br><span class="line">			<span class="comment">// leader timestamp.</span></span><br><span class="line">			prevLogIndex = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 设置请求属性信息</span></span><br><span class="line">	rb.setTerm(<span class="keyword">this</span>.options.getTerm());</span><br><span class="line">	rb.setGroupId(<span class="keyword">this</span>.options.getGroupId());</span><br><span class="line">	rb.setServerId(<span class="keyword">this</span>.options.getServerId().toString());</span><br><span class="line">	rb.setPeerId(<span class="keyword">this</span>.options.getPeerId().toString());</span><br><span class="line">	rb.setPrevLogIndex(prevLogIndex);</span><br><span class="line">	rb.setPrevLogTerm(prevLogTerm);</span><br><span class="line">	rb.setCommittedIndex(<span class="keyword">this</span>.options.getBallotBox().getLastCommittedIndex());</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着就是<code>Leader</code>节点将发起<code>AppendEntries RPC</code>请求了</p>
<blockquote>
<p>Follower节点接收快照</p>
</blockquote>
<p><em><code>NodeImpl</code>重要实现方法——<code>InstallSnapshotRequestProcessor</code></em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">handleInstallSnapshot</span><span class="params">(<span class="keyword">final</span> InstallSnapshotRequest request, <span class="keyword">final</span> RpcRequestClosure done)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果快照安装执行器不存在，则抛出异常不支持快照操作</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> RpcResponseFactory.newResponse(RaftError.EINVAL, <span class="string">"Not supported snapshot"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> PeerId serverId = <span class="keyword">new</span> PeerId();</span><br><span class="line">  <span class="comment">// 根据请求携带的 serverId 序列化 PeerId</span></span><br><span class="line">	<span class="keyword">if</span> (!serverId.parse(request.getServerId())) &#123;</span><br><span class="line">		LOG.warn(<span class="string">"Node &#123;&#125; ignore InstallSnapshotRequest from &#123;&#125; bad server id."</span>, getNodeId(), request.getServerId());</span><br><span class="line">		<span class="keyword">return</span> RpcResponseFactory.newResponse(RaftError.EINVAL, <span class="string">"Parse serverId failed: %s"</span>, request.getServerId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 判断当前节点的状态</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">			LOG.warn(<span class="string">"Node &#123;&#125; ignore InstallSnapshotRequest as it is not in active state &#123;&#125;."</span>, getNodeId(), <span class="keyword">this</span>.state);</span><br><span class="line">			<span class="keyword">return</span> RpcResponseFactory.newResponse(RaftError.EINVAL, <span class="string">"Node %s:%s is not in active state, state %s."</span>, <span class="keyword">this</span>.groupId, <span class="keyword">this</span>.serverId, <span class="keyword">this</span>.state.name());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断 request 携带的 term 比当前节点的 trem，比较 term 的合法性</span></span><br><span class="line">		<span class="keyword">if</span> (request.getTerm() &lt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">			LOG.warn(<span class="string">"Node &#123;&#125; ignore stale InstallSnapshotRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;."</span>, getNodeId(), request.getPeerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">			<span class="keyword">return</span> InstallSnapshotResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">                    .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">                    .setSuccess(<span class="keyword">false</span>) <span class="comment">//</span></span><br><span class="line">                    .build();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 做相关的检查处理</span></span><br><span class="line">    <span class="comment">// Leader的设置、中断之前的快照下载任务...</span></span><br><span class="line">		checkStepDown(request.getTerm(), serverId);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!serverId.equals(<span class="keyword">this</span>.leaderId)) &#123;</span><br><span class="line">			LOG.error(<span class="string">"Another peer &#123;&#125; declares that it is the leader at term &#123;&#125; which was occupied by leader &#123;&#125;."</span>, serverId, <span class="keyword">this</span>.currTerm, <span class="keyword">this</span>.leaderId);</span><br><span class="line">			<span class="comment">// Increase the term by 1 and make both leaders step down to minimize the</span></span><br><span class="line">			<span class="comment">// loss of split brain</span></span><br><span class="line">			stepDown(request.getTerm() + <span class="number">1</span>, <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.ELEADERCONFLICT,  <span class="string">"More than one leader in the same term."</span>));</span><br><span class="line">			<span class="keyword">return</span> InstallSnapshotResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">                    .setTerm(request.getTerm() + <span class="number">1</span>) <span class="comment">//</span></span><br><span class="line">                    .setSuccess(<span class="keyword">false</span>) <span class="comment">//</span></span><br><span class="line">                    .build();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (LOG.isInfoEnabled()) &#123;</span><br><span class="line">			LOG.info(</span><br><span class="line">                    <span class="string">"Node &#123;&#125; received InstallSnapshotRequest from &#123;&#125;, lastIncludedLogIndex=&#123;&#125;, lastIncludedLogTerm=&#123;&#125;, lastLogId=&#123;&#125;."</span>,</span><br><span class="line">                    getNodeId(), request.getServerId(), request.getMeta().getLastIncludedIndex(), request.getMeta()</span><br><span class="line">                        .getLastIncludedTerm(), <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">false</span>));</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// 执行快照安装</span></span><br><span class="line">		<span class="keyword">this</span>.snapshotExecutor.installSnapshot(request, InstallSnapshotResponse.newBuilder(), done);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.metrics.recordLatency(<span class="string">"install-snapshot"</span>, Utils.monotonicMs() - startMs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下载快照文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installSnapshot</span><span class="params">(<span class="keyword">final</span> InstallSnapshotRequest request, <span class="keyword">final</span> InstallSnapshotResponse.Builder response, <span class="keyword">final</span> RpcRequestClosure done)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> SnapshotMeta meta = request.getMeta();</span><br><span class="line">  <span class="comment">// 创建一个下载快照的任务对象</span></span><br><span class="line">	<span class="keyword">final</span> DownloadingSnapshot ds = <span class="keyword">new</span> DownloadingSnapshot(request, response, done);</span><br><span class="line">	<span class="comment">//DON'T access request, response, and done after this point</span></span><br><span class="line">	<span class="comment">//as the retry snapshot will replace this one.</span></span><br><span class="line">  <span class="comment">// 将下载快照任务进行注册，同时会设置 this.curCopier 为 Future对象</span></span><br><span class="line">	<span class="keyword">if</span> (!registerDownloadingSnapshot(ds)) &#123;</span><br><span class="line">		LOG.warn(<span class="string">"Fail to register downloading snapshot"</span>);</span><br><span class="line">		<span class="comment">// This RPC will be responded by the previous session</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Requires.requireNonNull(<span class="keyword">this</span>.curCopier, <span class="string">"curCopier"</span>);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 阻塞等待 copy 任务完成</span></span><br><span class="line">		<span class="keyword">this</span>.curCopier.join();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">    <span class="comment">// 中断补偿，如果 curCopier 任务被中断过，表明有更新的 snapshot 在接受了，旧的 snapshot 被停止下载</span></span><br><span class="line">		Thread.currentThread().interrupt();</span><br><span class="line">		LOG.warn(<span class="string">"Install snapshot copy job was canceled."</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 装载下载好的 snapshot 文件</span></span><br><span class="line">	loadDownloadingSnapshot(ds, meta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载下载好的 snapshot 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadDownloadingSnapshot</span><span class="params">(<span class="keyword">final</span> DownloadingSnapshot ds, <span class="keyword">final</span> SnapshotMeta meta)</span> </span>&#123;</span><br><span class="line">	SnapshotReader reader;</span><br><span class="line">	<span class="keyword">this</span>.lock.lock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取快照任务的结果，如果不相等则表示新的 snapshot 在接收</span></span><br><span class="line">		<span class="keyword">if</span> (ds != <span class="keyword">this</span>.downloadingSnapshot.get()) &#123;</span><br><span class="line">			<span class="comment">//It is interrupted and response by other request,just return</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Requires.requireNonNull(<span class="keyword">this</span>.curCopier, <span class="string">"curCopier"</span>);</span><br><span class="line">		reader = <span class="keyword">this</span>.curCopier.getReader();</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.curCopier.isOk()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.curCopier.getCode() == RaftError.EIO.getNumber()) &#123;</span><br><span class="line">				reportError(<span class="keyword">this</span>.curCopier.getCode(), <span class="keyword">this</span>.curCopier.getErrorMsg());</span><br><span class="line">			&#125;</span><br><span class="line">			Utils.closeQuietly(reader);</span><br><span class="line">			ds.done.run(<span class="keyword">this</span>.curCopier);</span><br><span class="line">			Utils.closeQuietly(<span class="keyword">this</span>.curCopier);</span><br><span class="line">			<span class="keyword">this</span>.curCopier = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">this</span>.downloadingSnapshot.set(<span class="keyword">null</span>);</span><br><span class="line">			<span class="keyword">this</span>.runningJobs.countDown();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Utils.closeQuietly(<span class="keyword">this</span>.curCopier);</span><br><span class="line">		<span class="keyword">this</span>.curCopier = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (reader == <span class="keyword">null</span> || !reader.isOk()) &#123;</span><br><span class="line">			Utils.closeQuietly(reader);</span><br><span class="line">			<span class="keyword">this</span>.downloadingSnapshot.set(<span class="keyword">null</span>);</span><br><span class="line">			ds.done.sendResponse(RpcResponseFactory.newResponse(RaftError.EINTERNAL, <span class="string">"Fail to copy snapshot from %s"</span>, ds.request.getUri()));</span><br><span class="line">			<span class="keyword">this</span>.runningJobs.countDown();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.loadingSnapshot = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">this</span>.loadingSnapshotMeta = meta;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.lock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 下载 snapshot 成功，进入状态机进行 snapshot 安装</span></span><br><span class="line">	<span class="keyword">final</span> InstallSnapshotDone installSnapshotDone = <span class="keyword">new</span> InstallSnapshotDone(reader);</span><br><span class="line">  <span class="comment">// 送入状态机执行快照安装事件</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.fsmCaller.onSnapshotLoad(installSnapshotDone)) &#123;</span><br><span class="line">		LOG.warn(<span class="string">"Fail to  call fsm onSnapshotLoad"</span>);</span><br><span class="line">		installSnapshotDone.run(<span class="keyword">new</span> Status(RaftError.EHOSTDOWN, <span class="string">"This raft node is down"</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发布、接收快照安装事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSnapshotLoad</span><span class="params">(<span class="keyword">final</span> LoadSnapshotClosure done)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 这里是用了 disruptor 队列来异步化 snapshot 快照事件操作</span></span><br><span class="line">	<span class="keyword">return</span> enqueueTask((task, sequence) -&gt; &#123;</span><br><span class="line">					task.type = TaskType.SNAPSHOT_LOAD;</span><br><span class="line">					task.done = done;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用事件处理器</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplyTaskHandler</span> <span class="keyword">implements</span> <span class="title">EventHandler</span>&lt;<span class="title">ApplyTask</span>&gt; </span>&#123;</span><br><span class="line">	<span class="comment">// max committed index in current batch, reset to -1 every batch</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> maxCommittedIndex = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> ApplyTask event, <span class="keyword">final</span> <span class="keyword">long</span> sequence, <span class="keyword">final</span> <span class="keyword">boolean</span> endOfBatch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 每次 apply task 时都更新最大提交索引记录</span></span><br><span class="line">		<span class="keyword">this</span>.maxCommittedIndex = runApplyTask(event, <span class="keyword">this</span>.maxCommittedIndex, endOfBatch);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>应用到状态机处理 snapshot load task 任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">runApplyTask</span><span class="params">(<span class="keyword">final</span> ApplyTask task, <span class="keyword">long</span> maxCommittedIndex, <span class="keyword">final</span> <span class="keyword">boolean</span> endOfBatch)</span> </span>&#123;</span><br><span class="line">	CountDownLatch shutdown = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// 判断任务类型</span></span><br><span class="line">	<span class="keyword">if</span> (task.type == TaskType.COMMITTED) &#123;</span><br><span class="line">		<span class="keyword">if</span> (task.committedIndex &gt; maxCommittedIndex) &#123;</span><br><span class="line">			maxCommittedIndex = task.committedIndex;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 快照任务</span></span><br><span class="line">		<span class="keyword">if</span> (maxCommittedIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.currTask = TaskType.COMMITTED;</span><br><span class="line">			<span class="comment">// 回放 snapshot 中不存在的 log， apply 到状态机</span></span><br><span class="line">			doCommitted(maxCommittedIndex);</span><br><span class="line">      <span class="comment">// 重置最大已提交索引，避免日志被重复回放</span></span><br><span class="line">			maxCommittedIndex = -<span class="number">1L</span>; <span class="comment">// reset maxCommittedIndex</span></span><br><span class="line">		&#125;</span><br><span class="line">    ...</span><br><span class="line">      <span class="keyword">case</span> SNAPSHOT_LOAD:</span><br><span class="line">				<span class="keyword">this</span>.currTask = TaskType.SNAPSHOT_LOAD;</span><br><span class="line">    		<span class="comment">// 预先判断状态机的状态信息</span></span><br><span class="line">				<span class="keyword">if</span> (passByStatus(task.done)) &#123;</span><br><span class="line">          <span class="comment">// 执行 snapshot load</span></span><br><span class="line">					doSnapshotLoad((LoadSnapshotClosure) task.done);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 同上，做日志回放的动作</span></span><br><span class="line">		<span class="keyword">if</span> (endOfBatch &amp;&amp; maxCommittedIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.currTask = TaskType.COMMITTED;</span><br><span class="line">			doCommitted(maxCommittedIndex);</span><br><span class="line">			maxCommittedIndex = -<span class="number">1L</span>; <span class="comment">// reset maxCommittedIndex</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.currTask = TaskType.IDLE;</span><br><span class="line">		<span class="keyword">return</span> maxCommittedIndex;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (shutdown != <span class="keyword">null</span>) &#123;</span><br><span class="line">			shutdown.countDown();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 snapshot load 操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSnapshotLoad</span><span class="params">(<span class="keyword">final</span> LoadSnapshotClosure done)</span> </span>&#123;</span><br><span class="line">	Requires.requireNonNull(done, <span class="string">"LoadSnapshotClosure is null"</span>);</span><br><span class="line">	<span class="keyword">final</span> SnapshotReader reader = done.start();</span><br><span class="line">	<span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">		done.run(<span class="keyword">new</span> Status(RaftError.EINVAL, <span class="string">"open SnapshotReader failed"</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 读取 snapshot 元数据信息</span></span><br><span class="line">	<span class="keyword">final</span> RaftOutter.SnapshotMeta meta = reader.load();</span><br><span class="line">	<span class="keyword">if</span> (meta == <span class="keyword">null</span>) &#123;</span><br><span class="line">		done.run(<span class="keyword">new</span> Status(RaftError.EINVAL, <span class="string">"SnapshotReader load meta failed"</span>));</span><br><span class="line">		<span class="keyword">if</span> (reader.getRaftError() == RaftError.EIO) &#123;</span><br><span class="line">			<span class="keyword">final</span> RaftException err = <span class="keyword">new</span> RaftException(EnumOutter.ErrorType.ERROR_TYPE_SNAPSHOT, RaftError.EIO, <span class="string">"Fail to load snapshot meta"</span>);</span><br><span class="line">			setError(err);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 获取最后一次 appliedId 信息</span></span><br><span class="line">	<span class="keyword">final</span> LogId lastAppliedId = <span class="keyword">new</span> LogId(<span class="keyword">this</span>.lastAppliedIndex.get(), <span class="keyword">this</span>.lastAppliedTerm);</span><br><span class="line">  <span class="comment">// 获取快照的 appliedId 信息</span></span><br><span class="line">	<span class="keyword">final</span> LogId snapshotId = <span class="keyword">new</span> LogId(meta.getLastIncludedIndex(), meta.getLastIncludedTerm());</span><br><span class="line">  <span class="comment">// 两个 id 信息进行比较，如果 apply id 大于 snapshot id，则该snapshot不合法，不会被使用</span></span><br><span class="line">	<span class="keyword">if</span> (lastAppliedId.compareTo(snapshotId) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		done.run(<span class="keyword">new</span> Status(RaftError.ESTALE, <span class="string">"Loading a stale snapshot last_applied_index=%d last_applied_term=%d snapshot_index=%d snapshot_term=%d"</span>, lastAppliedId.getIndex(), lastAppliedId.getTerm(), snapshotId.getIndex(), snapshotId.getTerm()));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 由用户实现的状态机执行 snapshot load</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.fsm.onSnapshotLoad(reader)) &#123;</span><br><span class="line">		done.run(<span class="keyword">new</span> Status(-<span class="number">1</span>, <span class="string">"StateMachine onSnapshotLoad failed"</span>));</span><br><span class="line">		<span class="keyword">final</span> RaftException e = <span class="keyword">new</span> RaftException(EnumOutter.ErrorType.ERROR_TYPE_STATE_MACHINE, RaftError.ESTATEMACHINE, <span class="string">"StateMachine onSnapshotLoad failed"</span>);</span><br><span class="line">		setError(e);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta.getOldPeersCount() == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// Joint stage is not supposed to be noticeable by end users.</span></span><br><span class="line">		<span class="keyword">final</span> Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = meta.getPeersCount(); i &lt; size; i++) &#123;</span><br><span class="line">			<span class="keyword">final</span> PeerId peer = <span class="keyword">new</span> PeerId();</span><br><span class="line">			Requires.requireTrue(peer.parse(meta.getPeers(i)), <span class="string">"Parse peer failed"</span>);</span><br><span class="line">			conf.addPeer(peer);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.fsm.onConfigurationCommitted(conf);</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 设置最新的提交索引，以便日志回放时对不存在日志执行 apply 操作</span></span><br><span class="line">	<span class="keyword">this</span>.lastAppliedIndex.set(meta.getLastIncludedIndex());</span><br><span class="line">  <span class="comment">// 设置新的节点所在任期</span></span><br><span class="line">	<span class="keyword">this</span>.lastAppliedTerm = meta.getLastIncludedTerm();</span><br><span class="line">	done.run(Status.OK());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>snapshot load操作完成后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onSnapshotLoadDone</span><span class="params">(<span class="keyword">final</span> Status st)</span> </span>&#123;</span><br><span class="line">	DownloadingSnapshot m;</span><br><span class="line">	<span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">this</span>.lock.lock();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Requires.requireTrue(<span class="keyword">this</span>.loadingSnapshot, <span class="string">"Not loading snapshot"</span>);</span><br><span class="line">		m = <span class="keyword">this</span>.downloadingSnapshot.get();</span><br><span class="line">		<span class="keyword">if</span> (st.isOk()) &#123;</span><br><span class="line">      <span class="comment">// 更改最新一次快照的index信息</span></span><br><span class="line">			<span class="keyword">this</span>.lastSnapshotIndex = <span class="keyword">this</span>.loadingSnapshotMeta.getLastIncludedIndex();</span><br><span class="line">      <span class="comment">// 记录最新一次快照的任期</span></span><br><span class="line">			<span class="keyword">this</span>.lastSnapshotTerm = <span class="keyword">this</span>.loadingSnapshotMeta.getLastIncludedTerm();</span><br><span class="line">			doUnlock = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">this</span>.lock.unlock();</span><br><span class="line">      <span class="comment">// logManager 设置 snapshot 元数据信息</span></span><br><span class="line">			<span class="keyword">this</span>.logManager.setSnapshot(<span class="keyword">this</span>.loadingSnapshotMeta); <span class="comment">//should be out of lock</span></span><br><span class="line">			doUnlock = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">this</span>.lock.lock();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.node != <span class="keyword">null</span>) &#123;</span><br><span class="line">			sb.append(<span class="string">"Node "</span>).append(<span class="keyword">this</span>.node.getNodeId()).append(<span class="string">" "</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		sb.append(<span class="string">"onSnapshotLoadDone, "</span>).append(<span class="keyword">this</span>.loadingSnapshotMeta);</span><br><span class="line">		LOG.info(sb.toString());</span><br><span class="line">		doUnlock = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">this</span>.lock.unlock();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.node != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 在安装完 snapshot 后更新整个节点的配置信息</span></span><br><span class="line">			<span class="keyword">this</span>.node.updateConfigurationAfterInstallingSnapshot();</span><br><span class="line">		&#125;</span><br><span class="line">		doUnlock = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">this</span>.lock.lock();</span><br><span class="line">    <span class="comment">// 快照任务状态设置结束</span></span><br><span class="line">		<span class="keyword">this</span>.loadingSnapshot = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 快照下载任务置为null，标识任务成功</span></span><br><span class="line">		<span class="keyword">this</span>.downloadingSnapshot.set(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">			<span class="keyword">this</span>.lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (m != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Respond RPC</span></span><br><span class="line">		<span class="keyword">if</span> (!st.isOk()) &#123;</span><br><span class="line">			m.done.run(st);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      m.responseBuilder.setSuccess(<span class="keyword">true</span>);</span><br><span class="line">			m.done.sendResponse(m.responseBuilder.build());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">this</span>.runningJobs.countDown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现日志回放操作（如果接受快照的节点，存在日志缺省的情况，通过日志回放操作补全 logEntry）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doCommitted</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> committedIndex)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.error.getStatus().isOk()) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 获取最后一次的 apply id</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> lastAppliedIndex = <span class="keyword">this</span>.lastAppliedIndex.get();</span><br><span class="line">	<span class="comment">// We can tolerate the disorder of committed_index</span></span><br><span class="line">  <span class="comment">// 不存在日志缺省</span></span><br><span class="line">	<span class="keyword">if</span> (lastAppliedIndex &gt;= committedIndex) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> List&lt;Closure&gt; closures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">final</span> List&lt;TaskClosure&gt; taskClosures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">long</span> firstClosureIndex = <span class="keyword">this</span>.closureQueue.popClosureUntil(committedIndex, closures, taskClosures);</span><br><span class="line">		<span class="comment">// Calls TaskClosure#onCommitted if necessary</span></span><br><span class="line">		onTaskCommitted(taskClosures);</span><br><span class="line"></span><br><span class="line">		Requires.requireTrue(firstClosureIndex &gt;= <span class="number">0</span>, <span class="string">"Invalid firstClosureIndex"</span>);</span><br><span class="line">    <span class="comment">// 创建 LogEntry 迭代器，从 lastAppliedIndex 到 committedIndex之间缺省的日志会被重新回放</span></span><br><span class="line">		<span class="keyword">final</span> IteratorImpl iterImpl = <span class="keyword">new</span> IteratorImpl(<span class="keyword">this</span>.fsm, <span class="keyword">this</span>.logManager, closures, firstClosureIndex, lastAppliedIndex, committedIndex, <span class="keyword">this</span>.applyingIndex);</span><br><span class="line">    <span class="comment">// 是否可以继续</span></span><br><span class="line">		<span class="keyword">while</span> (iterImpl.isGood()) &#123;</span><br><span class="line">			<span class="keyword">final</span> LogEntry logEntry = iterImpl.entry();</span><br><span class="line">			<span class="keyword">if</span> (logEntry.getType() != EnumOutter.EntryType.ENTRY_TYPE_DATA) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logEntry.getType() == EnumOutter.EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logEntry.getOldPeers() != <span class="keyword">null</span> &amp;&amp; !logEntry.getOldPeers().isEmpty()) &#123;</span><br><span class="line">						<span class="comment">// Joint stage is not supposed to be noticeable by end users.</span></span><br><span class="line">						<span class="keyword">this</span>.fsm.onConfigurationCommitted(<span class="keyword">new</span> Configuration(iterImpl.entry().getPeers()));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (iterImpl.done() != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">// For other entries, we have nothing to do besides flush the</span></span><br><span class="line">					<span class="comment">// pending tasks and run this closure to notify the caller that the</span></span><br><span class="line">					<span class="comment">// entries before this one were successfully committed and applied.</span></span><br><span class="line">					iterImpl.done().run(Status.OK());</span><br><span class="line">				&#125;</span><br><span class="line">				iterImpl.next();</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 用户态数据，转交给用户态的状态机去 apply LogEntry</span></span><br><span class="line">			<span class="comment">// Apply data task to user state machine</span></span><br><span class="line">			doApplyTasks(iterImpl);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (iterImpl.hasError()) &#123;</span><br><span class="line">			setError(iterImpl.getError());</span><br><span class="line">			iterImpl.runTheRestClosureWithError();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">long</span> lastIndex = iterImpl.getIndex() - <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">long</span> lastTerm = <span class="keyword">this</span>.logManager.getTerm(lastIndex);</span><br><span class="line">		<span class="keyword">final</span> LogId lastAppliedId = <span class="keyword">new</span> LogId(lastIndex, lastTerm);</span><br><span class="line">    <span class="comment">// 重新设置最新 apply id 信息</span></span><br><span class="line">		<span class="keyword">this</span>.lastAppliedIndex.set(committedIndex);</span><br><span class="line">    <span class="comment">// 更新最新任期信息</span></span><br><span class="line">		<span class="keyword">this</span>.lastAppliedTerm = lastTerm;</span><br><span class="line">		<span class="keyword">this</span>.logManager.setAppliedId(lastAppliedId);</span><br><span class="line">		notifyLastAppliedIndexUpdated(committedIndex);</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">"fsm-commit"</span>, Utils.monotonicMs() - startMs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/07/28/java-web-49/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/28/java-web-49/" class="post-title-link" itemprop="url">ScheduledThreadPoolExecutor 源码浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-28 14:31:12" itemprop="dateCreated datePublished" datetime="2019-07-28T14:31:12+08:00">2019-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-07-29 00:23:04" itemprop="dateModified" datetime="2019-07-29T00:23:04+08:00">2019-07-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java-web/" itemprop="url" rel="index"><span itemprop="name">java-web</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="ScheduledThreadPoolExecutor"><a href="#ScheduledThreadPoolExecutor" class="headerlink" title="ScheduledThreadPoolExecutor"></a>ScheduledThreadPoolExecutor</h4><p>该线层池其实使用的非常多了，基本遇到定时任务时，都会使用到此线程池来实现该需求，那么，这个线程池的实现是怎么样的呢？</p>
<h5 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h5><p><code>ScheduledThreadPoolExecutor</code>继承了<code>ThreadPoolExecutor</code>类以及实现了<code>ScheduledExecutorService</code>接口</p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScheduledThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize, ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS, <span class="keyword">new</span> DelayedWorkQueue(), threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该构造函数最终会直接调用父类的构造函数进行初始化，这里可以看到，这里线程池的最大线程数是<code>Integer.MAX_VALUE</code>的，以及设置了相应的其他参数，以及任务队列<code>DelayedWorkQueue</code>，该队列是实现定时任务的重点</p>
<h4 id="如何实现按时间进行任务调度"><a href="#如何实现按时间进行任务调度" class="headerlink" title="如何实现按时间进行任务调度"></a>如何实现按时间进行任务调度</h4><h5 id="ScheduledFutureTask"><a href="#ScheduledFutureTask" class="headerlink" title="ScheduledFutureTask"></a>ScheduledFutureTask</h5><p>在<code>ScheduledThreadPoolExecutor</code>中，定时任务被装饰成为<code>ScheduledFutureTask</code>对象，通过直接查看定时任务发布的代码可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="keyword">long</span> initialDelay, <span class="keyword">long</span> delay, TimeUnit unit) &#123;</span><br><span class="line">	<span class="keyword">if</span> (command == <span class="keyword">null</span> || unit == <span class="keyword">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">	<span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">	ScheduledFutureTask&lt;Void&gt; sft = <span class="keyword">new</span> ScheduledFutureTask&lt;Void&gt;(command,</span><br><span class="line">                                          <span class="keyword">null</span>,</span><br><span class="line">                                          triggerTime(initialDelay, unit),</span><br><span class="line">                                          unit.toNanos(-delay));</span><br><span class="line">	RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);</span><br><span class="line">	sft.outerTask = t;</span><br><span class="line">	delayedExecute(t);</span><br><span class="line">	<span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际的任务<code>command</code>被装饰为<code>ScheduledFutureTask</code>，如果该任务需要延迟执行，则由函数<code>triggerTime(initialDelay, unit)</code>来实现，并再次被装饰为<code>RunnableScheduledFuture</code>（这代码实际就是返回<code>sft</code>对象），然后进行周期任务的发布<code>delayedExecute(RunnableScheduledFuture)</code></p>
<p>现在来看看这个<code>ScheduledFutuerTask</code>对象的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledFutureTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">FutureTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">RunnableScheduledFuture</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Sequence number to break ties FIFO */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> sequenceNumber;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The time the task is enabled to execute in nanoTime units */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Period in nanoseconds for repeating tasks.  A positive</span></span><br><span class="line"><span class="comment">		* value indicates fixed-rate execution.  A negative value</span></span><br><span class="line"><span class="comment">		* indicates fixed-delay execution.  A value of 0 indicates a</span></span><br><span class="line"><span class="comment">		* non-repeating task.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> period;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The actual task to be re-enqueued by reExecutePeriodic */</span></span><br><span class="line">	RunnableScheduledFuture&lt;V&gt; outerTask = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Index into delay queue, to support faster cancellation.</span></span><br><span class="line"><span class="comment">		* 因为堆实际就是一个完全二叉树，因此完全可以用数组来实现，因此这个heapIndex我在一开始的时候</span></span><br><span class="line"><span class="comment">		* 认为它就是元素在数组的下标</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="keyword">int</span> heapIndex;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Creates a one-shot action with given nanoTime-based trigger time.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	ScheduledFutureTask(Runnable r, V result, <span class="keyword">long</span> ns) &#123;</span><br><span class="line">		<span class="keyword">super</span>(r, result);</span><br><span class="line">		<span class="keyword">this</span>.time = ns;</span><br><span class="line">		<span class="keyword">this</span>.period = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">this</span>.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Creates a periodic action with given nano time and period.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	ScheduledFutureTask(Runnable r, V result, <span class="keyword">long</span> ns, <span class="keyword">long</span> period) &#123;</span><br><span class="line">		<span class="keyword">super</span>(r, result);</span><br><span class="line">		<span class="keyword">this</span>.time = ns;</span><br><span class="line">		<span class="keyword">this</span>.period = period;</span><br><span class="line">		<span class="keyword">this</span>.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Creates a one-shot action with given nanoTime-based trigger time.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	ScheduledFutureTask(Callable&lt;V&gt; callable, <span class="keyword">long</span> ns) &#123;</span><br><span class="line">		<span class="keyword">super</span>(callable);</span><br><span class="line">		<span class="keyword">this</span>.time = ns;</span><br><span class="line">		<span class="keyword">this</span>.period = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">this</span>.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> unit.convert(time - now(), NANOSECONDS);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 优先队列需要比较元素的优先关系(即大小)，因此是定时任务，肯定是最近要执行的任务优先级越大</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed other)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (other == <span class="keyword">this</span>) <span class="comment">// compare zero if same object</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (other <span class="keyword">instanceof</span> ScheduledFutureTask) &#123;</span><br><span class="line">			ScheduledFutureTask&lt;?&gt; x = (ScheduledFutureTask&lt;?&gt;)other;</span><br><span class="line">			<span class="keyword">long</span> diff = time - x.time;</span><br><span class="line">			<span class="keyword">if</span> (diff &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (diff &gt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (sequenceNumber &lt; x.sequenceNumber)</span><br><span class="line">				<span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">long</span> diff = getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);</span><br><span class="line">		<span class="keyword">return</span> (diff &lt; <span class="number">0</span>) ? -<span class="number">1</span> : (diff &gt; <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Returns &#123;<span class="doctag">@code</span> true&#125; if this is a periodic (not a one-shot) action.</span></span><br><span class="line"><span class="comment">		*</span></span><br><span class="line"><span class="comment">		* <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if periodic</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPeriodic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> period != <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Sets the next time to run for a periodic task.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setNextRunTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">long</span> p = period;</span><br><span class="line">		<span class="keyword">if</span> (p &gt; <span class="number">0</span>)</span><br><span class="line">			time += p;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			time = triggerTime(-p);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> cancelled = <span class="keyword">super</span>.cancel(mayInterruptIfRunning);</span><br><span class="line">		<span class="keyword">if</span> (cancelled &amp;&amp; removeOnCancel &amp;&amp; heapIndex &gt;= <span class="number">0</span>)</span><br><span class="line">			remove(<span class="keyword">this</span>);</span><br><span class="line">		<span class="keyword">return</span> cancelled;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Overrides FutureTask version so as to reset/requeue if periodic.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 是否只执行一次</span></span><br><span class="line">		<span class="keyword">boolean</span> periodic = isPeriodic();</span><br><span class="line">		<span class="keyword">if</span> (!canRunInCurrentRunState(periodic))</span><br><span class="line">			cancel(<span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!periodic)</span><br><span class="line">      <span class="comment">// 如果是 one-shot任务，则直接运行</span></span><br><span class="line">			ScheduledFutureTask.<span class="keyword">super</span>.run();</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ScheduledFutureTask.<span class="keyword">super</span>.runAndReset()) &#123;</span><br><span class="line">      <span class="comment">// 计算下次任务的执行时间</span></span><br><span class="line">			setNextRunTime();</span><br><span class="line">      <span class="comment">// 重新压回任务队列，等待下次调度</span></span><br><span class="line">			reExecutePeriodic(outerTask);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，所有的任务被<code>ScheduledFutureTask</code>所装饰后，就带有了任务调度的时间信息以及任务的优先级</p>
<h5 id="核心——任务延迟队列DelayedWorkQueue"><a href="#核心——任务延迟队列DelayedWorkQueue" class="headerlink" title="核心——任务延迟队列DelayedWorkQueue"></a>核心——任务延迟队列<code>DelayedWorkQueue</code></h5><p><code>DelayedWorkQueue</code>是实现任务周期或者到期执行的关键实现，其本质是一个数组实现的无界的优先队列，并且带有阻塞功能（实现了<code>BlockingQueue</code>接口），因此之前前面的线程池初始化时，最大线程数设置为<code>Integer.MAX_VALUE</code>其实就没有用了，因此无界队列，永远不会出现任务进不了队列需要创建核心线层之外的线程进行任务的执行，因此<code>ScheduledThreadPoolExecutor</code>其实就是一个定长的线程池。</p>
<p>这里就给出<code>DelayedWorkQueue</code>的几个函数操作吧</p>
<blockquote>
<p>获取一个任务</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RunnableScheduledFuture&lt;?&gt; take() <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">	<span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">	lock.lockInterruptibly();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="comment">// 直接获取队列的首元素(到达被调度时间的任务)</span></span><br><span class="line">			RunnableScheduledFuture&lt;?&gt; first = queue[<span class="number">0</span>];</span><br><span class="line">      <span class="comment">// 首元素为空，则队列为空，需要等待队列中有元素</span></span><br><span class="line">			<span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">				available.await();</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取该任务的任务延迟时间</span></span><br><span class="line">				<span class="keyword">long</span> delay = first.getDelay(NANOSECONDS);</span><br><span class="line">        <span class="comment">// 已经到达时间了</span></span><br><span class="line">				<span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">return</span> finishPoll(first);</span><br><span class="line">				first = <span class="keyword">null</span>; <span class="comment">// don't retain ref while waiting</span></span><br><span class="line">				<span class="keyword">if</span> (leader != <span class="keyword">null</span>)</span><br><span class="line">					available.await();</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					Thread thisThread = Thread.currentThread();</span><br><span class="line">					leader = thisThread;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						available.awaitNanos(delay);</span><br><span class="line">					&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">							leader = <span class="keyword">null</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; queue[<span class="number">0</span>] != <span class="keyword">null</span>)</span><br><span class="line">				available.signal();</span><br><span class="line">		lock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>压入一个任务</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(Runnable x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (x == <span class="keyword">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">	RunnableScheduledFuture&lt;?&gt; e = (RunnableScheduledFuture&lt;?&gt;)x;</span><br><span class="line">	<span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">	lock.lock();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> i = size;</span><br><span class="line">			<span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">				grow();</span><br><span class="line">			size = i + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">				queue[<span class="number">0</span>] = e;</span><br><span class="line">				setIndex(e, <span class="number">0</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				siftUp(i, e);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (queue[<span class="number">0</span>] == e) &#123;</span><br><span class="line">				leader = <span class="keyword">null</span>;</span><br><span class="line">				available.signal();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			lock.unlock();</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="线程的Leader-Follower模式"><a href="#线程的Leader-Follower模式" class="headerlink" title="线程的Leader-Follower模式"></a>线程的<code>Leader-Follower</code>模式</h5><p>从上面的代码看到了一个有意思的地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread thisThread = Thread.currentThread();</span><br><span class="line">leader = thisThread;</span><br></pre></td></tr></table></figure>
<p>这里出现了一个<code>leader</code>，直接查看关于<code>Thread leader</code>的官方注解</p>
<blockquote>
<p>Thread designated to wait for the task at the head of the<br>queue.  This variant of the Leader-Follower pattern<br>(<a href="http://www.cs.wustl.edu/~schmidt/POSA/POSA2/" target="_blank" rel="noopener">http://www.cs.wustl.edu/~schmidt/POSA/POSA2/</a>) serves to<br>minimize unnecessary timed waiting.  When a thread becomes<br>the leader, it waits only for the next delay to elapse, but<br>other threads await indefinitely.  The leader thread must<br>signal some other thread before returning from take() or<br>poll(…), unless some other thread becomes leader in the<br>interim.  Whenever the head of the queue is replaced with a<br>task with an earlier expiration time, the leader field is<br>invalidated by being reset to null, and some waiting<br>thread, but not necessarily the current leader, is<br>signalled.  So waiting threads must be prepared to acquire<br>and lose leadership while waiting.</p>
</blockquote>
<p>可知，这是一种称为<code>Leader-Follower</code>的线程模式，该模式的优点就是减少了线程上下文的切换以及数据的拷贝。而<code>DelayedWorkQueue</code>就采用了这种模式来优化，再次来分析<code>take()</code>源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RunnableScheduledFuture&lt;?&gt; take() <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">	<span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">	lock.lockInterruptibly();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="comment">// 直接获取队列的首元素(到达被调度时间的任务)</span></span><br><span class="line">			RunnableScheduledFuture&lt;?&gt; first = queue[<span class="number">0</span>];</span><br><span class="line">      <span class="comment">// 首元素为空，则队列为空，需要等待队列中有元素</span></span><br><span class="line">			<span class="keyword">if</span> (first == <span class="keyword">null</span>)</span><br><span class="line">				available.await();</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取该任务的任务延迟时间</span></span><br><span class="line">				<span class="keyword">long</span> delay = first.getDelay(NANOSECONDS);</span><br><span class="line">        <span class="comment">// 已经到达时间了</span></span><br><span class="line">				<span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">return</span> finishPoll(first);</span><br><span class="line">				first = <span class="keyword">null</span>; <span class="comment">// don't retain ref while waiting</span></span><br><span class="line">        <span class="comment">// 是否存在 leader 线程，如果存在，则直接等待，</span></span><br><span class="line">				<span class="keyword">if</span> (leader != <span class="keyword">null</span>)</span><br><span class="line">					available.await();</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 不存在，则设置自己为 Leader 线程</span></span><br><span class="line">					Thread thisThread = Thread.currentThread();</span><br><span class="line">					leader = thisThread;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						available.awaitNanos(delay);</span><br><span class="line">					&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 自己是否成功成为了 leader 线程，如果成功，则将自己的 leader 属性置位 null</span></span><br><span class="line">						<span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">							leader = <span class="keyword">null</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; queue[<span class="number">0</span>] != <span class="keyword">null</span>)</span><br><span class="line">				available.signal();</span><br><span class="line">		lock.unlock();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，除了<code>leader</code>线程以外，以及正在处理任务的线层，其余的<code>follower</code>线程均处于等待状态，因此从成为<code>leader</code>线层开始，数据的监听到操作都由一个线程来完成，避免了频繁的线程上下文切换的开销</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/07/16/java-web-48/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/java-web-48/" class="post-title-link" itemprop="url">Nacos的地址服务器功能源码浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-16 12:50:07" itemprop="dateCreated datePublished" datetime="2019-07-16T12:50:07+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-07-26 17:55:13" itemprop="dateModified" datetime="2019-07-26T17:55:13+08:00">2019-07-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nacos/" itemprop="url" rel="index"><span itemprop="name">nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="地址服务模式"><a href="#地址服务模式" class="headerlink" title="地址服务模式"></a>地址服务模式</h4><p><code>nacos</code>官方有一个环境隔离实践的博文，在那篇博文中，阿里巴巴给出的例子是采用<code>nginx</code>以及一个组件实现根据客户端的<code>IP</code>信息路由到不同的<code>nacos</code>集群中去</p>
<p><a href="https://nacos.io/zh-cn/blog/address-server.html" target="_blank" rel="noopener">官方博文——阿里巴巴基于 Nacos 实现环境隔离的实践</a></p>
<h4 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h4><h5 id="地址服务器添加nacos-server节点"><a href="#地址服务器添加nacos-server节点" class="headerlink" title="地址服务器添加nacos-server节点"></a>地址服务器添加<code>nacos-server</code>节点</h5><p>根据官方的介绍，只需要发起一个<code>http</code>请求即可动态的添加<code>nacos-server</code>节点</p>
<blockquote>
<p><em># Add IP to nacos cluster:</em><br>curl -X POST ‘$ADDRESS_SERVER:8080/nacos/v1/as/nodes?ips=1.1.1.1:8848,2.2.2.2:8848,3.3.3.3:8848’</p>
<p><em># Remove IP from nacos cluster:</em></p>
<p>curl -X DELETE ‘$ADDRESS_SERVER:8080/nacos/v1/as/nodes?ips=1.1.1.1:8848,2.2.2.2:8848,3.3.3.3:8848’</p>
</blockquote>
<p>这里巧妙的复用了<code>nacos</code>中服务发现的功能，将<code>nacos-server</code>也作为一个服务注册到<code>nacos-server</code>上，这样就可以实现动态的管理<code>nacos</code>节点</p>
<blockquote>
<p>节点添加、删除源码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">""</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">postCluster</span><span class="params">(@RequestParam(required = <span class="keyword">false</span>)</span> String product,</span></span><br><span class="line"><span class="function">                                  @<span class="title">RequestParam</span><span class="params">(required = <span class="keyword">false</span>)</span> String cluster,</span></span><br><span class="line"><span class="function">                                  @<span class="title">RequestParam</span><span class="params">(name = <span class="string">"ips"</span>)</span> String ips) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//1. prepare the storage name for product and cluster</span></span><br><span class="line">	String productName = addressServerGeneratorManager.generateProductName(product);</span><br><span class="line">	String clusterName = addressServerManager.getDefaultClusterNameIfEmpty(cluster);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2. prepare the response name for product and cluster to client</span></span><br><span class="line">	String rawProductName = addressServerManager.getRawProductName(product);</span><br><span class="line">	String rawClusterName = addressServerManager.getRawClusterName(cluster);</span><br><span class="line">	Loggers.addressLogger.info(<span class="string">"put cluster node,the cluster name is "</span> + cluster + <span class="string">"; the product name="</span> + product + <span class="string">"; the ip list="</span> + ips);</span><br><span class="line">	ResponseEntity responseEntity;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		String serviceName = addressServerGeneratorManager.generateNacosServiceName(productName);</span><br><span class="line"></span><br><span class="line">		Cluster clusterObj = <span class="keyword">new</span> Cluster();</span><br><span class="line">		clusterObj.setName(clusterName);</span><br><span class="line">		clusterObj.setHealthChecker(<span class="keyword">new</span> AbstractHealthChecker.None());</span><br><span class="line">		serviceManager.createServiceIfAbsent(Constants.DEFAULT_NAMESPACE_ID, serviceName, <span class="keyword">false</span>, clusterObj);</span><br><span class="line">		String[] ipArray = addressServerManager.splitIps(ips);</span><br><span class="line">		String checkResult = AddressServerParamCheckUtil.checkIps(ipArray);</span><br><span class="line">		<span class="keyword">if</span> (AddressServerParamCheckUtil.CHECK_OK.equals(checkResult)) &#123;</span><br><span class="line">			List&lt;Instance&gt; instanceList = addressServerGeneratorManager.generateInstancesByIps(serviceName, rawProductName, clusterName, ipArray);</span><br><span class="line">			<span class="keyword">for</span> (Instance instance : instanceList) &#123;</span><br><span class="line">				serviceManager.registerInstance(Constants.DEFAULT_NAMESPACE_ID, serviceName, instance);</span><br><span class="line">			&#125;</span><br><span class="line">			responseEntity = ResponseEntity.ok(<span class="string">"product="</span> + rawProductName + <span class="string">",cluster="</span> + rawClusterName + <span class="string">"; put success with size="</span> + instanceList.size());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			responseEntity = ResponseEntity.status(HttpStatus.BAD_REQUEST).body(checkResult);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		responseEntity = ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(e.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> responseEntity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面这种操作以及<code>nacos</code>的服务数据同步，就可以将新增的<code>nacos-server</code>节点同步到所有的<code>nacos-server</code>节点上，并且依托<code>nacos</code>自带的健康检查功能，自动的判断不健康的<code>nacos-server</code>实例信息，这样，<code>nacos-client</code>只需要通过向地址服务器请求<code>nacos-server</code>这个服务，就可以自动的得知<code>nacos-server</code>节点变化的动态感知</p>
<h5 id="客户端请求nacos-server服务信息"><a href="#客户端请求nacos-server服务信息" class="headerlink" title="客户端请求nacos-server服务信息"></a>客户端请求<code>nacos-server</code>服务信息</h5><blockquote>
<p>请求源码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;product&#125;/&#123;cluster&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">getCluster</span><span class="params">(@PathVariable String product,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     @PathVariable String cluster)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	String productName = addressServerBuilderManager.generateProductName(product);</span><br><span class="line">	String serviceName = addressServerBuilderManager.generateNacosServiceName(productName);</span><br><span class="line">	Service service = serviceManager.getService(Constants.DEFAULT_NAMESPACE_ID, serviceName);</span><br><span class="line">	<span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND).body(<span class="string">"product="</span> + product + <span class="string">" not found."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!service.getClusterMap().containsKey(cluster)) &#123;</span><br><span class="line">		<span class="keyword">return</span> ResponseEntity.status(HttpStatus.NOT_FOUND).body(<span class="string">"product="</span> + product + <span class="string">",cluster="</span> + cluster + <span class="string">" not found."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Cluster clusterObj = service.getClusterMap().get(cluster);</span><br><span class="line">	<span class="keyword">return</span> ResponseEntity.status(HttpStatus.OK).body(addressServerBuilderManager.generateResponseIps(clusterObj.allIPs(<span class="keyword">false</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的实现非常简单，客户端仅仅需要像请求服务一样去请求<code>nacos-server</code>服务即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/07/16/java-web-47/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/16/java-web-47/" class="post-title-link" itemprop="url">手动实现一个简单的RPC框架</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-16 12:50:07" itemprop="dateCreated datePublished" datetime="2019-07-16T12:50:07+08:00">2019-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-07-22 16:53:28" itemprop="dateModified" datetime="2019-07-22T16:53:28+08:00">2019-07-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java-web/" itemprop="url" rel="index"><span itemprop="name">java-web</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h4><p>首先需要创建几个注解用于使用RPC</p>
<p><code>EnableTensorRPC</code> 开启RPC服务</p>
<p><code>RpcRegister</code> 将接口注册为一个服务</p>
<p><code>RpcService</code> 用于标注该接口是一个远程服务</p>
<h4 id="服务接口创建代理类"><a href="#服务接口创建代理类" class="headerlink" title="服务接口创建代理类"></a>服务接口创建代理类</h4><p>为了方便，我直接和<code>Spring</code>进行了整合，这里使用了<code>Spring</code>的回调接口<code>BeanPostProcessor</code>来进行上述三个注解的处理工作（当然目前这个很粗糙）</p>
<blockquote>
<p>处理 EnableTensorRPC 注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableTensorRPCBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        EnableTensorRPC rpc = bean.getClass().getAnnotation(EnableTensorRPC.class);</span><br><span class="line">        <span class="keyword">if</span> (rpc == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 初始化RPC服务信息</span></span><br><span class="line">            RpcApplication.init(rpc);</span><br><span class="line">          <span class="comment">// 如果自己是Provider，则会开启server，否则什么都不做</span></span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(rpc.type(), RpcType.PROVIDER)) &#123;</span><br><span class="line">                log.info(<span class="string">"[TENSOR RPC] work type is provider"</span>);</span><br><span class="line">                NettyServer.start(rpc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">"[TENSOR RPC] work type is consumer"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>BeanPostProcessor</code>主要的工作就是启动<code>rpc server</code>操作，因为可能项目既作为服务的提供者也作为服务的消费者，但是由于存在仅仅作为消费者的情况，因此做了一定的优化，根据参数来判断是否需要开启server</p>
<blockquote>
<p>处理 RpcRegister 注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcRegisterInjectBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口服务注册</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        Class cls = bean.getClass();</span><br><span class="line">        RpcRegister rpcRegister = (RpcRegister) cls.getAnnotation(RpcRegister.class);</span><br><span class="line">        <span class="keyword">if</span> (rpcRegister != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String serviceName = rpcRegister.serviceName();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为该接口服务创建一个方法签名信息</span></span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; registerType = rpcRegister.value();</span><br><span class="line"></span><br><span class="line">            String key = KeyBuilder.buildServiceKey(serviceName, rpcRegister.ip(), rpcRegister.port());</span><br><span class="line">          <span class="comment">// 注册服务者信息到ApplicationManager中</span></span><br><span class="line">ApplicationManager.getRpcInfoManager().providerRegister(registerType.getCanonicalName(), rpcRegister);</span><br><span class="line">            ApplicationManager.getNativeMethodManager().register(bean, cls);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>BeanPostProcessor</code>注解是处理对外暴露接口的，这里做的很简单，根据注解所标注的接口，为该接口创建一个签名然后放入一个本地方法池中，而目前的方法签名很简单，就是类的全路径名称</p>
<blockquote>
<p>处理 RpcService 注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcServiceInjectBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        Class&lt;?&gt; cls = bean.getClass();</span><br><span class="line">        rpcServiceInject(cls, bean);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接口进行代理，对接口的所有操作转为 RPC 远程调用操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cls &#123;<span class="doctag">@link</span> Class&#125; interface type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean &#123;<span class="doctag">@link</span> Object&#125; Spring's bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rpcServiceInject</span><span class="params">(Class cls, Object bean)</span> </span>&#123;</span><br><span class="line">        Field[] fields = cls.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (field.isAnnotationPresent(RpcService.class)) &#123;</span><br><span class="line">                RpcService rpcService = field.getAnnotation(RpcService.class);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 创建一个Proxy类进行接口的代理</span></span><br><span class="line">                    field.set(bean, RpcInjectProxy.inject(rpcService, field.getType()));</span><br><span class="line">                    ApplicationManager.getRpcInfoManager().consumerRegister(field.getType().getCanonicalName(), rpcService);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>BeanPostProcessor</code>注解是为远程接口创建一个代理类，当服务消费者调用远程接口服务时，实际是由代理类进行远程访问调用服务提供者的方法的</p>
<h4 id="如何正确进行方法的调用"><a href="#如何正确进行方法的调用" class="headerlink" title="如何正确进行方法的调用"></a>如何正确进行方法的调用</h4><p>当一个服务消费者调用远程服务时，首先来的是代理类的拦截方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcCGlibCallBackHandler</span> <span class="keyword">extends</span> <span class="title">AbstractRpcCallBackHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RpcCGlibCallBackHandler</span><span class="params">(String serviceName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceName = serviceName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Class&lt;?&gt; cls = method.getDeclaringClass();</span><br><span class="line">      <span class="comment">// 获取服务接口的注解信息(目的就是为了得知服务的接口的全信息，好做调用)</span></span><br><span class="line">        RpcService rpcService = ApplicationManager.getRpcInfoManager().getRpcService(cls.getCanonicalName());</span><br><span class="line">      <span class="comment">// 创建future进行异步RPC请求</span></span><br><span class="line">        RpcResult future = getMethodInvoker().invoke(methodRequest(cls.getCanonicalName(), method, args), rpcService);</span><br><span class="line">        <span class="keyword">return</span> future.result();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装本次RPC请求的信息，请求id、服务者key、请求方法、请求参数、返回类型</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RpcMethodRequest <span class="title">methodRequest</span><span class="params">(String className, Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">        String reqId = UUID.randomUUID().toString();</span><br><span class="line">        Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">        <span class="keyword">return</span> RpcMethodRequest.builder()</span><br><span class="line">                .reqId(reqId)</span><br><span class="line">                .ownerName(className)</span><br><span class="line">                .methodName(KeyBuilder.methodSign(method))</span><br><span class="line">                .param(args)</span><br><span class="line">                .returnType(returnType)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是进入方法调用链（用于判断走的是RPC还是Native），这里就给出走RPC时的方法吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcMethodExecutor</span> <span class="keyword">implements</span> <span class="title">MethodExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RpcMethodExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RpcResult <span class="title">invoke</span><span class="params">(Invoker invoker, MethodExecutorChain chain)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        RpcResult[] future = <span class="keyword">new</span> RpcResult[<span class="number">1</span>];</span><br><span class="line">        Mono.just(invoker)</span><br><span class="line">                .map(invoker1 -&gt; &#123;</span><br><span class="line">                    RpcMethodRequest request = invoker1.getRequest();</span><br><span class="line">                    <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"[RPC 调用过程出现异常！]"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Void.class.equals(request.getReturnType())) &#123;</span><br><span class="line">                        future[<span class="number">0</span>] = RpcResultPool.createFuture(request.getReqId(), <span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        future[<span class="number">0</span>] = RpcResultPool.createFuture(request.getReqId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> invoker1;</span><br><span class="line">                &#125;)</span><br><span class="line">                .publishOn(Schedulers.fromExecutor(RpcSchedule.RpcExecutor.RPC))</span><br><span class="line">                .subscribe(<span class="keyword">this</span>::sendRequest);</span><br><span class="line">        <span class="keyword">return</span> future[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">priority</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里会创建一个Netty channel连接(已做了优化，如果存在直接复用，不会每次请求都去创建)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(Invoker invoker)</span> </span>&#123;</span><br><span class="line">        RpcService rpcService = invoker.getService();</span><br><span class="line">        RpcMethodRequest request = invoker.getRequest();</span><br><span class="line">        String serviceName = rpcService.serviceName();</span><br><span class="line">        String ip = rpcService.ip();</span><br><span class="line">        <span class="keyword">int</span> port = rpcService.port();</span><br><span class="line">        Channel channel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel = NettyClient.getConnection(serviceName, ip, port);</span><br><span class="line">            channel.writeAndFlush(request).sync();</span><br><span class="line">          <span class="comment">// 归还本次使用的channel</span></span><br><span class="line">            NettyClient.release(channel, serviceName, ip, port);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着就是当<code>RPC</code>请求来到了服务提供者时怎么路由到方法了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeMethodExecutor</span> <span class="keyword">implements</span> <span class="title">MethodExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NativeMethodExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RpcResult <span class="title">invoke</span><span class="params">(Invoker invoker, MethodExecutorChain chain)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">      <span class="comment">// 本地方法</span></span><br><span class="line">        <span class="keyword">if</span> (invoker.isNative()) &#123;</span><br><span class="line">            <span class="keyword">return</span> innerExec(invoker.getRequest());</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// 远程RPC请求</span></span><br><span class="line">        <span class="keyword">if</span> (invoker.isRpcRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span> innerExec(invoker.getRequest(), invoker.getChannel());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.chain(invoker);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地方法直接调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg &#123;<span class="doctag">@link</span> RpcMethodRequest&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> RpcResult&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RpcResult <span class="title">innerExec</span><span class="params">(RpcMethodRequest msg)</span> </span>&#123;</span><br><span class="line">        RpcResult[] future = <span class="keyword">new</span> RpcResult[<span class="number">1</span>];</span><br><span class="line">        future[<span class="number">0</span>] = RpcResultPool.createFuture(msg.getReqId());</span><br><span class="line">        Mono.just(msg)</span><br><span class="line">          <span class="comment">// 切换执行的线程</span></span><br><span class="line">                .publishOn(Schedulers.fromExecutor(RpcSchedule.RpcExecutor.RPC))</span><br><span class="line">          <span class="comment">// 根据请求去获取一个Executor用于处理请求</span></span><br><span class="line">                .map(request -&gt;                   ApplicationManager.getNativeMethodManager().getExecutor(request.getOwnerName()))</span><br><span class="line">                .map(f -&gt; f.apply(msg))</span><br><span class="line">          <span class="comment">// 直接结束方法调用</span></span><br><span class="line">                .subscribe(rpcMethodResponse -&gt; future[<span class="number">0</span>].complete(rpcMethodResponse));</span><br><span class="line">        <span class="keyword">return</span> future[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于接收RPC Request请求，执行相应的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg &#123;<span class="doctag">@link</span> RpcMethodRequest&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel &#123;<span class="doctag">@link</span> Channel&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> RpcResult&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RpcResult <span class="title">innerExec</span><span class="params">(RpcMethodRequest msg, Channel channel)</span> </span>&#123;</span><br><span class="line">        Mono.just(msg)</span><br><span class="line">                .map(request -&gt; ApplicationManager.getNativeMethodManager().getExecutor(request.getOwnerName()))</span><br><span class="line">                .map(executor -&gt; executor)</span><br><span class="line">                .publishOn(Schedulers.fromExecutor(RpcSchedule.RpcExecutor.RPC))</span><br><span class="line">                .map(f -&gt; f.apply(msg))</span><br><span class="line">          <span class="comment">// RpcResponse对象写入channel中返回给调用者</span></span><br><span class="line">                .subscribe(channel::writeAndFlush);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">priority</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里其实就是用到了之前在创建请求时设置的接口全路径名了以及一个管理本地注册为服务的接口方法管理对象<code>ApplicationManager</code>了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RpcInfoManager RPC_INFO_MANAGER = <span class="keyword">new</span> RpcInfoManager();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> NativeMethodManager NATIVE_METHOD_MANAGER = <span class="keyword">new</span> NativeMethodManager();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcInfoManager <span class="title">getRpcInfoManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RPC_INFO_MANAGER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NativeMethodManager <span class="title">getNativeMethodManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NATIVE_METHOD_MANAGER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注解信息的管理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcInfoManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RpcInfoManager() &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, RpcService&gt; SERVICE_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, RpcRegister&gt; REGISTER_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerRegister</span><span class="params">(String key, RpcService value)</span> </span>&#123;</span><br><span class="line">            SERVICE_MAP.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">providerRegister</span><span class="params">(String key, RpcRegister value)</span> </span>&#123;</span><br><span class="line">            REGISTER_MAP.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RpcService <span class="title">getRpcService</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> SERVICE_MAP.get(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> RpcRegister <span class="title">getRpcRegister</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> REGISTER_MAP.get(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containRegisterInfo</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> REGISTER_MAP.containsKey(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NativeMethodManager</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, RegisterInfo&gt; METHOD_EXECUTOR = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        NativeMethodManager() &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 进行服务提供者注册，将服务提供者的所有方法信息进行注册到管理池中</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object owner, Class&lt;?&gt; cls)</span> </span>&#123;</span><br><span class="line">            Class[] interfaces = cls.getInterfaces();</span><br><span class="line">            <span class="keyword">for</span> (Class inter : interfaces) &#123;</span><br><span class="line">                METHOD_EXECUTOR.put(inter.getCanonicalName(), <span class="keyword">new</span> RegisterInfo(owner, inter));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Executor(METHOD_EXECUTOR.get(key));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 接口注册的信息，该接口下的所有方法信息</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            Object owner;</span><br><span class="line">            Map&lt;String, Method&gt; methodMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            RegisterInfo(Object owner, Class&lt;?&gt; cls) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.owner = owner;</span><br><span class="line"></span><br><span class="line">                Method[] methods = cls.getMethods();</span><br><span class="line">                <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                    methodMap.put(KeyBuilder.methodSign(method), method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function">Method <span class="title">getMethod</span><span class="params">(String sign)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> methodMap.get(sign);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Executor</span> <span class="keyword">implements</span> <span class="title">Function</span>&lt;<span class="title">RpcMethodRequest</span>, <span class="title">RpcMethodResponse</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">            RegisterInfo worker;</span><br><span class="line"></span><br><span class="line">            Executor(RegisterInfo worker) &#123;</span><br><span class="line">                <span class="keyword">this</span>.worker = worker;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> RpcMethodResponse <span class="title">apply</span><span class="params">(RpcMethodRequest request)</span> </span>&#123;</span><br><span class="line">                Exception err = <span class="keyword">null</span>;</span><br><span class="line">                Object result = <span class="keyword">new</span> Object();</span><br><span class="line">                <span class="keyword">if</span> (worker == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    err = <span class="keyword">new</span> Exception(<span class="string">"[Tensor RPC] : Not this function"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// 方法对象的获取</span></span><br><span class="line">                    Method method = worker.getMethod(request.getMethodName());</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        result = method.invoke(worker.owner, request.getParam());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException | InvocationTargetException e) &#123;</span><br><span class="line">                        err = e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">// 创建方法返回响应，会带请求id、返回对象序列化、返回错误信息</span></span><br><span class="line">                <span class="keyword">return</span> RpcMethodResponse</span><br><span class="line">                        .builder()</span><br><span class="line">                        .respId(request.getReqId())</span><br><span class="line">                        .returnVal(GsonSerializer.encode(result))</span><br><span class="line">                        .returnType(request.getReturnType())</span><br><span class="line">                        .error(err)</span><br><span class="line">                        .build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNative</span><span class="params">(RpcMethodRequest request)</span> </span>&#123;</span><br><span class="line">            String key = request.getOwnerName();</span><br><span class="line">            <span class="keyword">return</span> RPC_INFO_MANAGER.containRegisterInfo(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ApplicationManager</code>类管理着本地被注册为<code>@RpcRegister</code>的方法以及所有的<code>@RpcRegister</code>以及<code>@RpcService</code>注解修饰类的信息，对所有RPC请求调用本地方法的处理都交由<code>Executor</code>类来执行</p>
<h4 id="异步RPC调用，如何能够正确接收返回结果"><a href="#异步RPC调用，如何能够正确接收返回结果" class="headerlink" title="异步RPC调用，如何能够正确接收返回结果"></a>异步RPC调用，如何能够正确接收返回结果</h4><p>由于每一次<code>RPC</code>请求的发起都会创建一个请求id，以及<code>RPC</code>响应都会讲请求id回带到响应对象中，因此只需要根据请求id找到对应的future对象，complete下即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rpc 请求缓存池，每次的Rpc请求生成的RpcResult会放在这里进行缓存，当接收到返回响应时</span></span><br><span class="line"><span class="comment">// 从此处获取对应的RpcResult对象，执行complete操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcResultPool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, RpcResult&gt; RESULT_FUTURE = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcResult <span class="title">getFuture</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RESULT_FUTURE.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcResult <span class="title">createFuture</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createFuture(key, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcResult <span class="title">createFuture</span><span class="params">(String key, <span class="keyword">boolean</span> isVoid)</span> </span>&#123;</span><br><span class="line">        RpcResult result = <span class="keyword">new</span> RpcResult(isVoid);</span><br><span class="line">        RESULT_FUTURE.put(key, result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        RESULT_FUTURE.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rpc 请求结果对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcResult</span> <span class="keyword">extends</span> <span class="title">CompletableFuture</span>&lt;<span class="title">RpcMethodResponse</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isVoid = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RpcResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RpcResult</span><span class="params">(<span class="keyword">boolean</span> isVoid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isVoid = isVoid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">complete</span><span class="params">(RpcMethodResponse value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.complete(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">result</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException, RpcTimeOutException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isVoid) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RpcMethodResponse response = <span class="keyword">null</span>;</span><br><span class="line">        response = get();</span><br><span class="line">        RpcResultPool.remove(response.getRespId());</span><br><span class="line">        Class cls = response.getReturnType();</span><br><span class="line">        String val = response.getReturnVal();</span><br><span class="line">        Throwable error = response.getError();</span><br><span class="line">        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> GsonSerializer.decode(val, cls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h4><p><a href="https://github.com/chuntaojun/tensor-rpc/tree/dev" target="_blank" rel="noopener">tensor-rpc</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/06/22/leetcode-27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/22/leetcode-27/" class="post-title-link" itemprop="url">leetcode回顾——number-of-islands</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-06-22 20:58:14 / Modified: 21:06:12" itemprop="dateCreated datePublished" datetime="2019-06-22T20:58:14+08:00">2019-06-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/LeetCode/" itemprop="url" rel="index"><span itemprop="name">LeetCode</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h4><p>给定一个由 ‘1’（陆地）和 ‘0’（水）组成的的二维网格，计算岛屿的数量。一个岛被水包围，并且它是通过水平方向或垂直方向上相邻的陆地连接而成的。你可以假设网格的四个边均被水包围。</p>
<h6 id="示例-1"><a href="#示例-1" class="headerlink" title="示例 1:"></a>示例 1:</h6><p>输入:</p>
<blockquote>
<p>11110<br>11010<br>11000<br>00000</p>
</blockquote>
<p>输出: 1</p>
<h6 id="示例-2"><a href="#示例-2" class="headerlink" title="示例 2:"></a>示例 2:</h6><p>输入:</p>
<blockquote>
<p>11000<br>11000<br>00100<br>00011</p>
</blockquote>
<p>输出: 3</p>
<blockquote>
<p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/number-of-islands" target="_blank" rel="noopener">https://leetcode-cn.com/problems/number-of-islands</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p>
</blockquote>
<h4 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h4><p>这道题其实可以用<code>DFS</code>或者<code>BFS</code>来做，<code>DFS</code>比较简单，因此这里二刷的时候，使用了<code>BFS</code>来AC这道题目</p>
<p>其大致的思想就是，从岛屿的其中一个点开始进行广度优先搜索，从与该点的邻点开始进行搜索，如果是岛屿的一部分，则标记已搜查过，如果不是，则跳过</p>
<h4 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码"></a>AC代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumIslands</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> nums = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>[][] a = <span class="keyword">new</span> <span class="keyword">int</span>[][]&#123;&#123;<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;-<span class="number">1</span>, <span class="number">0</span>&#125;, &#123;<span class="number">0</span>, <span class="number">1</span>&#125;, &#123;<span class="number">0</span>, -<span class="number">1</span>&#125;&#125;;</span><br><span class="line">    LinkedList&lt;Node&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    Set&lt;Node&gt; used = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numIslands</span><span class="params">(<span class="keyword">char</span>[][] grid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> rows = grid.length;</span><br><span class="line">        <span class="keyword">if</span> (rows == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> cols = grid[<span class="number">0</span>].length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> row = <span class="number">0</span>; row &lt; rows; row ++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> col = <span class="number">0</span>; col &lt; cols; col ++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (grid[row][col] == <span class="string">'1'</span>) &#123;</span><br><span class="line">                    bfs(grid, row, col, rows, cols);</span><br><span class="line">                    nums += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bfs</span><span class="params">(<span class="keyword">char</span>[][] grid, <span class="keyword">int</span> row, <span class="keyword">int</span> col, <span class="keyword">int</span> rows, <span class="keyword">int</span> cols)</span> </span>&#123;</span><br><span class="line">        grid[row][col] = <span class="string">'2'</span>;</span><br><span class="line">        queue.clear();</span><br><span class="line">        used.clear();</span><br><span class="line">        </span><br><span class="line">        Node root = <span class="keyword">new</span> Node(row, col);</span><br><span class="line">        queue.add(root);</span><br><span class="line">        used.add(root);</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">int</span> size = queue.size();</span><br><span class="line">            <span class="keyword">while</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                size --;</span><br><span class="line">                Node cur = queue.removeFirst();</span><br><span class="line">                <span class="keyword">int</span> preX = cur.x;</span><br><span class="line">                <span class="keyword">int</span> preY = cur.y;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i ++) &#123;</span><br><span class="line">                    <span class="keyword">int</span> nX = preX + a[i][<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">int</span> nY = preY + a[i][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (nX &lt; <span class="number">0</span> || nY &lt; <span class="number">0</span> || nX &gt;= rows || nY &gt;= cols) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (grid[nX][nY] != <span class="string">'1'</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    grid[nX][nY] = <span class="string">'2'</span>;</span><br><span class="line"></span><br><span class="line">                    Node node = <span class="keyword">new</span> Node(nX, nY);</span><br><span class="line">                    <span class="keyword">if</span> (!used.contains(node)) &#123;</span><br><span class="line">                        queue.add(node);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x;</span><br><span class="line">        <span class="keyword">int</span> y;</span><br><span class="line">        </span><br><span class="line">        Node(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123;</span><br><span class="line">            <span class="keyword">this</span>.x = x;</span><br><span class="line">            <span class="keyword">this</span>.y = y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            Node t = (Node) o;</span><br><span class="line">            <span class="keyword">return</span> x == t.x &amp;&amp; y == t.y;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[][] grid = <span class="keyword">new</span> <span class="keyword">char</span>[][]&#123;</span><br><span class="line">            &#123;<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'0'</span>&#125;,</span><br><span class="line">            &#123;<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'0'</span>&#125;,</span><br><span class="line">            &#123;<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>&#125;,</span><br><span class="line">            &#123;<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>,<span class="string">'0'</span>&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        NumIslands nIslands = <span class="keyword">new</span> NumIslands();</span><br><span class="line">        System.out.println(nIslands.numIslands(grid));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/06/21/java-web-46/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/21/java-web-46/" class="post-title-link" itemprop="url">Netty是如何解决Java epoll中的BUG的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-06-21 08:32:45 / Modified: 12:47:14" itemprop="dateCreated datePublished" datetime="2019-06-21T08:32:45+08:00">2019-06-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java-web/" itemprop="url" rel="index"><span itemprop="name">java-web</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="问题的由来"><a href="#问题的由来" class="headerlink" title="问题的由来"></a>问题的由来</h4><p>在Java原生使用<code>NIO(epoll)</code>中，会存在一个著名的<code>bug</code>——<code>epoll</code>空轮训导致CPU出现100%的情况出现</p>
<h4 id="Netty是如何解决这个问题的"><a href="#Netty是如何解决这个问题的" class="headerlink" title="Netty是如何解决这个问题的"></a>Netty是如何解决这个问题的</h4><p>这里需要深入跟踪一下<code>NioEventLoop</code>类的实现</p>
<h5 id="静态代码块"><a href="#静态代码块" class="headerlink" title="静态代码块"></a>静态代码块</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> String key = <span class="string">"sun.nio.ch.bugLevel"</span>;</span><br><span class="line">	<span class="keyword">final</span> String bugLevel = SystemPropertyUtil.get(key);</span><br><span class="line">	<span class="keyword">if</span> (bugLevel == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">						System.setProperty(key, <span class="string">""</span>);</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">					&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SecurityException e) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Unable to get/set System Property: "</span> + key, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置epoll空轮训bug判断的触发阈值</span></span><br><span class="line">	<span class="keyword">int</span> selectorAutoRebuildThreshold = SystemPropertyUtil.getInt(<span class="string">"io.netty.selectorAutoRebuildThreshold"</span>, <span class="number">512</span>);</span><br><span class="line">	<span class="keyword">if</span> (selectorAutoRebuildThreshold &lt; MIN_PREMATURE_SELECTOR_RETURNS) &#123;</span><br><span class="line">		selectorAutoRebuildThreshold = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SELECTOR_AUTO_REBUILD_THRESHOLD = selectorAutoRebuildThreshold;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"-Dio.netty.noKeySetOptimization: &#123;&#125;"</span>, DISABLE_KEY_SET_OPTIMIZATION);</span><br><span class="line">		logger.debug(<span class="string">"-Dio.netty.selectorAutoRebuildThreshold: &#123;&#125;"</span>, SELECTOR_AUTO_REBUILD_THRESHOLD);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在静态代码块中看到一个很重要的属性<code>io.netty.selectorAutoRebuildThreshold</code>，这个属性是解决<code>JDK</code>中的<code>epoll</code>的bug的重要属性</p>
<h5 id="Netty对于Selector的优化"><a href="#Netty对于Selector的优化" class="headerlink" title="Netty对于Selector的优化"></a>Netty对于Selector的优化</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SelectorTuple <span class="title">openSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Selector unwrappedSelector;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取系统对应的提供的selector实现(epoll——linux、poll——MacOS)</span></span><br><span class="line">		unwrappedSelector = provider.openSelector();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"failed to open a new selector"</span>, e);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否禁止了selectorKey的优化</span></span><br><span class="line">	<span class="keyword">if</span> (DISABLE_KEY_SET_OPTIMIZATION) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载sun.nio.ch.SelectorImpl的class信息</span></span><br><span class="line">	Object maybeSelectorImplClass = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> Class.forName(<span class="string">"sun.nio.ch.SelectorImpl"</span>, <span class="keyword">false</span>, PlatformDependent.getSystemClassLoader());</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Throwable cause) &#123;</span><br><span class="line">					<span class="keyword">return</span> cause;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是异常，直接不进行下一步的selector优化</span></span><br><span class="line">  <span class="comment">// 如果是Class且是系统所提供的selector的class，则进行Netty的selector优化</span></span><br><span class="line">	<span class="keyword">if</span> (!(maybeSelectorImplClass <span class="keyword">instanceof</span> Class) ||</span><br><span class="line">		<span class="comment">// ensure the current selector implementation is what we can instrument.</span></span><br><span class="line">		!((Class&lt;?&gt;) maybeSelectorImplClass).isAssignableFrom(unwrappedSelector.getClass())) &#123;</span><br><span class="line">		<span class="keyword">if</span> (maybeSelectorImplClass <span class="keyword">instanceof</span> Throwable) &#123;</span><br><span class="line">			Throwable t = (Throwable) maybeSelectorImplClass;</span><br><span class="line">			logger.trace(<span class="string">"failed to instrument a special java.util.Set into: &#123;&#125;"</span>, unwrappedSelector, t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> Class&lt;?&gt; selectorImplClass = (Class&lt;?&gt;) maybeSelectorImplClass;</span><br><span class="line">  <span class="comment">// 使用Netty的自定义实现的selectedKeySet(本质是一个数组)</span></span><br><span class="line">	<span class="keyword">final</span> SelectedSelectionKeySet selectedKeySet = <span class="keyword">new</span> SelectedSelectionKeySet();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 进行相关的优化措施</span></span><br><span class="line">	Object maybeException = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 利用反射获取selectedKeys字段信息</span></span><br><span class="line">					Field selectedKeysField = selectorImplClass.getDeclaredField(<span class="string">"selectedKeys"</span>);</span><br><span class="line">					Field publicSelectedKeysField = selectorImplClass.getDeclaredField(<span class="string">"publicSelectedKeys"</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 如果是JDK9且存在Unsafe，则使用原本的sun.misc.Unsafe实现Field的替换</span></span><br><span class="line">					<span class="keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="number">9</span> &amp;&amp; PlatformDependent.hasUnsafe()) &#123;</span><br><span class="line">						<span class="comment">// Let us try to use sun.misc.Unsafe to replace the SelectionKeySet.</span></span><br><span class="line">						<span class="comment">// This allows us to also do this in Java9+ without any extra flags.</span></span><br><span class="line">						<span class="keyword">long</span> selectedKeysFieldOffset = PlatformDependent.objectFieldOffset(selectedKeysField);</span><br><span class="line">						<span class="keyword">long</span> publicSelectedKeysFieldOffset = PlatformDependent.objectFieldOffset(publicSelectedKeysField);</span><br><span class="line">						<span class="keyword">if</span> (selectedKeysFieldOffset != -<span class="number">1</span> &amp;&amp; publicSelectedKeysFieldOffset != -<span class="number">1</span>) &#123;</span><br><span class="line">							PlatformDependent.putObject(unwrappedSelector, selectedKeysFieldOffset, selectedKeySet);</span><br><span class="line">							PlatformDependent.putObject(unwrappedSelector, publicSelectedKeysFieldOffset, selectedKeySet);</span><br><span class="line">							<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="comment">// We could not retrieve the offset, lets try reflection as last-resort.</span></span><br><span class="line">					&#125;</span><br><span class="line">          <span class="comment">// 否则使用反射进行操作，替换待优化的Field</span></span><br><span class="line">					Throwable cause = ReflectionUtil.trySetAccessible(selectedKeysField, <span class="keyword">true</span>);</span><br><span class="line">					<span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="keyword">return</span> cause;</span><br><span class="line">					&#125;</span><br><span class="line">					cause = ReflectionUtil.trySetAccessible(publicSelectedKeysField, <span class="keyword">true</span>);</span><br><span class="line">					<span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</span><br><span class="line">						<span class="keyword">return</span> cause;</span><br><span class="line">					&#125;</span><br><span class="line">          <span class="comment">// 进行相关的selectedKeys替换，替换为Netty的实现</span></span><br><span class="line">					selectedKeysField.set(unwrappedSelector, selectedKeySet);</span><br><span class="line">					publicSelectedKeysField.set(unwrappedSelector, selectedKeySet);</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">					<span class="keyword">return</span> e;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">					<span class="keyword">return</span> e;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 如果在优化过程中出现错误，则直接不做优化</span></span><br><span class="line">		<span class="keyword">if</span> (maybeException <span class="keyword">instanceof</span> Exception) &#123;</span><br><span class="line">			selectedKeys = <span class="keyword">null</span>;</span><br><span class="line">			Exception e = (Exception) maybeException;</span><br><span class="line">			logger.trace(<span class="string">"failed to instrument a special java.util.Set into: &#123;&#125;"</span>, unwrappedSelector, e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector);</span><br><span class="line">		&#125;</span><br><span class="line">		selectedKeys = selectedKeySet;</span><br><span class="line">		logger.trace(<span class="string">"instrumented a special java.util.Set into: &#123;&#125;"</span>, unwrappedSelector);</span><br><span class="line">    <span class="comment">// 返回已优化过的selector，由于已将selectedKeySet替换进了JDK的selector实现中，因此所有的操作都</span></span><br><span class="line">    <span class="comment">// 会反应在selectedKeySet中</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector, <span class="keyword">new</span> SelectedSelectionKeySetSelector(unwrappedSelector, selectedKeySet));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Netty</code>其实提供了对<code>selector</code>的优化措施，其实就只是对于<code>selectKeys</code>的优化，从集合转为了用数组对<code>selectKey</code>进行管理</p>
<h5 id="NioEventLoop所执行的任务"><a href="#NioEventLoop所执行的任务" class="headerlink" title="NioEventLoop所执行的任务"></a>NioEventLoop所执行的任务</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 这里是Netty的任务执行策略选择</span></span><br><span class="line">        <span class="comment">// 官方注释：</span></span><br><span class="line">        <span class="comment">// Provides the ability to control the behavior of the select loop. For example a blocking select</span></span><br><span class="line">        <span class="comment">// operation can be delayed or skipped entirely if there are events to process immediately.</span></span><br><span class="line">				<span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;</span><br><span class="line">					<span class="keyword">case</span> SelectStrategy.CONTINUE:</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					<span class="keyword">case</span> SelectStrategy.BUSY_WAIT:</span><br><span class="line">						<span class="comment">// fall-through to SELECT since the busy-wait is not supported with NIO</span></span><br><span class="line"></span><br><span class="line">					<span class="keyword">case</span> SelectStrategy.SELECT:</span><br><span class="line">            <span class="comment">// 执行select操作，而此select操作所查询出的事件，要么是在JDK原有的selectKeys中</span></span><br><span class="line">            <span class="comment">// 要么是在Netty的自实现SelectKeys中</span></span><br><span class="line">						select(wakenUp.getAndSet(<span class="keyword">false</span>));</span><br><span class="line">            <span class="keyword">if</span> (wakenUp.get()) &#123;</span><br><span class="line">							selector.wakeup();</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="comment">// fall through</span></span><br><span class="line">					<span class="keyword">default</span>:</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				<span class="comment">// If we receive an IOException here its because the Selector is messed up. Let's rebuild</span></span><br><span class="line">				<span class="comment">// the selector and retry. https://github.com/netty/netty/issues/8566</span></span><br><span class="line">        <span class="comment">// 如果在期间发生错误，则进行重建Selector</span></span><br><span class="line">				rebuildSelector0();</span><br><span class="line">				handleLoopException(e);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			cancelledKeys = <span class="number">0</span>;</span><br><span class="line">			needsToSelectAgain = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</span><br><span class="line">      <span class="comment">// 由于NioEventLoop需要处理IO事件与非IO事件，为了确保二者都能够得到足够的CPU时间运行</span></span><br><span class="line">      <span class="comment">// 通过设置ioRatio进行二者对于线程占用时间的确定</span></span><br><span class="line">      <span class="comment">// 如果ioRate为100则表示全部为IO任务</span></span><br><span class="line">			<span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 处理本次select所轮训出来的事件</span></span><br><span class="line">					processSelectedKeys();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="comment">// Ensure we always run tasks.</span></span><br><span class="line">          <span class="comment">// 运行所有的任务，全部为IO任务，则没有时间限制</span></span><br><span class="line">					runAllTasks();</span><br><span class="line">				&#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果存在非IO任务，则需要计算非IO任务所占用的时间</span></span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					processSelectedKeys();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="comment">// Ensure we always run tasks.</span></span><br><span class="line">          <span class="comment">// 计算非IO任务的时间</span></span><br><span class="line">					<span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</span><br><span class="line">					runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			handleLoopException(t);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Always handle shutdown even if the loop processing threw an exception.</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (isShuttingDown()) &#123;</span><br><span class="line">				closeAll();</span><br><span class="line">				<span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">			handleLoopException(t);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Netty的select操作-对selector的select操作的包装"><a href="#Netty的select操作-对selector的select操作的包装" class="headerlink" title="Netty的select操作(对selector的select操作的包装)"></a>Netty的select操作(对selector的select操作的包装)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(<span class="keyword">boolean</span> oldWakenUp)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 每次select操作都重新计数</span></span><br><span class="line">		<span class="keyword">int</span> selectCnt = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 本次select操作的开始时间</span></span><br><span class="line">		<span class="keyword">long</span> currentTimeNanos = System.nanoTime();</span><br><span class="line">		<span class="keyword">long</span> selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">      <span class="comment">// 如果超过任务的执行时间分片</span></span><br><span class="line">			<span class="keyword">long</span> timeoutMillis = (selectDeadLineNanos - currentTimeNanos + <span class="number">500000L</span>) / <span class="number">1000000L</span>;</span><br><span class="line">			<span class="keyword">if</span> (timeoutMillis &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 是否做了一次select操作，如果没有，则执行一次</span></span><br><span class="line">				<span class="keyword">if</span> (selectCnt == <span class="number">0</span>) &#123;</span><br><span class="line">					selector.selectNow();</span><br><span class="line">					selectCnt = <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">        <span class="comment">// 否则直接跳出本次循环</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If a task was submitted when wakenUp value was true, the task didn't get a chance to call</span></span><br><span class="line">			<span class="comment">// Selector#wakeup. So we need to check task queue again before executing select operation.</span></span><br><span class="line">			<span class="comment">// If we don't, the task might be pended until select operation was timed out.</span></span><br><span class="line">			<span class="comment">// It might be pended until idle timeout if IdleStateHandler existed in pipeline.</span></span><br><span class="line">			<span class="keyword">if</span> (hasTasks() &amp;&amp; wakenUp.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">				selector.selectNow();</span><br><span class="line">				selectCnt = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在指定的时间内进行select操作，如果select操作正常执行，那么所select出来的事件会在</span></span><br><span class="line">			<span class="keyword">int</span> selectedKeys = selector.select(timeoutMillis);</span><br><span class="line">      <span class="comment">// 每次select操作都会selectCnt计数器增加</span></span><br><span class="line">			selectCnt ++;</span><br><span class="line">      <span class="comment">// 如果本次select选出了事件或者被唤醒或者有任务准备调度，则跳出循环</span></span><br><span class="line">			<span class="keyword">if</span> (selectedKeys != <span class="number">0</span> || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) &#123;</span><br><span class="line">				<span class="comment">// - Selected something,</span></span><br><span class="line">				<span class="comment">// - waken up by user, or</span></span><br><span class="line">				<span class="comment">// - the task queue has a pending task.</span></span><br><span class="line">				<span class="comment">// - a scheduled task is ready for processing</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">      <span class="comment">// 如果线程被中断过</span></span><br><span class="line">			<span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">				<span class="comment">// Thread was interrupted so reset selected keys and break so we not run into a busy loop.</span></span><br><span class="line">				<span class="comment">// As this is most likely a bug in the handler of the user or it's client library we will</span></span><br><span class="line">				<span class="comment">// also log it.</span></span><br><span class="line">				<span class="comment">// See https://github.com/netty/netty/issues/2426</span></span><br><span class="line">        selectCnt = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">long</span> time = System.nanoTime();</span><br><span class="line">			<span class="keyword">if</span> (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) &#123;</span><br><span class="line">				<span class="comment">// timeoutMillis elapsed without anything selected.</span></span><br><span class="line">				selectCnt = <span class="number">1</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; <span class="number">0</span> &amp;&amp; selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) &#123;</span><br><span class="line">        <span class="comment">// 如果在指定的时间内，selectCnt超过了SELECTOR_AUTO_REBUILD_THRESHOLD，则表示</span></span><br><span class="line">        <span class="comment">// 当前JDK的selector epoll空轮训BUG已触发，开启RebuildSelector任务</span></span><br><span class="line">				selector = selectRebuildSelector(selectCnt);</span><br><span class="line">        <span class="comment">// 重置selectCnt计数</span></span><br><span class="line">				selectCnt = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			currentTimeNanos = time;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">    <span class="comment">// Harmless exception - log anyway</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，<code>Netty</code>解决<code>epoll</code>的空轮训的问题是采取了<code>selector</code>重建的解决方案，通过对<code>select</code>操作的计数，如果是空轮训，那么在极端的时间内会执行多次的<code>select</code>操作，如果<code>selectCnt</code>次数达到了指定的需要进行<code>rebuildSelector</code>的阈值，那么就触发重建<code>selector</code>操作</p>
<h5 id="Netty的selector重建过程"><a href="#Netty的selector重建过程" class="headerlink" title="Netty的selector重建过程"></a>Netty的selector重建过程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebuildSelector0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 旧的selector</span></span><br><span class="line">	<span class="keyword">final</span> Selector oldSelector = selector;</span><br><span class="line">  <span class="comment">// 新的selector</span></span><br><span class="line">	<span class="keyword">final</span> SelectorTuple newSelectorTuple;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (oldSelector == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重新创建一个selector</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		newSelectorTuple = openSelector();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.warn(<span class="string">"Failed to create a new Selector."</span>, e);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register all channels to the new Selector.</span></span><br><span class="line">	<span class="keyword">int</span> nChannels = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 遍历所有oldSelector中的事件列表</span></span><br><span class="line">	<span class="keyword">for</span> (SelectionKey key: oldSelector.keys()) &#123;</span><br><span class="line">    <span class="comment">// 事件的附件信息</span></span><br><span class="line">		Object a = key.attachment();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 判断事件是否有效以及是否在新的selector中</span></span><br><span class="line">			<span class="keyword">if</span> (!key.isValid() || key.channel().keyFor(newSelectorTuple.unwrappedSelector) != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">int</span> interestOps = key.interestOps();</span><br><span class="line">      <span class="comment">// key注销</span></span><br><span class="line">			key.cancel();</span><br><span class="line">      <span class="comment">// 重新将key注册到新的selector中</span></span><br><span class="line">			SelectionKey newKey = key.channel().register(newSelectorTuple.unwrappedSelector, interestOps, a);</span><br><span class="line">			<span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) &#123;</span><br><span class="line">				<span class="comment">// Update SelectionKey</span></span><br><span class="line">				((AbstractNioChannel) a).selectionKey = newKey;</span><br><span class="line">			&#125;</span><br><span class="line">			nChannels ++;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			logger.warn(<span class="string">"Failed to re-register a Channel to the new Selector."</span>, e);</span><br><span class="line">			<span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) &#123;</span><br><span class="line">				AbstractNioChannel ch = (AbstractNioChannel) a;</span><br><span class="line">				ch.unsafe().close(ch.unsafe().voidPromise());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">				NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</span><br><span class="line">				invokeChannelUnregistered(task, key, e);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重新赋值selector对象</span></span><br><span class="line">	selector = newSelectorTuple.selector;</span><br><span class="line">	unwrappedSelector = newSelectorTuple.unwrappedSelector;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// time to close the old selector as everything else is registered to the new one</span></span><br><span class="line">    <span class="comment">// 重建完毕后，关闭原有的selector</span></span><br><span class="line">		oldSelector.close();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    ...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过创建新的<code>selector</code>以及将<code>oldSelector</code>中的事件重新注册到<code>newSelector</code>中，完成<code>epoll</code>空轮训<code>bug</code>的修复。因此，<code>netty</code>通过对<code>JDK</code>的<code>select</code>操作进行一次包装，记录一次<code>select</code>操作中，<code>selectNow</code>所产生的次数进行<code>epoll</code>空轮训<code>bug</code>的判断以及修复</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/06/11/java-web-45/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/11/java-web-45/" class="post-title-link" itemprop="url">Nacos疑问之为什么我服务明明下线了却还是可以调用到？</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-11 20:00:10" itemprop="dateCreated datePublished" datetime="2019-06-11T20:00:10+08:00">2019-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-06-20 16:04:32" itemprop="dateModified" datetime="2019-06-20T16:04:32+08:00">2019-06-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nacos/" itemprop="url" rel="index"><span itemprop="name">nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h4><p>之前在参与<code>nacos</code>的开发过程中，有不少同学都在问，为什么我在<code>nacos console</code>中将服务进行下线了，但是这个被下线的服务还是可以被调用到，这不太符合官方宣称的秒级上下线特点呀。经过进一步询问发现，那些存在说实例下线后依旧可以对外提供服务的问题，有一个共同的特点——都有<code>rabbion</code>这个负载均衡的组件。因此本文将从两个方面探讨这个问题：<code>nacos</code>的秒级上下线的实现方式以及<code>rabbion</code>的实例更新机制导致实例上下线感知延迟</p>
<h4 id="Nacos-秒级上下线"><a href="#Nacos-秒级上下线" class="headerlink" title="Nacos 秒级上下线"></a>Nacos 秒级上下线</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">""</span>, method = RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	String serviceName = WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">	String namespaceId = WebUtils.optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line"></span><br><span class="line">	String agent = request.getHeader(<span class="string">"Client-Version"</span>);</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isBlank(agent)) &#123;</span><br><span class="line">		agent = request.getHeader(<span class="string">"User-Agent"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ClientInfo clientInfo = <span class="keyword">new</span> ClientInfo(agent);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (clientInfo.type == ClientInfo.ClientType.JAVA &amp;&amp;</span><br><span class="line">		clientInfo.version.compareTo(VersionUtil.parseVersion(<span class="string">"1.0.0"</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		serviceManager.updateInstance(namespaceId, serviceName, parseInstance(request));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		serviceManager.registerInstance(namespaceId, serviceName, parseInstance(request));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"ok"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面就是<code>nacos console</code>端实例上下线的接口，<code>parseInstance(request)</code>方法就是从<code>request</code>中提取<code>instance</code>实例信息。而背后的<code>updateInstance</code>方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateInstance</span><span class="params">(String namespaceId, String serviceName, Instance instance)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line"></span><br><span class="line">	Service service = getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NacosException(NacosException.INVALID_PARAM, <span class="string">"service not found, namespace: "</span> + namespaceId + <span class="string">", service: "</span> + serviceName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!service.allIPs().contains(instance)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NacosException(NacosException.INVALID_PARAM, <span class="string">"instance not exist: "</span> + instance);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInstance</span><span class="params">(String namespaceId, String serviceName, <span class="keyword">boolean</span> ephemeral, Instance... ips)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line"></span><br><span class="line">	String key = KeyBuilder.buildInstanceListKey(namespaceId, serviceName, ephemeral);</span><br><span class="line"></span><br><span class="line">	Service service = getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">	List&lt;Instance&gt; instanceList = addIpAddresses(service, ephemeral, ips);</span><br><span class="line"></span><br><span class="line">	Instances instances = <span class="keyword">new</span> Instances();</span><br><span class="line">	instances.setInstanceList(instanceList);</span><br><span class="line"></span><br><span class="line">	consistencyService.put(key, instances);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来的方法就和之前的博文<a href="https://www.liaochuntao.cn/2019/04/29/java-web-31/">Nacos Server端注册一个服务实例流程</a>一样了。因此在<code>nacos console</code>中一旦点击实例下线，是立马更新<code>nacos naming server</code>中的实例信息数据的。</p>
<h4 id="Rabbion的实例更新机制"><a href="#Rabbion的实例更新机制" class="headerlink" title="Rabbion的实例更新机制"></a>Rabbion的实例更新机制</h4><p>首先看<code>nacos</code>实现的<code>rabbion</code>的实例拉取代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosServerList</span> <span class="keyword">extends</span> <span class="title">AbstractServerList</span>&lt;<span class="title">NacosServer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> NacosDiscoveryProperties discoveryProperties;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String serviceId;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">NacosServerList</span><span class="params">(NacosDiscoveryProperties discoveryProperties)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.discoveryProperties = discoveryProperties;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;NacosServer&gt; <span class="title">getInitialListOfServers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getServers();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;NacosServer&gt; <span class="title">getUpdatedListOfServers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getServers();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;NacosServer&gt; <span class="title">getServers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			List&lt;Instance&gt; instances = discoveryProperties.namingServiceInstance()</span><br><span class="line">					.selectInstances(serviceId, <span class="keyword">true</span>);</span><br><span class="line">			<span class="keyword">return</span> instancesToServerList(instances);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">					<span class="string">"Can not get service instances from nacos, serviceId="</span> + serviceId,</span><br><span class="line">					e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> List&lt;NacosServer&gt; <span class="title">instancesToServerList</span><span class="params">(List&lt;Instance&gt; instances)</span> </span>&#123;</span><br><span class="line">		List&lt;NacosServer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> == instances) &#123;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">			result.add(<span class="keyword">new</span> NacosServer(instance));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getServiceId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> serviceId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig iClientConfig)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.serviceId = iClientConfig.getClientName();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>NacosServerList</code>继承了<code>AbstractServerList</code>，那么这个<code>AbstractServerList</code>最终在哪里被收集呢？通过代码跟踪可以看到，最终是在<code>DynamicServerListLoadBalancer</code>这个类中被收集</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ServerListUpdater.UpdateAction updateAction = <span class="keyword">new</span> ServerListUpdater.UpdateAction() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            updateListOfServers();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicServerListLoadBalancer</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">	initWithNiwsConfig(clientConfig);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWithNiwsConfig</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">super</span>.initWithNiwsConfig(clientConfig);</span><br><span class="line">		String niwsServerListClassName = clientConfig.getPropertyAsString( CommonClientConfigKey.NIWSServerListClassName, DefaultClientConfigImpl.DEFAULT_SEVER_LIST_CLASS);</span><br><span class="line">		ServerList&lt;T&gt; niwsServerListImpl = (ServerList&lt;T&gt;) ClientFactory</span><br><span class="line">                    .instantiateInstanceWithClientConfig(niwsServerListClassName, clientConfig);</span><br><span class="line">    <span class="comment">// 获取所有ServerList接口的实现类</span></span><br><span class="line">		<span class="keyword">this</span>.serverListImpl = niwsServerListImpl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取Filter(对拉取的servers列表实行过滤操作)</span></span><br><span class="line">		<span class="keyword">if</span> (niwsServerListImpl <span class="keyword">instanceof</span> AbstractServerList) &#123;</span><br><span class="line">			AbstractServerListFilter&lt;T&gt; niwsFilter = ((AbstractServerList) niwsServerListImpl)</span><br><span class="line">                        .getFilterImpl(clientConfig);</span><br><span class="line">			niwsFilter.setLoadBalancerStats(getLoadBalancerStats());</span><br><span class="line">			<span class="keyword">this</span>.filter = niwsFilter;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取获取ServerListUpdater对象实现类类名</span></span><br><span class="line">		String serverListUpdaterClassName = clientConfig.getPropertyAsString( CommonClientConfigKey.ServerListUpdaterClassName, DefaultClientConfigImpl.DEFAULT_SERVER_LIST_UPDATER_CLASS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取ServerListUpdater对象(实际对象为PollingServerListUpdater)</span></span><br><span class="line">		<span class="keyword">this</span>.serverListUpdater = (ServerListUpdater) ClientFactory.instantiateInstanceWithClientConfig(serverListUpdaterClassName, clientConfig);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化或者重置</span></span><br><span class="line">		restOfInit(clientConfig);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Exception while initializing NIWSDiscoveryLoadBalancer:"</span></span><br><span class="line">                            + clientConfig.getClientName()</span><br><span class="line">                            + <span class="string">", niwsClientConfig:"</span> + clientConfig, e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restOfInit</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> primeConnection = <span class="keyword">this</span>.isEnablePrimingConnections();</span><br><span class="line">	<span class="comment">// turn this off to avoid duplicated asynchronous priming done in BaseLoadBalancer.setServerList()</span></span><br><span class="line">	<span class="keyword">this</span>.setEnablePrimingConnections(<span class="keyword">false</span>);</span><br><span class="line">  <span class="comment">// 开启定时任务，这个任务就是定时刷新实例信息缓存</span></span><br><span class="line">	enableAndInitLearnNewServersFeature();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开启前进行一次实例拉取操作</span></span><br><span class="line">	updateListOfServers();</span><br><span class="line">	<span class="keyword">if</span> (primeConnection &amp;&amp; <span class="keyword">this</span>.getPrimeConnections() != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">this</span>.getPrimeConnections() .primeConnections(getReachableServers());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">this</span>.setEnablePrimingConnections(primeConnection);</span><br><span class="line">	LOGGER.info(<span class="string">"DynamicServerListLoadBalancer for client &#123;&#125; initialized: &#123;&#125;"</span>, clientConfig.getClientName(), <span class="keyword">this</span>.toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里就是进行实例信息缓存更新的操作</span></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateListOfServers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	List&lt;T&gt; servers = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">	<span class="keyword">if</span> (serverListImpl != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用拉取新实例信息的方法</span></span><br><span class="line">		servers = serverListImpl.getUpdatedListOfServers();</span><br><span class="line">		LOGGER.debug(<span class="string">"List of Servers for &#123;&#125; obtained from Discovery client: &#123;&#125;"</span>, getIdentifier(), servers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用Filter对拉取的servers列表进行更新</span></span><br><span class="line">		<span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">			servers = filter.getFilteredListOfServers(servers);</span><br><span class="line">			LOGGER.debug(<span class="string">"Filtered List of Servers for &#123;&#125; obtained from Discovery client: &#123;&#125;"</span>, getIdentifier(), servers);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 更新实例列表</span></span><br><span class="line">	updateAllServerList(servers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来看看<code>enableAndInitLearnNewServersFeature();</code>的最终调用是什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> UpdateAction updateAction)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (isActive.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">		<span class="keyword">final</span> Runnable wrapperRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (!isActive.get()) &#123;</span><br><span class="line">					<span class="keyword">if</span> (scheduledFuture != <span class="keyword">null</span>) &#123;</span><br><span class="line">						scheduledFuture.cancel(<span class="keyword">true</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 这里的UpdateAction对象就是在DynamicServerListLoadBalancer中封装的updateListOfServers实现</span></span><br><span class="line">					updateAction.doUpdate();</span><br><span class="line">					lastUpdated = System.currentTimeMillis();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					logger.warn(<span class="string">"Failed one update cycle"</span>, e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认任务执行时间间隔为30s</span></span><br><span class="line">		scheduledFuture = getRefreshExecutor().scheduleWithFixedDelay(</span><br><span class="line">                    wrapperRunnable,</span><br><span class="line">                    initialDelayMs,</span><br><span class="line">                    refreshIntervalMs,</span><br><span class="line">                    TimeUnit.MILLISECONDS);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		logger.info(<span class="string">"Already active, no-op"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此不难看出，虽然<code>nacos</code>实现了秒级的实例上下线，但是由于在<code>Spring Cloud</code>中，负载组件<code>rabbion</code>的实例信息更新是采用了定时任务的形式，有可能这个任务上一秒刚刚执行完，下一秒你就执行实例上下线操作，那么<code>rabbion</code>要感知这个变化，就必须要等待<code>refreshIntervalMs</code>秒后才可以感知到。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://www.liaochuntao.cn/2019/06/09/java-web-43/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liaochuntao">
      <meta itemprop="description" content="励志成为一位大佬">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="春少 Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/09/java-web-43/" class="post-title-link" itemprop="url">Nacos 是如何剔除非健康实例的</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-09 20:43:22" itemprop="dateCreated datePublished" datetime="2019-06-09T20:43:22+08:00">2019-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-06-19 10:02:37" itemprop="dateModified" datetime="2019-06-19T10:02:37+08:00">2019-06-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nacos/" itemprop="url" rel="index"><span itemprop="name">nacos</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Nacos-Client-心跳上报"><a href="#Nacos-Client-心跳上报" class="headerlink" title="Nacos Client 心跳上报"></a>Nacos Client 心跳上报</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeatProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, BeatInfo&gt; entry : dom2Beat.entrySet()) &#123;</span><br><span class="line">				BeatInfo beatInfo = entry.getValue();</span><br><span class="line">				<span class="keyword">if</span> (beatInfo.isScheduled()) &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				beatInfo.setScheduled(<span class="keyword">true</span>);</span><br><span class="line">				executorService.schedule(<span class="keyword">new</span> BeatTask(beatInfo), <span class="number">0</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			NAMING_LOGGER.error(<span class="string">"[CLIENT-BEAT] Exception while scheduling beat."</span>, e);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			executorService.schedule(<span class="keyword">this</span>, clientBeatInterval, TimeUnit.MILLISECONDS);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeatTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	BeatInfo beatInfo;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BeatTask</span><span class="params">(BeatInfo beatInfo)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.beatInfo = beatInfo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">long</span> result = serverProxy.sendBeat(beatInfo);</span><br><span class="line">		beatInfo.setScheduled(<span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			clientBeatInterval = result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码就是<code>nacos client</code>向<code>nacos naming server</code>上报自己的心跳信息</p>
<h4 id="Nacos-Naming-Server-处理心跳"><a href="#Nacos-Naming-Server-处理心跳" class="headerlink" title="Nacos Naming Server 处理心跳"></a>Nacos Naming Server 处理心跳</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/beat"</span>, method = RequestMethod.PUT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JSONObject <span class="title">beat</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	JSONObject result = <span class="keyword">new</span> JSONObject();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 告诉 nacos-client 以后每隔 &#123;clientBeatInterval&#125; 进行一次心跳上报</span></span><br><span class="line">	result.put(<span class="string">"clientBeatInterval"</span>, switchDomain.getClientBeatInterval());</span><br><span class="line"></span><br><span class="line">	String namespaceId = WebUtils.optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);</span><br><span class="line">	String beat = WebUtils.required(request, <span class="string">"beat"</span>);</span><br><span class="line">  <span class="comment">// 将心跳信息进行转为 RsInfo 对象，以留作后面的任务信息</span></span><br><span class="line">	RsInfo clientBeat = JSON.parseObject(beat, RsInfo.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是非临时实例，直接返回</span></span><br><span class="line">	<span class="keyword">if</span> (!switchDomain.isDefaultInstanceEphemeral() &amp;&amp; !clientBeat.isEphemeral()) &#123;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.isBlank(clientBeat.getCluster())) &#123;</span><br><span class="line">		clientBeat.setCluster(UtilsAndCommons.DEFAULT_CLUSTER_NAME);</span><br><span class="line">	&#125;</span><br><span class="line">	String serviceName = WebUtils.required(request, CommonParams.SERVICE_NAME);</span><br><span class="line">	String clusterName = clientBeat.getCluster();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Loggers.DEBUG_LOG.isDebugEnabled()) &#123;</span><br><span class="line">		Loggers.DEBUG_LOG.debug(<span class="string">"[CLIENT-BEAT] full arguments: beat: &#123;&#125;, serviceName: &#123;&#125;"</span>, clientBeat, serviceName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从 ServiceManager 取出对应的 Instance 实例信息</span></span><br><span class="line">	Instance instance = serviceManager.getInstance(namespaceId, serviceName, clientBeat.getCluster(), clientBeat.getIp(), clientBeat.getPort());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果没有相应的实例信息，那么本次为首次心跳 or 数据补偿(非本次注册，但是由于某些原因实例没有续约成功</span></span><br><span class="line">  <span class="comment">// 导致被剔除，后面再次续约成功)</span></span><br><span class="line">	<span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">		instance = <span class="keyword">new</span> Instance();</span><br><span class="line">		instance.setPort(clientBeat.getPort());</span><br><span class="line">		instance.setIp(clientBeat.getIp());</span><br><span class="line">		instance.setWeight(clientBeat.getWeight());</span><br><span class="line">		instance.setMetadata(clientBeat.getMetadata());</span><br><span class="line">		instance.setClusterName(clusterName);</span><br><span class="line">		instance.setServiceName(serviceName);</span><br><span class="line">		instance.setInstanceId(instance.generateInstanceId());</span><br><span class="line">		instance.setEphemeral(clientBeat.isEphemeral());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册实例</span></span><br><span class="line">		serviceManager.registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取服务信息</span></span><br><span class="line">	Service service = serviceManager.getService(namespaceId, serviceName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NacosException(NacosException.SERVER_ERROR, <span class="string">"service not found: "</span> + serviceName + <span class="string">"@"</span> + namespaceId);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理 nacos-client 端的心跳信息</span></span><br><span class="line">	service.processClientBeat(clientBeat);</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在进行心跳任务的末尾，会创建一个处理本次客户端心跳包的任务进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processClientBeat</span><span class="params">(<span class="keyword">final</span> RsInfo rsInfo)</span> </span>&#123;</span><br><span class="line">	ClientBeatProcessor clientBeatProcessor = <span class="keyword">new</span> ClientBeatProcessor();</span><br><span class="line">	clientBeatProcessor.setService(<span class="keyword">this</span>);</span><br><span class="line">	clientBeatProcessor.setRsInfo(rsInfo);</span><br><span class="line">	HealthCheckReactor.scheduleNow(clientBeatProcessor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行通知所有的服务订阅者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Service service = <span class="keyword">this</span>.service;</span><br><span class="line">	<span class="keyword">if</span> (Loggers.EVT_LOG.isDebugEnabled()) &#123;</span><br><span class="line">		Loggers.EVT_LOG.debug(<span class="string">"[CLIENT-BEAT] processing beat: &#123;&#125;"</span>, rsInfo.toString());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	String ip = rsInfo.getIp();</span><br><span class="line">	String clusterName = rsInfo.getCluster();</span><br><span class="line">	<span class="keyword">int</span> port = rsInfo.getPort();</span><br><span class="line">  <span class="comment">// 获取集群信息</span></span><br><span class="line">	Cluster cluster = service.getClusterMap().get(clusterName);</span><br><span class="line">  <span class="comment">// 获取该集群下的所有临时实例</span></span><br><span class="line">	List&lt;Instance&gt; instances = cluster.allIPs(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">    <span class="comment">// 进行目标实例查找</span></span><br><span class="line">		<span class="keyword">if</span> (instance.getIp().equals(ip) &amp;&amp; instance.getPort() == port) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Loggers.EVT_LOG.isDebugEnabled()) &#123;</span><br><span class="line">				Loggers.EVT_LOG.debug(<span class="string">"[CLIENT-BEAT] refresh beat: &#123;&#125;"</span>, rsInfo.toString());</span><br><span class="line">			&#125;</span><br><span class="line">      <span class="comment">// 设置实例的最新一次心跳时间</span></span><br><span class="line">			instance.setLastBeat(System.currentTimeMillis());</span><br><span class="line">			<span class="keyword">if</span> (!instance.isMarked()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!instance.isHealthy()) &#123;</span><br><span class="line">          <span class="comment">// 更新实例的健康状态信息</span></span><br><span class="line">					instance.setHealthy(<span class="keyword">true</span>);</span><br><span class="line">					Loggers.EVT_LOG.info(<span class="string">"service: &#123;&#125; &#123;POS&#125; &#123;IP-ENABLED&#125; valid: &#123;&#125;:&#123;&#125;@&#123;&#125;, region: &#123;&#125;, msg: client beat ok"</span>,  cluster.getService().getName(), ip, port, cluster.getName(), UtilsAndCommons.LOCALHOST_SITE);</span><br><span class="line">          <span class="comment">// 通知所有订阅了服务为 Service.getName() 的订阅者</span></span><br><span class="line">					getPushService().serviceChanged(service.getNamespaceId(), <span class="keyword">this</span>.service.getName());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="剔除非健康实例"><a href="#剔除非健康实例" class="headerlink" title="剔除非健康实例"></a>剔除非健康实例</h4><p>这个时候就涉及<code>Service</code>这个对象了，在创建<code>Service</code>时，会判断实例类型是否为临时实例，如果是，则会开启一个任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServiceManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createEmptyService</span><span class="params">(String namespaceId, String serviceName, <span class="keyword">boolean</span> local)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">	Service service = getService(namespaceId, serviceName);</span><br><span class="line">	<span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">		Loggers.SRV_LOG.info(<span class="string">"creating empty service &#123;&#125;:&#123;&#125;"</span>, namespaceId, serviceName);</span><br><span class="line">		service = <span class="keyword">new</span> Service();</span><br><span class="line">		service.setName(serviceName);</span><br><span class="line">		service.setNamespaceId(namespaceId);</span><br><span class="line">		service.setGroupName(NamingUtils.getGroupName(serviceName));</span><br><span class="line">		<span class="comment">// now validate the service. if failed, exception will be thrown</span></span><br><span class="line">		service.setLastModifiedMillis(System.currentTimeMillis());</span><br><span class="line">		service.recalculateChecksum();</span><br><span class="line">		service.validate();</span><br><span class="line">		<span class="keyword">if</span> (local) &#123;</span><br><span class="line">			<span class="comment">// 临时实例下，开启一个任务，用于处理临时实例的健康状况</span></span><br><span class="line">			putService(service);</span><br><span class="line">			service.init();</span><br><span class="line">               	consistencyService.listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="keyword">true</span>), service);</span><br><span class="line">                consistencyService.listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="keyword">false</span>), service);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			addOrReplaceService(service);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里就会开启定时执行的任务</span></span><br><span class="line">	HealthCheckReactor.scheduleCheck(clientBeatCheckTask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (Map.Entry&lt;String, Cluster&gt; entry : clusterMap.entrySet()) &#123;</span><br><span class="line">		entry.getValue().setService(<span class="keyword">this</span>);</span><br><span class="line">		entry.getValue().init();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<code>ClientBeatCheckTask</code>根据名字就知道，它是用于处理实例心跳信息检查的，也就是实例健康处理的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientBeatCheckTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任务处理对象</span></span><br><span class="line">	<span class="keyword">private</span> Service service;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ClientBeatCheckTask</span><span class="params">(Service service)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.service = service;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这是给订阅者服务的</span></span><br><span class="line">	<span class="meta">@JSONField</span>(serialize = <span class="keyword">false</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> PushService <span class="title">getPushService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SpringContext.getAppContext().getBean(PushService.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于寻找实例的权威 Server</span></span><br><span class="line">	<span class="meta">@JSONField</span>(serialize = <span class="keyword">false</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> DistroMapper <span class="title">getDistroMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SpringContext.getAppContext().getBean(DistroMapper.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> GlobalConfig <span class="title">getGlobalConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> SpringContext.getAppContext().getBean(GlobalConfig.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">taskKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> service.getName();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 自己是否是该服务的权威server，如果是则进行处理，否则不处理</span></span><br><span class="line">			<span class="keyword">if</span> (!getDistroMapper().responsible(service.getName())) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取所有的临时实例</span></span><br><span class="line">			List&lt;Instance&gt; instances = service.allIPs(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// first set health status of instances:</span></span><br><span class="line">			<span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">        <span class="comment">// 如果实例的上次心跳时间距离当前时间超过了心跳过期时间</span></span><br><span class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - instance.getLastBeat() &gt; ClientBeatProcessor.CLIENT_BEAT_TIMEOUT) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!instance.isMarked()) &#123;</span><br><span class="line">						<span class="keyword">if</span> (instance.isHealthy()) &#123;</span><br><span class="line">              <span class="comment">// 将实例健康状态设置为fasle</span></span><br><span class="line">							instance.setHealthy(<span class="keyword">false</span>);</span><br><span class="line">							Loggers.EVT_LOG.info(<span class="string">"&#123;POS&#125; &#123;IP-DISABLED&#125; valid: &#123;&#125;:&#123;&#125;@&#123;&#125;@&#123;&#125;, region: &#123;&#125;, msg: client timeout after &#123;&#125;, last beat: &#123;&#125;"</span>,</span><br><span class="line">							instance.getIp(), instance.getPort(), instance.getClusterName(), service.getName(), UtilsAndCommons.LOCALHOST_SITE, ClientBeatProcessor.CLIENT_BEAT_TIMEOUT, instance.getLastBeat());</span><br><span class="line">              <span class="comment">// 通知订阅者相关的数据改变</span></span><br><span class="line">							getPushService().serviceChanged(service.getNamespaceId(), service.getName());</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">      <span class="comment">// 是否开启了实例过期设置</span></span><br><span class="line">			<span class="keyword">if</span> (!getGlobalConfig().isExpireInstance()) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// then remove obsolete instances:</span></span><br><span class="line">			<span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">        <span class="comment">// IP will be deleted if it has not send beat for some time, default timeout is 30 seconds.</span></span><br><span class="line">        <span class="comment">// 如果该实例上次心跳时间距离现在超过了设置的 DeleteTimeout，则对实例进行摘除</span></span><br><span class="line">				<span class="keyword">if</span> (System.currentTimeMillis() - instance.getLastBeat() &gt; service.getIpDeleteTimeout()) &#123;</span><br><span class="line">					<span class="comment">// delete instance</span></span><br><span class="line">					Loggers.SRV_LOG.info(<span class="string">"[AUTO-DELETE-IP] service: &#123;&#125;, ip: &#123;&#125;"</span>, service.getName(), JSON.toJSONString(instance));</span><br><span class="line">					deleteIP(instance);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			Loggers.SRV_LOG.warn(<span class="string">"Exception while processing client beat time out."</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteIP</span><span class="params">(Instance instance)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 创建一个实例删除请求，将删除请求定位到自己对应的 RequestMapping</span></span><br><span class="line">			NamingProxy.Request request = NamingProxy.Request.newRequest();</span><br><span class="line">			request.appendParam(<span class="string">"ip"</span>, instance.getIp())</span><br><span class="line">                .appendParam(<span class="string">"port"</span>, String.valueOf(instance.getPort()))</span><br><span class="line">                .appendParam(<span class="string">"ephemeral"</span>, <span class="string">"true"</span>)</span><br><span class="line">                .appendParam(<span class="string">"clusterName"</span>, instance.getClusterName())</span><br><span class="line">                .appendParam(<span class="string">"serviceName"</span>, service.getName())</span><br><span class="line">                .appendParam(<span class="string">"namespaceId"</span>, service.getNamespaceId());</span><br><span class="line"></span><br><span class="line">			String url = <span class="string">"http://127.0.0.1:"</span> + RunningConfig.getServerPort() + RunningConfig.getContextPath() + UtilsAndCommons.NACOS_NAMING_CONTEXT + <span class="string">"/instance?"</span> + request.toUrl();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 开启一个异步的 Http 请求任务进行删除实例数据</span></span><br><span class="line">			HttpClient.asyncHttpDelete(url, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">new</span> AsyncCompletionHandler() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">onCompleted</span><span class="params">(Response response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">					<span class="keyword">if</span> (response.getStatusCode() != HttpURLConnection.HTTP_OK) &#123;</span><br><span class="line">						Loggers.SRV_LOG.error(<span class="string">"[IP-DEAD] failed to delete ip automatically, ip: &#123;&#125;, caused &#123;&#125;, resp code: &#123;&#125;"</span>, instance.toJSON(), response.getResponseBody(), response.getStatusCode());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			Loggers.SRV_LOG.error(<span class="string">"[IP-DEAD] failed to delete ip automatically, ip: &#123;&#125;, error: &#123;&#125;"</span>, instance.toJSON(), e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liaochuntao</p>
  <div class="site-description" itemprop="description">励志成为一位大佬</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liaochuntao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":150,"height":300,"position":"left","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>
